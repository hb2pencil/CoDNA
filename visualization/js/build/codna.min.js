//     CoDNA 0.1.0
//     (c) 2013 Henry Brausen, David Turner
//     https://github.com/hb2pencil/CoDNA
//     Released under GPLv2 License
!function(a,b,d){Article=Backbone.Model.extend({initialize:function(){},urlRoot:"",defaults:{title:"",rev_count:0,set:1,display:!0}}),ArticleCollection=Backbone.Collection.extend({model:Article,url:function(){return"dbquery.php?list"}}),ArticleSet=Backbone.Model.extend({initialize:function(){},urlRoot:"",defaults:{id:null,name:"",url:"",count:0}}),ArticleSetCollection=Backbone.Collection.extend({model:ArticleSet,url:"dbquery.php?listArticleSets"}),TopTab=Backbone.Model.extend({initialize:function(){this.on("change:selected",function(){topTabs.getSelected()==this?$("#content").html(this.content):this.content=this.get("mainView").$el.detach(),$(".ui-dialog-content").dialog("close")},this),this.get("mainView").render()},defaults:{type:"tab",color:"#CFECAD",hoverColor:"#BDD99E",title:"",selected:!1,x:Number.MAX_VALUE/2,mainView:null}}),NewTopTab=TopTab.extend({initialize:function(){},defaults:{type:"new",color:"#EEEEEE",hoverColor:"#DDDDDD",title:"<b>&#10133;</b>",selected:!1,x:Number.MAX_VALUE,mainView:null}}),TopTabCollection=Backbone.Collection.extend({comparator:function(a){return"new"==a.get("type")?Number.MAX_VALUE:a.get("x")},getSelected:function(){return this.findWhere({selected:!0})},model:TopTab}),User=Backbone.Model.extend({initialize:function(){},urlRoot:function(){return"dbquery.php?users&id="+this.get("id")},defaults:{id:0,name:"",histid:"",flagged:0,edits:0,created:"",display:!0}}),UserCollection=Backbone.Collection.extend({model:User,url:"dbquery.php?users"}),UserSet=Backbone.Model.extend({initialize:function(){},urlRoot:"",defaults:{id:null,name:"",url:"",count:0}}),UserSetCollection=Backbone.Collection.extend({model:UserSet,url:"dbquery.php?listUserSets"}),WikiViz=Backbone.Model.extend({initialize:function(){var a=null;""!=this.get("user")?a=new WikiVizData({user:this.get("user"),wikiviz:this}):""!=this.get("title")&&(a=new WikiVizData({title:this.get("title"),wikiviz:this})),this.set("weights",{add:60,remove:60,edit:20,reorganize:40,vand:10,unvand:10,cite:20,unclassified:60}),this.set("view",{}),a.fetch(),this.set("data",a),this.on("change:numDots",function(){this.set("numDots",Math.max(1,this.get("numDots")))}),this.on("change:numBars",function(){this.set("numBars",Math.max(1,this.get("numBars")))})},getGroupsByName:function(a){var b=this.get("data").get("users");return b.hasOwnProperty(a)?b[a].history[b[a].history.length-1]?b[a].history[b[a].history.length-1].userclass:["None"]:["None"]},index:function(a){return a.id},tIndex:function(a){return a.id},getRevisionGroup:function(a){var b=this.get("data").get("users");if(!a.user in b)return"Anon";var c=b[a.user];if(!c)return"Anon";if(c.flagged)return c.history[c.history.length-1].userclass;if(c.history.length<1)return"Anon";for(var d=new Date(a.timestamp),e=1,f=c.history[0];e<c.history.length&&!(new Date(c.history[e].timestamp)>d);)f=c.history[e],++e;return f.userclass},timeX:d3.time.scale(),defaults:{title:"",user:"",data:null,width:910,height:500,numBars:60,maskWidth:50,timeMultiplier:1,isTimeSpaced:!1,weights:null,mode:"art",view:null}}),WikiVizData=Backbone.Model.extend({initialize:function(){this.on("sync",this.augment,this)},augment:function(){function a(a,b){return-1!=b.indexOf(a)}$.each(this.get("talk"),$.proxy(function(a,b){b.date=new Date(b.timestamp),b.loglev=Math.log(b.lev+1),b.user=b.contributor,b.type="talk",b.id=a,b.group=this.get("wikiviz").getRevisionGroup(b)},this)),$.each(this.get("revisions"),$.proxy(function(b,d){var e={add:0,remove:0,edit:0,reorganize:0,cite:0,vand:0,unvand:0,unsure:0,unclassified:0};a("a",d["class"])&&(e.edit+=this.get("wikiviz").get("weights").edit),a("b",d["class"])&&(e.add+=this.get("wikiviz").get("weights").add),a("c",d["class"])&&(e.remove+=this.get("wikiviz").get("weights").remove),a("d",d["class"])&&(e.reorganize+=this.get("wikiviz").get("weights").reorganize),a("e",d["class"])&&(e.cite+=this.get("wikiviz").get("weights").cite),a("f",d["class"])&&(e.vand+=this.get("wikiviz").get("weights").vand),a("g",d["class"])&&(e.unvand+=this.get("wikiviz").get("weights").unvand),a("x",d["class"])&&(e.unclassified+=this.get("wikiviz").get("weights").unclassified);var f=0;for(c in e)f+=e[c];if(0!=f)for(c in e)e[c]=e[c]*Math.log(+d.lev+1)/f;0===f&&(e.unsure=Math.log(d.lev+1)),d.revid=d.rev_id,d.wclass=e,d.loglev=Math.log(+d.lev+1),d.date=new Date(d.timestamp),d.group=this.get("wikiviz").getRevisionGroup(d),d.type="art",d.id=b},this))},urlRoot:function(){return""!=this.get("title")?"dbquery.php?lower=0&upper=10000&article="+encodeURIComponent(this.get("title")):""!=this.get("user")?"dbquery.php?user="+encodeURIComponent(this.get("user")):void 0},defaults:{title:"",user:"",wikiviz:null,users:[],revisions:[],quality:[],events:[]}}),ArticleInfoView=Backbone.View.extend({initialize:function(a){this.article=a.article,this.listenTo(this.model,"sync",this.render),this.listenTo(this.model.get("data"),"sync",this.render),this.template=_.template($("#article_info_template").html())},render:function(){return this.$el.html(this.template(_.extend(this.article.toJSON(),this.model.toJSON()))),this.$el.attr("id","article_info"),this.$el}}),ArticleView=Backbone.View.extend({template:_.template($("#article_container_template").html()),wikiviz:null,navctl:null,initialize:function(){this.wikiviz=new WikiViz({title:this.model.get("title")});var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0],Backbone.Subviews.add(this)},subviewCreators:{article_info:function(){return new ArticleInfoView({model:this.wikiviz,article:this.model})},toolbar:function(){return new ToolbarView({model:{buttons:["select","sections","data","legend","deselect","talk"]},view:this})}},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.viz=new WikiVizView({model:this.wikiviz,view:this,el:this.el}),this.viz.init(this.model.get("title")),this.$el}}),DialogView=Backbone.View.extend({dialog:null,options:null,onCreate:function(){},firstRender:!0,initialize:function(a){this.template=_.template($("#"+a.template).html()),this.options=a.options,_.isFunction(a.onCreate)&&(this.onCreate=a.onCreate)},open:function(){this.dialog.dialog("open")},close:function(){this.dialog.dialog("close")},render:function(){return this.firstRender&&(this.$el.html(this.template()),this.dialog=this.$el.children().dialog(this.options),this.onCreate(this.dialog)),this.firstRender=!1,this.$el}}),NavCtlView=Backbone.View.extend({article:null,initialize:function(b){this.viz=b.viz,this.listenTo(this.viz.model,"change:mode",this.changeMode),$(a).resize($.proxy(function(){this.viz.$("#navctl").width()>0&&this.init(this.viz.$("#navctl").width(),this.dim.h)},this))},toTimeSpaced:function(){var a=_.first(this.viz.model.get("data").get("revisions")).date;this.xscale=d3.time.scale(),this.xscale.domain([new Date(a.getFullYear(),a.getMonth()),_.last(this.viz.model.get("data").get("revisions")).date]),this.xscale.rangeRound([0,this.dim.w-2*this.handleWidth]);var b=this;this.bg.select("g.navbars").selectAll("rect.sd").data(this.viz.model.get("data").get("revisions")).attr("x",function(a){return b.xscale(a.date)}).attr("y",function(a){return-b.yscale(a.wclass.remove+a.wclass.vand)}).attr("width",function(){return b.spikewidth}).attr("height",function(a){return b.yscale(a.loglev-(a.wclass.remove+a.wclass.vand))+b.yscale(a.wclass.remove+a.wclass.vand)}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle.tcircle").data(this.viz.model.get("data").get("talk")).attr("cx",function(a){return b.xscale(a.date)}),this.onSlide(),this.onScale()},toAdjacentSpaced:function(){this.xscale=d3.scale.linear(),"talk"==this.viz.model.get("mode")?this.xscale.domain([0,this.viz.model.get("data").get("talk").length-1]):this.xscale.domain([0,this.viz.model.get("data").get("revisions").length-1]),this.xscale.rangeRound([0,this.dim.w-2*this.handleWidth]);var a=this;this.bg.select("g.navbars").selectAll("rect.sd").data(this.viz.model.get("data").get("revisions")).attr("x",function(b,c){return a.xscale(c)}).attr("y",function(b){return-a.yscale(b.wclass.remove+b.wclass.vand)}).attr("width",function(){return a.spikewidth}).attr("height",function(b){return a.yscale(b.loglev-(b.wclass.remove+b.wclass.vand))+a.yscale(b.wclass.remove+b.wclass.vand)}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle").data(this.viz.model.get("data").get("talk")).attr("cx",function(b,c){return a.xscale(c)}),this.onSlide(),this.onScale()},changeMode:function(){"art"==this.viz.model.get("mode")?(this.bg.select("g.navbars").selectAll(".sd").attr("opacity",1),this.bg.select("g.navbars").selectAll("circle.tcircle").attr("opacity",0)):"talk"==this.viz.model.get("mode")?(this.bg.select("g.navbars").selectAll(".sd").attr("opacity",0),this.bg.select("g.navbars").selectAll(".tcircle").attr("opacity",1)):"hybrid"==this.viz.model.get("mode")&&(this.bg.select("g.navbars").selectAll(".sd").attr("opacity",1),this.bg.select("g.navbars").selectAll(".tcircle").attr("opacity",1)),this.onScale()},onSlide:function(){d3.select(this.viz.$("g.body")[0]).attr("transform","translate("+-Math.round(this.getPanOffset())+",0)"),this.viz.repositionBar()},onScale:function(){if(this.viz.model.get("isTimeSpaced")||"art"!=this.viz.model.get("mode"))if(this.viz.model.get("isTimeSpaced")||"talk"!=this.viz.model.get("mode")){if(this.viz.model.get("isTimeSpaced")){var a=_.last(this.viz.model.get("data").get("revisions")).date,b=_.first(this.viz.model.get("data").get("revisions")).date,c=this.xscale.invert(this.sdim.x0),d=this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth);this.viz.model.timeX.rangeRound([0,.9*this.viz.model.get("width")*(a-b)/(d-c)]),this.viz.toTimeSpaced()}}else this.viz.model.set("numDots",this.getNumBars());else this.viz.model.set("numBars",this.getNumBars())},getPanOffset:function(){try{if(!this.viz.model.get("isTimeSpaced")&&"art"==this.viz.model.get("mode"))return this.sdim.x0/(this.dim.w-2*this.handleWidth)*this.viz.model.get("data").get("revisions").length*this.viz.calcBarWidth();if(!this.viz.model.get("isTimeSpaced")&&"talk"==this.viz.model.get("mode"))return this.sdim.x0/(this.dim.w-2*this.handleWidth)*this.viz.model.get("data").get("talk").length*this.viz.calcTalkWidth();if(this.viz.model.get("isTimeSpaced"))return this.viz.model.timeX(this.xscale.invert(this.sdim.x0))}catch(a){}return 0},getNumBars:function(){return this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth)-this.xscale.invert(this.sdim.x0)},getTimeRange:function(){},init:function(a,c){this.viz.$("#navctl").empty(),this.dim={w:a,h:c},this.sdim={x0:0,w:100},this.svg=d3.select(this.viz.$("#navctl")[0]).append("svg").attr("width",this.dim.w).attr("height",this.dim.h),this.svg.attr("viewBox","0 0 "+a+" "+c),this.bg=this.svg.append("g").attr("class","bg");var d=this.dim.h/2;this.bg.append("path").attr("d","M"+d+",0 A"+d+","+d+" 0 0,0 "+d+","+2*d).attr("class","pad").attr("width",d).attr("height",this.dim.h),this.bg.append("path").attr("d","M0,0 A"+d+","+d+" 0 0,1 0,"+2*d).attr("class","pad").attr("width",d).attr("height",this.dim.h).attr("transform","translate("+(this.dim.w-d)+",0)"),this.bg.append("g").attr("class","navbars").attr("x",d).attr("transform","translate("+d+","+this.dim.h/2+")scale(1,-1)"),this.bg.select("g.navbars").append("line").attr("x1",0).attr("y1",0).attr("x2",this.dim.w-2*d).attr("y2",0),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",d).attr("x2",this.dim.w-2*d).attr("y2",d),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",-d).attr("x2",this.dim.w-2*d).attr("y2",-d),this.slider=this.svg.append("g").attr("class","slider"),this.slider.append("rect").attr("class","chandle").attr("width",this.sdim.w-d).attr("height",this.dim.h).attr("x",this.sdim.x0+d),this.slider.append("g").attr("class","lhandlegrp").attr("transform","translate("+this.sdim.x0+",0)").append("path").attr("d","M"+d+",0 A"+d+","+d+" 0 0,0 "+d+","+2*d).attr("class","lhandle").attr("width",d).attr("height",this.dim.h),this.slider.append("g").attr("class","rhandlegrp").attr("transform","translate("+(this.sdim.x0+this.sdim.w)+",0)").append("path").attr("d","M0,0 A"+d+","+d+" 0 0,1 0,"+2*d).attr("class","rhandle").attr("width",d).attr("height",this.dim.h),this.xscale=d3.scale.linear(),this.xscale.domain([0,this.viz.model.get("data").get("revisions").length-1]),this.xscale.rangeRound([0,this.dim.w-2*d]),this.yscale=d3.scale.linear(),this.yscale.domain(this.viz.model.get("view").y.domain()),this.yscale.rangeRound([0,this.dim.h/2]);var e=this;this.spikewidth=(this.dim.w-2*d)/this.viz.model.get("data").get("revisions").length,this.spikes=this.bg.select("g.navbars").selectAll("rect.sd").data(this.viz.model.get("data").get("revisions")),this.spikes.enter().append("rect").attr("x",function(a,b){return e.xscale(b)}).attr("y",function(a){return-e.yscale(a.wclass.remove+a.wclass.vand)}).attr("width",function(){return e.spikewidth}).attr("height",function(a){return e.yscale(a.loglev-(a.wclass.remove+a.wclass.vand))+e.yscale(a.wclass.remove+a.wclass.vand)}).attr("class","sd"),this.dots=this.bg.select("g.navbars").selectAll("circle.td").data(this.viz.model.get("data").get("talk")).enter().append("circle").attr("class","td");var f=5,g=.6;this.dots.filter(function(a){return Math.log(a.lev+1)*g<=f}).attr("r",function(a){return Math.log(a.lev+1)*g}).attr("class","tcircle"),this.dots.filter(function(a){return Math.log(a.lev+1)*g>f}).attr("r",f).attr("class","tcircle_full"),this.sd={dx:0},this.viz.$(".chandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),this.viz.$(".lhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),this.viz.$(".rhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX,a.preventDefault()}),$(b).mousemove($.proxy(function(a){if(this.viz.$(".rhandle").hasClass("dragging")){var b=a.pageX-this.sd.dx;this.sd.dx=a.pageX;var c=+this.sdim.w+b;d>c&&(c=d),c+this.sdim.x0+d>this.dim.w&&(c=this.dim.w-this.sdim.x0-d),this.sdim.w=c,this.viz.$(".chandle").attr("width",this.sdim.w-d),this.viz.$(".rhandlegrp").attr("transform","translate("+ +this.sdim.w+",0)"),this.onScale(),this.onSlide()}if(this.viz.$(".lhandle").hasClass("dragging")){var e=a.pageX-this.sd.dx;0>e&&(e=0),e>this.sdim.x0+this.sdim.w-d&&(e=this.sdim.x0+this.sdim.w-d);var c=+this.sdim.w-(+e-+this.sdim.x0);d>c&&(c=d),this.sdim.x0=e,this.sdim.w=c,this.viz.$(".slider").attr("transform","translate("+this.sdim.x0+",0)"),this.viz.$(".chandle").attr("width",this.sdim.w-d),this.viz.$(".rhandlegrp").attr("transform","translate("+ +this.sdim.w+",0)"),this.onScale(),this.onSlide()}this.viz.$(".chandle").hasClass("dragging")&&(this.sdim.x0=a.pageX-this.sd.dx,this.sdim.x0<0&&(this.sdim.x0=0),this.sdim.x0>this.dim.w-(d+this.sdim.w)&&(this.sdim.x0=this.dim.w-(d+this.sdim.w)),this.viz.$(".slider").attr("transform","translate("+this.sdim.x0+",0)"),this.onSlide())},this)),$(b).mouseup($.proxy(function(){this.viz.$(".chandle").removeClass("dragging"),this.viz.$(".lhandle").removeClass("dragging"),this.viz.$(".rhandle").removeClass("dragging")},this)),this.handleWidth=d,this.onSlide(),this.onScale(),this.changeMode()}}),NewArticleView=Backbone.View.extend({template:_.template($("#new_article_template").html()),views:new Array,initialize:function(){this.articleSets=new ArticleSetCollection,this.userSets=new UserSetCollection,this.users=new UserCollection,this.articles=new ArticleCollection,$.when(this.users.fetch(),this.articles.fetch(),this.articleSets.fetch(),this.userSets.fetch()).then($.proxy(function(){this.render()},this));var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0]},events:{"click #initiative .option:not(.disabled)":"clickInitiative","click #set .option":"clickDataSet","click #project .option":"clickProject","click #analyse button":"clickAnalyse","click #clearFilter":"clearFilter","change #filter":"filter","keyup #filter":"filter"},getSelected:function(){var a=null;return _.each(this.views,function(b){b.$el.hasClass("selected")&&(a=b.model)}),a},clearFilter:function(){this.$("#filter").attr("value",""),this.filter()},clickInitiative:function(a){this.$("#initiative .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),"none"==this.$("#set").css("display")&&this.$("#initiative .option.selected").length>0?(this.renderDataSets(),this.$("#set").show("slide",400)):"none"!=this.$("#set").css("display")&&0==this.$("#initiative .option.selected").length&&(this.$("#set").hide("slide",400),"none"!=this.$("#project").css("display")&&(this.$("#project").hide("slide",400),"none"!=this.$("#analyse").css("display")&&this.$("#analyse").hide("slide",400)))},clickDataSet:function(a){if(this.$("#set .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),this.$("#set .option.selected").length>0){var b=this.$("#set .option.selected span");b.parent().hasClass("article")?this.renderProjects(this.articles.where({set:parseInt(b.attr("name"))})):b.parent().hasClass("contributor")&&this.renderProjects(this.users.where({set:parseInt(b.attr("name"))})),"none"==this.$("#project").css("display")&&this.$("#project").show("slide",400)}else"none"!=this.$("#project").css("display")&&0==this.$("#set .option.selected").length&&(this.$("#project").hide("slide",400),"none"!=this.$("#analyse").css("display")&&this.$("#analyse").hide("slide",400))},clickProject:function(a){this.$("#project .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),"none"==this.$("#analyse").css("display")&&this.$("#project .option.selected").length>0?this.$("#analyse").show("slide",400):"none"!=this.$("#analyse").css("display")&&0==this.$("#project .option.selected").length&&this.$("#analyse").hide("slide",400)},clickAnalyse:function(){var a=this.getSelected(),b=null,c="",d="",e="";if(a instanceof Article)b=new ArticleView({model:a}),c=a.get("title"),d="#ABD1EB",e="#9EC0D9";else{if(!(a instanceof User))return;b=new UserView({model:a}),c=a.get("name"),d="#EEADAD",e="#EE9898"}topTabs.getSelected().set({title:c,mainView:b,color:d,hoverColor:e}),b.render(),topTabsView.render(),this.remove()},renderInitiatives:function(){0==_.size(this.articles.toJSON())&&this.$("#initiative .select").html($("#big_throbber_template").html()),this.$("#initiative").tabs()},renderDataSets:function(){var a=b.createDocumentFragment(),c=b.createDocumentFragment();_.each(this.views,function(a){a instanceof DataSetView&&a.remove()}),this.views=new Array,_.each(this.articleSets.models,function(b){var c=new DataSetView({model:b});this.views.push(c),a.appendChild(c.render()[0])},this),_.each(this.userSets.models,function(a){var b=new DataSetView({model:a});this.views.push(b),c.appendChild(b.render()[0])},this),this.$("#set #tabs-project .select").html(a),this.$("#set #tabs-contributor .select").html(c),this.$("#set").tabs()},renderProjects:function(a){var c=b.createDocumentFragment();b.createDocumentFragment(),_.each(this.views,function(a){a instanceof ProjectView&&a.remove()}),this.views=new Array,_.each(a,function(a){var b=new ProjectView({model:a});this.views.push(b),c.appendChild(b.render()[0])},this),this.$("#project #tabs-item .select").html(c),this.$("#project").tabs()},filter:function(){var a=this.$("#filter").val().toLowerCase();_.each(this.articles.models,function(b){-1!=b.get("title").toLowerCase().indexOf(a)?b.set("display",!0):b.set("display",!1)}),_.each(this.users.models,function(b){-1!=b.get("name").toLowerCase().indexOf(a)?b.set("display",!0):b.set("display",!1)})},render:function(){return this.$el.html(this.template({count:_.size(this.articles.toJSON())})),this.renderInitiatives(),this.$el}}),DataSetView=Backbone.View.extend({template:_.template($("#dataset_option_template").html()),initialize:function(){this.listenTo(this.model,"change",this.render),this.$el.addClass("option"),this.model instanceof UserSet?this.$el.addClass("contributor"):this.model instanceof ArticleSet&&this.$el.addClass("article")},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el}}),ProjectView=Backbone.View.extend({article_template:_.template($("#article_option_template").html()),user_template:_.template($("#user_option_template").html()),initialize:function(){this.model instanceof Article?this.template=this.article_template:this.model instanceof User&&(this.template=this.user_template),this.listenTo(this.model,"change",this.render),this.$el.addClass("option")},render:function(){return this.model.get("display")?(this.$el.css("display","block"),this.$el.html(this.template(this.model.toJSON()))):this.$el.css("display","none"),this.$el}}),ToolbarView=Backbone.View.extend({initialize:function(a){this.template=_.template($("#toolbar_template").html()),Backbone.Subviews.add(this),this.view=a.view},subviewCreators:{diag_cursor:function(){return new DialogView({template:"diag_cursor_template",options:{autoOpen:!1,width:"auto",resizable:!1}})},diag_options:function(){return new DialogView({template:"diag_options_template",options:{autoOpen:!1,resizable:!1}})},diag_select:function(){var a=this.view.wikiviz,b=this.view;return new DialogView({template:"diag_select_template",options:{autoOpen:!1,width:400,resizable:!1},onCreate:function(c){$("#select_apply",c).button(),$("#d_select_tabs",c).tabs(),$("#d_select_groups_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$("#d_select_groups_accordion h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_select_groups_accordion h3",c).each(function(b,d){$(d).find("input").change(function(){var b=$(this);$(this).attr("checked")?a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",1):a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",.2),$("#t_deselect",c).button("enable")})}),$("input[name=userclassselect]",c).each(function(b,d){$(d).change(function(){var b=Array();$("input[name=userclassselect]:checked",c).each(function(a,c){b.push($(c).val())}),$("#userselect option",c).each(function(c,d){Helper.isSubset([a.getGroupsByName($(d).val())],b)?$(d).attr("selected",!0):$(d).attr("selected",!1),$(d).addClass("invisible"),$(d).removeClass("invisible")})})}),$("#select_apply",c).click(function(){var a=Array();$("#userselect option:selected",c).each(function(){a.push($(this).val())}),b.viz.applyUserSelection(a)})}})},diag_articles:function(){var a=this.view.wikiviz,b=this.view;return new DialogView({template:"diag_articles_template",options:{autoOpen:!1,width:400,resizable:!1},onCreate:function(c){$("#select_apply",c).button(),$("#d_select_tabs",c).tabs(),$("#d_select_groups_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$("#d_select_groups_accordion h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_select_groups_accordion h3",c).each(function(b,d){$(d).find("input").change(function(){var b=$(this);$(this).attr("checked")?a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",1):a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",.2),$("#t_deselect",c).button("enable")})}),$("input[name=userclassselect]",c).each(function(b,d){$(d).change(function(){var b=Array();$("input[name=userclassselect]:checked",c).each(function(a,c){b.push($(c).val())}),$("#userselect option",c).each(function(c,d){Helper.isSubset([a.getGroupsByName($(d).val())],b)?$(d).attr("selected",!0):$(d).attr("selected",!1),$(d).addClass("invisible"),$(d).removeClass("invisible")})})}),$("#select_apply",c).click(function(){var a=Array();$("#userselect option:selected",c).each(function(){a.push($(this).val())}),b.viz.applyUserSelection(a)})}})},diag_sections:function(){return new DialogView({template:"diag_sections_template",options:{autoOpen:!1,width:400,resizable:!1}})},diag_info:function(){return new DialogView({template:"diag_info_template",options:{autoOpen:!1,resizable:!1,width:400}})},diag_data:function(){return new DialogView({template:"diag_data_template",options:{autoOpen:!1,resizable:!0,width:800,height:600}})},diag_legend:function(){var a=this.view.wikiviz,b=this.view;return new DialogView({template:"diag_legend_template",options:{autoOpen:!1,resizable:!1,height:"auto",width:400},onCreate:function(c){$("#d_legend_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$(".d_checkable h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})});var d={addrem:["add","remove"],edit:["edit"],reorganize:["reorganize"],cite:["cite"],unsure:["unsure"],vandunvand:["vand","unvand"]};$("#d_legend_accordion h3",c).each(function(e,f){$(f).find("input").change(function(){if($(this).attr("checked"))for(var e in d[$(this).val()])a.get("view").data.selectAll("rect."+d[$(this).val()][e]).transition().duration(500).attr("opacity",1);else for(var e in d[$(this).val()])a.get("view").data.selectAll("rect."+d[$(this).val()][e]).transition().duration(500).attr("opacity",.2);var f=new Array;$("#d_legend_accordion input:checked",c).each(function(a,b){$.merge(f,d[$(b).val()])}),b.viz.navctl.bg.selectAll("rect").transition().duration(500).attr("opacity",function(a){var b=.2;return $(f).each(function(c,d){return a.wclass[d]?(b=1,1):void 0}),b}),$("#t_deselect",c).button("enable")})})}})},diag_talk:function(){return new DialogView({template:"diag_talk_template",options:{autoOpen:!1,resizable:!1,height:"auto",width:400},onCreate:function(a){$("#d_talk_accordion",a).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$(".d_checkable h3",a).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_talk_accordion h3",a).each(function(b,c){$(c).find("input").change(function(){var b=$(this);$(this).attr("checked")?d3.selectAll(".tdatum ."+b.val()).transition().duration(500).attr("opacity",1):d3.selectAll(".tdatum ."+b.val()).transition().duration(500).attr("opacity",.2),$("#t_deselect",a).button("enable")})})}})}},createToolbar:function(){$("#t_cursor").button({icons:{primary:"ui-icon-arrow-1-ne"},text:!1}),$("#t_options").button({icons:{primary:"ui-icon-gear"},text:!1}),this.$("#t_select").button({icons:{primary:"icon-users"},text:!1}),this.$("#t_articles").button({icons:{primary:"icon-articles"},text:!1}),this.$("#t_sections").button({icons:{primary:"icon-sections"},text:!1}),$("#t_info").button({icons:{primary:"ui-icon-info"},text:!1}),this.$("#t_data").button({icons:{primary:"icon-table"},text:!1}),this.$("#t_legend").button({icons:{primary:"icon-categories"},text:!1}),this.$("#t_deselect").button({icons:{primary:"icon-deselect"},text:!1,disabled:!0}),this.$("#t_talk").button({icons:{primary:"icon-talk"},text:!1,disabled:!0})},events:{"click #t_cursor":function(){this.subviews.diag_cursor.open()},"click #t_options":function(){this.subviews.diag_options.open()},"click #t_select":function(){this.subviews.diag_select.open()},"click #t_articles":function(){this.subviews.diag_articles.open()},"click #t_sections":function(){this.subviews.diag_sections.open()},"click #t_info":function(){this.subviews.diag_info.open()},"click #t_data":function(){this.subviews.diag_data.open()},"click #t_legend":function(){this.subviews.diag_legend.open()},"click #t_deselect":function(){this.view.viz.clearAllSelections(!0)},"click #t_talk":function(){this.subviews.diag_talk.open()}},render:function(){return this.$el.html(this.template(this.model)),this.createToolbar(),this.$el}}),TopTabsView=Backbone.View.extend({views:new Array,initialize:function(){this.listenTo(this.model,"add",this.render),this.listenTo(this.model,"remove",this.render),$(a).resize($.proxy(this.render,this))},order:function(){this.model.sort();var a=TopTabsView.leftMargin,b=($("#content").outerWidth()-30-30-TopTabsView.spacing)/(this.model.length-1)-25-10-TopTabsView.spacing,c=0,d=0;this.model.each(function(e,f){var g=e.get("x");if(e.set("x",a,{silent:!0}),"new"!=e.get("type")){c+=b+25+10+5,d+=Math.max(5,Math.min(150,Math.round(b)))+25+10+5;var h=c-d;d+=h,this.$("#tab_"+e.cid).css("max-width",Math.max(5,Math.min(150,Math.round(b)+h)))}a+=Math.round(this.$("#tab_"+e.cid).outerWidth())+TopTabsView.spacing,g!=e.get("x")&&this.views[f].updatePosition()},this)},render:function(){return _.each(this.views,function(a){a.remove()}),this.views=new Array,this.$el.empty(),this.model.each(function(a){var b=new TopTabView({model:a});this.$el.append(b.render()),"tab"==a.get("type")&&b.$el.draggable({axis:"x",start:$.proxy(function(){b.$el.css("z-index",1e3)},this),drag:$.proxy(function(){a.set("x",parseInt(b.$el.css("left")),{silent:!0}),this.order()},this),stop:$.proxy(function(){b.$el.css("z-index",0),this.order(),this.render()},this)}),this.views.push(b)},this),this.order(),this.$el}}),TopTabsView.leftMargin=15,TopTabsView.spacing=5,TopTabView=Backbone.View.extend({template:_.template($("#top_tab_template").html()),initialize:function(){this.listenTo(this.model,"change",this.render)},events:{mouseover:"hover",mouseout:"unhover","click .x":"close",click:"click"},hover:function(){this.model.get("selected")&&this.$el.css("border-bottom","1px solid #FFFFFF"),this.$el.css("background-color",this.model.get("hoverColor"))},unhover:function(){this.model.get("selected")?this.$el.css("border-bottom","1px solid #FFFFFF"):this.$el.css("border-bottom","1px solid #AAAAAA"),this.$el.css("background-color",this.model.get("color"))},click:function(a){if("new"==this.model.get("type")){var b=new TopTab({title:"New Tab",mainView:new NewArticleView({model:articles})}),c=_.last(topTabsView.views).model.get("x");topTabs.add(b),topTabsView.order();var d=topTabs.getSelected();null!=d&&d!=this.model&&d.set("selected",!1),b.set("selected",!0),$("#tab_"+b.cid).css("display","none"),$("#tab_"+b.cid).show("slide",200),_.last(topTabsView.views).$el.css("left",c),_.last(topTabsView.views).$el.animate({left:b.get("x")+$("#tab_"+b.cid).outerWidth()+TopTabsView.spacing},200)}else if(!$(a.target).hasClass("x")){var d=topTabs.getSelected();null!=d&&d!=this.model&&d.set("selected",!1),this.model.get("selected")||this.model.set("selected",!0)}},close:function(){var a=!1;_.each(topTabsView.views,function(b){a&&b.$el.animate({left:b.model.get("x")-this.$el.outerWidth()-TopTabsView.spacing},200),b==this&&(a=!0)},this),this.model.set("selected",!1),this.model.get("mainView").remove(),this.$el.hide("slide",200,$.proxy(function(){topTabs.remove(this.model),topTabs.at(topTabs.length-2)&&topTabs.at(topTabs.length-2).set("selected",!0)},this))},updatePosition:function(){this.$el.css("left",this.model.get("x"))},render:function(){return this.$el.html(this.template(this.model.toJSON())),"new"==this.model.get("type")&&this.$el.addClass("tab_new"),this.$el.addClass("tab"),this.$el.stop(),this.updatePosition(),this.$el.attr("id","tab_"+this.model.cid),this.model.get("selected")?(this.$el.addClass("selected"),this.$el.css("border-bottom","1px solid #FFFFFF")):(this.$el.removeClass("selected"),this.$el.css("border-bottom","1px solid #AAAAAA")),this.$el.css("background-color",this.model.get("color")),this.$el}}),UserInfoView=Backbone.View.extend({initialize:function(a){this.user=a.user,this.listenTo(this.model,"sync",this.render),this.listenTo(this.model.get("data"),"sync",this.render),this.template=_.template($("#user_info_template").html())},render:function(){return this.$el.html(this.template(_.extend(this.user.toJSON(),this.model.toJSON()))),this.$el.attr("id","article_info"),this.$el}}),UserView=Backbone.View.extend({template:_.template($("#user_container_template").html()),wikiviz:null,navctl:null,initialize:function(){this.wikiviz=new WikiViz({user:this.model.get("name")});
var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0],Backbone.Subviews.add(this)},subviewCreators:{user_info:function(){return new UserInfoView({model:this.wikiviz,user:this.model})},toolbar:function(){return new ToolbarView({model:{buttons:["articles","data","legend","deselect","talk"]},view:this})}},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.viz=new WikiVizView({model:this.wikiviz,view:this,el:this.el}),this.viz.init(this.model.get("title")),this.$el}}),WikiVizView=Backbone.View.extend({mouseX:0,mouseY:0,initialize:function(b){this.listenTo(this.model.get("data"),"sync",this.initViz),this.navctl=new NavCtlView({viz:this}),this.view=b.view,this.listenTo(this.model,"change:width",this.initViz),this.listenTo(this.model,"change:height",this.initViz),this.listenTo(this.model,"change:numDots",this.updateDots),this.listenTo(this.model,"change:numBars",this.updateBars),this.listenTo(this.model,"change:mode",this.updateMode),this.listenTo(this.model,"change:isTimeSpaced",this.updateSpacing),this.$el.click($.proxy(function(a){0==$(a.target).closest(".tooltip").length&&this.$(".tooltip").hide()},this)),this.$("#view").mousemove($.proxy(function(a){this.mouseX=a.offsetX,this.mouseY=a.offsetY},this)),$(a).resize($.proxy(function(){this.$("#view").width()>0&&(this.model.set("width",this.$("#view").width()),this.model.set("height",this.$("#view").height()))},this))},calcBarWidth:function(){var a=(this.model.get("width")-this.model.get("maskWidth"))/this.model.get("numBars");return this.model.get("isTimeSpaced")&&(a=Math.min(a,7)),a},calcTalkWidth:function(){var a=(this.model.get("width")-this.model.get("maskWidth"))/this.model.get("numDots");return a},getAdjacentTalkWidth:function(){return 70*this.model.get("data").get("talk").length},getOffset:function(a){return this.model.get("isTimeSpaced")?this.model.get("data").get("revisions")[a].dateOffset:a*this.calcBarWidth()},getCalloutHeight:function(a){var b=0,c=29;return 0!==a.att&&(b+=c),0!==a.crit&&(b+=c),0!==a.inf&&(b+=c),0!==a.perf&&(b+=c),b},genCalloutImageSet:function(a){var b=[];return 0!==a.att&&b.push("att"),0!==a.crit&&b.push("crit"),0!==a.inf&&b.push("inf"),0!==a.perf&&b.push("perf"),b},updateInfo:function(a){this.$("#d_info_noselection").addClass("invisible"),this.$("#d_info_selection").empty();var b=0;this.$("#d_info_selection").append($("<table>"));for(p in a)a.hasOwnProperty(p)&&(++b,this.$("#d_info_selection table").append($("<tr>").append($("<td>").text(p)).append($("<td>").text(a[p].toString()))));0==b&&(this.$("#d_info_selection").empty(),this.$("#d_info_noselection").removeClass("invisible"))},clearMonths:function(){this.model.get("view").body.select(".bg").selectAll(".month").data([]).exit().remove()},updateDots:function(){this.model.get("view").tx.range([0,this.calcTalkWidth()]),this.model.get("isTimeSpaced")||this.model.get("view").tdata.selectAll(".tdatum").attr("transform",$.proxy(function(a,b){return"translate("+this.model.get("view").tx(b)+", 0)"},this)),this.buildMonths()},updateBars:function(){this.model.get("view").x.range([0,this.calcBarWidth()]),this.model.get("isTimeSpaced")||this.model.get("view").data.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.model.get("view").x(this.model.index(a))+", 0)"},this));var a=this;this.model.get("view").data.selectAll(".datum").selectAll(".bars rect").attr("width",this.calcBarWidth()),this.model.get("view").data.selectAll(".datum").select(".xlabel").filter(function(){return this.getBBox().width<=a.calcBarWidth()}).attr("opacity",1),this.model.get("view").data.selectAll(".datum").select(".xlabel").filter(function(){return this.getBBox().width>a.calcBarWidth()}).attr("opacity",0),this.buildMonths()},applyUserSelection:function(a){if(this.clearAllSelections(),!(a.length>0))return this.clearAllSelections(),void 0;this.$("#t_deselect").button("enable"),$("#diag_legend input").attr("disabled","disabled"),$("#d_select_groups_accordion input").attr("disabled","disabled");var b={};b["Number of Selected Users"]=a.length,b["User Groups"]=[];for(var c=0;c<a.length;++c)-1==jQuery.inArray(this.model.getGroupsByName(a[c]),b["User Groups"])&&b["User Groups"].push(this.model.getGroupsByName(a[c]));this.updateInfo(b),$("#diag_data table tbody").children("tr").each(function(b,c){$(c).removeClass("rowselect"),-1!=jQuery.inArray($(c).children(":eq(2)").text(),a)&&$(c).addClass("rowselect")}),this.model.get("view").data.selectAll(".datum").filter(function(b){return-1===jQuery.inArray(b.user,a)}).selectAll(".bars rect").transition().duration(500).attr("opacity",.2),this.navctl.spikes.filter(function(b){return-1===jQuery.inArray(b.user,a)}).transition().duration(500).attr("opacity",.4)},clearAllSelections:function(){this.$("#t_deselect").button("disable"),this.updateInfo({}),this.$("#diag_data table tbody tr").each(function(a,b){$(b).removeClass("rowselect")}),this.$("#d_legend_accordion input").attr("checked","checked"),$("#d_select_groups_accordion input").attr("checked","checked"),this.model.get("view").data.selectAll(".bars rect").transition().duration(500).attr("opacity",1),this.model.get("view").data.selectAll(".datum").transition().duration(500).attr("opacity",1),this.navctl.spikes.transition().duration(500).attr("opacity",1),this.$("#diag_legend input").removeAttr("disabled"),this.$("#d_select_groups_accordion input").removeAttr("disabled")},toTimeSpaced:function(){d3.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.model.timeX(a.date)+",0)"},this)).selectAll(".bars rect").attr("width",this.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",$.proxy(function(a){return"translate("+this.model.timeX(a.date)+",0)"},this)),this.buildMonths(),"talk"==this.model.get("mode")&&d3.selectAll(".month").attr("opacity",1)},toAdjacentSpaced:function(){"talk"==this.model.get("mode")&&d3.selectAll(".month").attr("opacity",0),d3.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.model.get("view").x(this.model.index(a))+",0)"},this)).selectAll(".bars rect").attr("width",this.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",$.proxy(function(a,b){return"translate("+this.model.get("view").tx(b)+",0)"},this)),this.buildMonths()},buildBars:function(a,b){for(var c=["add","unsure","reorganize","edit","cite","vand","unclassified"],d=["unvand","remove"],e=this.model.get("view").y,f=this.model.index,g=[],h=0;h<this.model.get("data").get("revisions").length;++h)g[h]=0;_.each(c,function(c){a.filter(function(a){return a.wclass[c]>1e-4}).append("rect").attr("y",function(a){return.8*e(g[f(a)])}).attr("width",b).attr("height",function(a){return.8*e(a.wclass[c])}).attr("class",c).attr("desc",f).attr("opacity",1);for(var d=0;d<this.model.get("data").get("revisions").length;++d)g[d]+=this.model.get("data").get("revisions")[d].wclass[c]},this);for(var h=0;h<this.model.get("data").get("revisions").length;++h)g[h]=0;_.each(d,function(c){a.filter(function(a){return a.wclass[c]>1e-4}).append("rect").attr("y",function(a){return.8*-e(a.wclass[c]+g[f(a)])}).attr("width",b).attr("height",function(a){return.8*e(a.wclass[c])}).attr("class",c).attr("desc",f).attr("opacity",1);for(var d=0;d<this.model.get("data").get("revisions").length;++d)g[d]+=this.model.get("data").get("revisions")[d].wclass[c]},this)},buildMonths:function(){this.calcBarWidth();var a=this.model.get("data").get("revisions"),b=Array(),c=Array(),e=10,f=[],g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(this.model.get("isTimeSpaced")){for(var h,i=!0,j=this.model.timeX,k=_.first(this.model.get("data").get("revisions")).date.getMonth(),l=_.first(this.model.get("data").get("revisions")).date.getFullYear();k<=_.last(this.model.get("data").get("revisions")).date.getMonth()||l<=_.last(this.model.get("data").get("revisions")).date.getFullYear();++k){k>11&&(k=0,++l),i&&(h=0==k?new Date(l-1,0,1):new Date(l,k-1,1),i=!1);var m=new Date(l,k,1);f.push({l:j(h),r:j(m),m:h.getMonth(),y:h.getFullYear()}),h=m}_.each(this.model.get("data").get("quality"),function(a){var c=new Date(a.cutoff);b.push({l:j(c),q:a})}),_.each(this.model.get("data").get("events"),function(a){var b=new Date(a.timestamp);c.push({l:j(b),e:a})})}else{var n,o=new Date(_.last(a).timestamp),p=new Date(_.first(a).timestamp),q=0;_.first(this.model.get("data").get("revisions"));for(var r=1;r<a.length;++r){if(n=new Date(a[r].timestamp),n.getMonth()!==p.getMonth()||n.getYear()!==p.getYear()){var s=this.getOffset(q),t=this.getOffset(r);if(s===t)continue;f.push({l:s,r:t,m:p.getMonth(),y:p.getFullYear()}),p=n,q=r}_.each(this.model.get("data").get("quality"),$.proxy(function(a,c){var e=new Date(a.cutoff);(n>=e||o.valueOf()==n.valueOf())&&b[c]==d&&(b[c]={l:this.getOffset(r),q:a})},this)),_.each(this.model.get("data").get("events"),$.proxy(function(a,b){var e=new Date(a.timestamp);n>=e&&c[b]==d&&(c[b]={l:this.getOffset(r),e:a})},this))}var s=this.getOffset(q),t=this.getOffset(a.length);f.push({l:s,r:t,m:p.getMonth(),y:p.getFullYear()})}var u=this.model.get("view").body.select(".bg"),v=u.selectAll(".month").data(f,function(a,b){return b}).enter(),w=v.append("g").attr("class","month").attr("transform",function(a){return"translate("+a.l+",0)"});w.append("rect").attr("height",String(this.model.get("height"))).attr("width",function(a){return a.r-a.l}).attr("class",function(a,b){return 0===b%2?"m_odd":"m_even"}).attr("y",String(-this.model.get("height")/2)),w.append("text").attr("class","mtext").text(function(a){return g[a.m]}).attr("transform",$.proxy(function(){return"translate(5,"+(this.model.get("height")/2-15)+")scale(1,-1)"},this)).attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<e}).attr("opacity",0),w.append("text").attr("class","ytext").text(function(a){return String(a.y)}).attr("transform",$.proxy(function(){return"translate(5,"+(this.model.get("height")/2-30)+")scale(1,-1)"},this)).attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<e}).attr("opacity",0),mts=this.model.get("view").body.selectAll(".month").data(f,function(a,b){return b});var x=mts;x.attr("transform",function(a){return"translate("+a.l+",0)"}),x.select("rect").attr("width",function(a){return a.r-a.l}),mts.select("text.mtext").text(function(a){return g[a.m]}),mts.select("text.ytext").text(function(a){return String(a.y)}),x.select("rect").attr("class",function(a,b){return 0===b%2?"m_odd":"m_even"}),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<e}).attr("opacity",0),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=e}).attr("opacity",1),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<e}).attr("opacity",0),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=e}).attr("opacity",1),u.selectAll(".bar").remove();var y=u.append("g").attr("class","bar");y.append("rect").attr("class","bar_bg").attr("width","100%").attr("height",35).attr("fill","#F2E4CB"),this.repositionBar();var z=8;_.each(b,$.proxy(function(a){var b="<table>";_.each(a.q.description,function(a,c){b+="<tr><td align='right'>"+c+":&nbsp;</td><td>"+a+"</td></tr>"}),"CoDNA"==a.q.metric&&(b+="<tr><td colspan='2'><a style='float:right;' href='http://dl.acm.org/citation.cfm?id=2069609' target='_blank'>Source</a></td></tr>"),b+="</table>";var c=$(_.template($("#tooltip_template").html(),{title:a.q.metric+" Ranking",text:b}));this.$("#view").append(c),y.append("circle").attr("r",z).attr("transform","translate("+a.l+",-"+(this.model.get("height")/2-2*z)+")").attr("fill","#2C5C7D"),$(".bar circle").last().click($.proxy(function(){_.defer($.proxy(function(){$(".tooltip").not(c).fadeOut(),c.fadeToggle();var a=$(c[1]).outerHeight(),b=$(c[1]).outerWidth();c.css("left",this.mouseX-b/2).css("top",this.mouseY-2*z-a)},this))},this))},this)),_.each(c,$.proxy(function(a){var b=$(_.template($("#tooltip_template").html(),{title:a.e.title,text:a.e.description+"<br />Date:&nbsp;"+Helper.formatDate(new Date(a.e.timestamp),!1)}));this.$("#view").append(b),y.append("circle").attr("r",z).attr("transform","translate("+a.l+",-"+(this.model.get("height")/2-2*z)+")").attr("fill","#8B2C0D"),$(".bar circle").last().click($.proxy(function(){_.defer($.proxy(function(){$(".tooltip").not(b).fadeOut(),b.fadeToggle();var a=$(b[1]).outerHeight(),c=$(b[1]).outerWidth();b.css("left",this.mouseX-c/2).css("top",this.mouseY-2*z-a)},this))},this))},this));var A=mts.exit();A.attr("opacity",0).remove()},repositionBar:function(){this.$(".tooltip").hide();var a=this.model.get("view").body.select(".bg"),b=a.selectAll(".bar_bg");b.attr("transform","translate("+this.navctl.getPanOffset()+",-"+this.model.get("height")/2+")")},appendCallout:function(a){var b=24,c=10,d=10,e=10,f=10,g=5,h=10,i=1.2;a.filter(function(a){return Math.log(a.lev+1)*i<=h}).append("circle").attr("r",function(a){return Math.log(a.lev+1)*i}).attr("class","tcircle"),a.filter(function(a){return Math.log(a.lev+1)*i>h}).append("circle").attr("r",h).attr("class","tcircle_full"),a.append("title").text(function(a){return"User: "+a.contributor+"\n"+Helper.formatDate(a.date)+"\n"+"Revision Categories: "+Helper.toTalkClassString(a)+"\n"+"Revision Size: "+a.lev});var j=a.append("path");j.attr("d",$.proxy(function(a){return"M 0 0 l {0} {1} l 0 {2} a {3} {3} 0 0 0 {3} {3} l {4} 0 a {3} {3} 0 0 0 {3} -{3} l 0 -{5} a {3} {3} 0 0 0 -{3} -{3} l -{6} 0 z".format(e,f,this.getCalloutHeight(a)+2*c-2*g,g,b+2*d-g,this.getCalloutHeight(a)+2*c-g-10,b+2*d-2*g)},this)),j.attr("class","callout");var k=a.append("g").attr("class","igroup").attr("transform","translate("+(e+c)+","+(f+d)+")scale(1,-1)").datum($.proxy(function(a){return this.genCalloutImageSet(a)},this));k.each(function(a){d3.select(this).selectAll("image").data(a).enter().append("image").attr("xlink:href",function(a){return"img/"+a+".png"}).attr("y",function(a,b){return-29*b-24}).attr("width",24).attr("height",24).attr("x",3).attr("class",function(a){return a})}),a.append("text").attr("class","xlabel").text(function(a,b){return b+1}).attr("transform",function(){return"translate("+(e+c/2)+","+(f+d/2)+")scale(1,-1)"})},updateSpacing:function(){this.model.get("isTimeSpaced")?(this.navctl.toTimeSpaced(),this.toTimeSpaced()):(this.navctl.toAdjacentSpaced(),this.toAdjacentSpaced())},updateMode:function(){if("art"==this.model.get("mode")){this.$("#view").appendTo(this.$("#artview")),this.model.get("view").data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",0),d3.selectAll(".tcircle").attr("opacity",0),this.$("#t_legend").button("enable"),this.$("#t_talk").button("disable"),this.$("#toAdj").button("enable"),d3.selectAll(".month").attr("opacity",1),this.model.get("isTimeSpaced")===!1?(this.$("#toAdj").button("disable"),this.$("#toTime").button("enable"),this.navctl.toAdjacentSpaced()):(this.$("#toAdj").button("enable"),this.$("#toTime").button("disable"),this.navctl.toTimeSpaced()),this.navctl.onScale();var a=this.view.subviews.toolbar.subviews.diag_data.dialog;$(".talkrow",a).addClass("invisible"),$(".defaultrow",a).removeClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, -500)"),d3.selectAll("g.ylabel").attr("opacity",1)}else if("talk"==this.model.get("mode")){this.$("#view").appendTo(this.$("#talkview")),this.model.get("view").data.selectAll(".datum").attr("opacity",0),d3.selectAll(".sd").attr("opacity",0),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),$("#t_legend").button("disable"),$("#t_talk").button("enable"),this.model.get("isTimeSpaced")===!1?(d3.selectAll(".month").attr("opacity",0),this.$("#toAdj").button("disable"),this.$("#toTime").button("enable"),this.navctl.toAdjacentSpaced()):(this.$("#toAdj").button("enable"),this.$("#toTime").button("disable"),this.navctl.toTimeSpaced()),this.navctl.onScale();var a=this.view.subviews.toolbar.subviews.diag_data.dialog;$(".talkrow",a).removeClass("invisible"),$(".defaultrow",a).addClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",0)}else if("hybrid"==this.model.get("mode")){this.$("#view").appendTo(this.$("#hybridview")),this.model.get("view").data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),this.$("#t_legend").button("enable"),this.$("#t_talk").button("enable"),this.$("#toAdj").button("disable"),this.$("#toTime").button("disable"),this.model.set("isTimeSpaced",!0),d3.selectAll(".month").attr("opacity",1);var a=this.view.subviews.toolbar.subviews.diag_data.dialog;$(".talkrow",a).removeClass("invisible"),$(".defaultrow",a).removeClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",1)}},init:function(){this.$("#viewtabs").tabs(),this.model.set("width",this.$("#view").width(),{silent:!0}),this.model.set("height",this.$("#view").height(),{silent:!0}),this.$(".spacing_wrapper").mouseenter(function(){$(this).css("opacity",1)}).mouseleave(function(){$(this).css("opacity",.8)}),this.model.set("isTimeSpaced",!1),this.$("#toAdj").button().attr("title","Adjacent Spacing"),this.$("#toTime").button().attr("title","Time Spacing"),this.$("#toAdj").click($.proxy(function(){this.model.set("isTimeSpaced",!1),this.$("#toAdj").button("disable"),this.$("#toTime").button("enable")},this)),this.$("#toTime").click($.proxy(function(){this.model.set("isTimeSpaced",!0),this.$("#toAdj").button("enable"),this.$("#toTime").button("disable")},this)),this.$("a[href=#artview]").click($.proxy(function(){this.model.set("mode","art")},this)),this.$("a[href=#talkview]").click($.proxy(function(){this.model.set("mode","talk")},this)),this.$("a[href=#hybridview]").click($.proxy(function(){this.model.set("mode","hybrid")},this)),this.$("#toAdj").button("disable")},initViz:function(){if(this.$("#view svg").remove(),""!=this.model.get("title")||""!=this.model.get("user")){var a=this.model.get("maskWidth"),b=this.model.get("view");b.svg=d3.select(this.$("#view")[0]).append("svg").attr("width",this.model.get("width")).attr("height",this.model.get("height")),b.sview=b.svg.append("g").attr("width",this.model.get("width")).attr("transform","translate("+a+","+this.model.get("height")/2+")scale(1,-1)"),b.x=d3.scale.linear(),b.y=d3.scale.linear(),b.tx=d3.scale.linear(),b.ty=d3.scale.linear();var c=this.calcBarWidth();b.x.range([0,c]),b.y.range([0,this.model.get("height")/2-50]),b.y.domain([0,Helper.absMax(this.model.get("data").get("revisions"),function(a){return a.loglev})]),b.rules=b.sview.append("g").attr("class","rules");var e=b.rules.append("g").attr("class","posrules"),f=b.rules.append("g").attr("class","negrules");e.selectAll("g.rule").data(b.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+b.y(a)+")"}),f.selectAll("g.rule").data(b.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+-b.y(a)+")"}),b.rules.selectAll(".rule").append("line").attr("x2",Helper.width),b.body=b.sview.append("g").attr("class","body").attr("transform","translate(0,0)");var g=b.body;b.sview.append("g").attr("class","xaxis").append("line").attr("x2",this.model.get("width"));var h=b.sview.append("g").attr("class","ylabel");h.append("rect").attr("class","ymask").attr("width",a).attr("height",this.model.get("height")).attr("y",-this.model.get("height")/2).attr("x",-a),h.append("text").attr("transform","translate("+-(a-10)+", 0)rotate(90, 0, 0)scale(1, -1)").text("Revision Size");var i=h.append("g");i.selectAll(".yl").data(b.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+b.y(a)+")scale(1,-1)"}).text(function(a){return(Math.exp(a)-1).toPrecision(3)});var j=h.append("g");j.selectAll(".yl").data(b.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+-b.y(a)+")scale(1,-1)"}).text(function(a){return(-Math.exp(a)+1).toPrecision(3)}),g.append("g").attr("class","bg"),g.append("g").attr("class","mid"),g.append("g").attr("class","fg"),b.data=g.select("g.mid").append("g").attr("class","data");var k=b.data,l=k.selectAll(".datum").data(this.model.get("data").get("revisions")).enter().append("g").attr("class","datum").attr("transform",$.proxy(function(a){return"translate("+b.x(this.model.index(a))+", 0)"},this)).attr("opacity",1);l.append("title").text(function(a){return a.group+": "+a.user+"\n"+Helper.formatDate(new Date(a.timestamp))+"\n"+"Revision Categories: "+Helper.toClassString(a.class)+"\n"+"Revision Size: "+a.lev});var m=l.append("g").attr("class","bars");this.buildBars(m,c),l.append("text").attr("class","xlabel").text($.proxy(function(a){return 1+this.model.index(a)},this)).attr("transform",function(){return"translate(0,"+String(-7)+")scale(1,-1)rotate(90,0,0)"}),this.buildMonths(),b.tdata=g.select("g.fg").append("g").attr("class","tdata");var n=b.tdata.selectAll(".tdatum").data(this.model.get("data").get("talk")).enter().append("g").attr("class","tdatum").attr("transform",$.proxy(function(a){return"translate("+b.x(this.model.index(a))+", 0)"},this)).attr("opacity",0);this.appendCallout(n);var o=_.first(this.model.get("data").get("revisions")).date;this.model.timeX.domain([new Date(o.getFullYear(),o.getMonth()),_.last(this.model.get("data").get("revisions")).date]),this.model.timeX.range([0,5e3]),this.$("#view #view_loading").remove(),this.navctl.init(this.$("#navctl").width(),30);var p=null;if(this.view.subviews.toolbar.subviews.diag_select!=d){p=this.view.subviews.toolbar.subviews.diag_select.dialog;for(var q={},r=this.model.get("data").get("revisions"),s=0,t=0;t<r.length;++t)q.hasOwnProperty(r[t].user)||(q[r[t].user]=0),q[r[t].user]+=parseInt(r[t].lev),s+=parseInt(r[t].lev);var v=Array();for(u in q)q.hasOwnProperty(u)&&v.push([u,q[u]/s]);v.sort(function(a,b){return b[1]-a[1]}),d3.select($("#userselect",p)[0]).selectAll("option").data(v).enter().append("option").attr("value",function(a){return a[0]}).text(function(a){var b=100*a[1];return a[0]+" ("+b.toFixed(2).toString()+"%)"})}else if(this.view.subviews.toolbar.subviews.diag_articles!=d){p=this.view.subviews.toolbar.subviews.diag_articles.dialog;var w=this.model.get("data").get("articles");d3.select($("#userselect",p)[0]).selectAll("option").data(w).enter().append("option").attr("value",function(a){return a}).text(function(a){return a})}$("#userselect option",p).click(function(){$("input[name=userclassselect]",p).each(function(){$(this).attr("checked",!1)})}),p=this.view.subviews.toolbar.subviews.diag_data.dialog,$(p).empty();var x=d3.select(p[0]).append("table").attr("class","sortable"),y=Array();""!=this.model.get("data").get("user")&&y.push(["Article Title","sorttable_alpha"]),y.push(["Rev. Type","sorttable_alpha"]),y.push(["Revision Id","sorttable_numeric"]),""!=this.model.get("data").get("title")&&y.push(["User","sorttable_alpha"]),y.push(["User Group","sorttable_alpha"]),y.push(["Revision Date","sorttable_alpha"]),y.push(["Revision Size","sorttable_numeric"]),y.push(["Revision Categories","sorttable_alpha"]),x.append("thead").append("tr").selectAll("th").data(y).enter().append("th").text(function(a){return a[0]}).attr("class",function(a){return a[1]});var t=0,z=0,A=this.model.get("data").get("revisions"),B=this.model.get("data").get("talk");B=B.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1}),A=A.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1});for(var C=[];t<A.length&&z<B.length;)A[t].date<B[z].date?(C.push(A[t]),++t):(C.push(B[z]),++z);t<A.length&&(C=C.concat(A.slice(t))),z<B.length&&(C=C.concat(B.slice(z)));var D=x.append("tbody").selectAll("tr.data").data(C).enter().append("tr");""!=this.model.get("data").get("user")&&D.append("td").text(function(a){return a.page_title}),D.append("td").text(function(a){return"art"===a.type?"A":"TP"}),D.append("td").text(function(a){return a.revid}),""!=this.model.get("data").get("title")&&D.append("td").text(function(a){return a.user}),D.append("td").text(function(a){return a.group}),D.append("td").text(function(a){return Helper.formatDate(a.date)}).attr("sorttable_customkey",function(a){return Helper.getDateSortKey(a.date)}),D.append("td").text(function(a){return a.lev}),D.append("td").text(function(a){return"art"===a.type?Helper.toClassString(a.class):"talk"===a.type?Helper.toTalkClassString(a):"Undefined"}),D.attr("class",function(a){return"talk"===a.type?"data talkrow":"data defaultrow"}),sorttable.makeSortable($("table.sortable",p).get(0)),$(".talkrow",p).addClass("invisible"),this.updateMode(),this.updateSpacing()}},render:function(){return this.$el}}),subview=function(a){return"<div data-subview='"+a+"'></div>"},String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})},Helper=function(){},Helper.formatDate=function(a,b){b==d&&(b=!0);var c=["January","February","March","April","May","June","July","August","September","October","November","December"][a.getMonth()]+" "+a.getDate()+", "+a.getFullYear();return b&&(c+="   "+("0"+a.getHours()).substr(-2,2)+":"+("0"+a.getMinutes()).substr(-2,2)),c},Helper.getDateSortKey=function(a){return String(a.getFullYear())+("0"+a.getMonth()).substr(-2,2)+("0"+a.getDate()).substr(-2,2)+("0"+a.getHours()).substr(-2,2)+("0"+a.getMinutes()).substr(-2,2)+("0"+a.getSeconds()).substr(-2,2)},Helper.isSubset=function(a,b){for(var c={},d=0;d<b.length;++d)c[b[d]]=!0;for(var d=0;d<a.length;++d)if(!c.hasOwnProperty(a[d]))return!1;return!0},Helper.toClassString=function(a){return a.split(";").map(function(a){return{a:"edit",b:"add",c:"remove",d:"reorganize",e:"cite",f:"vandalize",g:"unvandalize",x:"unclassified"}[a]}).join(", ")},Helper.toTalkClassString=function(a){var b="";return a.att&&(b+="attitude, "),a.crit&&(b+="criticism, "),a.inf&&(b+="informative, "),a.perf&&(b+="performative, "),b.substring(0,b.length-2)},Helper.absMax=function(a,b){if(!(a instanceof Array)||a.length<1)return d;for(var c=b(a[0]),e=1;e<a.length;++e)c=Math.max(c,Math.abs(b(a[e])));return c},$.ajaxSetup({cache:!1}),articles=new ArticleCollection,articles.fetch(),topTabs=new TopTabCollection,topTabsView=new TopTabsView({model:topTabs,el:"#topTabs"}),PageRouter=Backbone.Router.extend({routes:{test:"testRoute","*actions":"defaultRoute"},defaultRoute:function(){var a=new NewArticleView({model:articles});topTabsView.render(),topTabs.add(new TopTab({title:"New Tab",mainView:a,selected:!0})),topTabs.add(new NewTopTab)}}),pageRouter=new PageRouter,Backbone.history.start()}(window,document);