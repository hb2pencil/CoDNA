//     CoDNA 0.1.0
//     (c) 2013 Henry Brausen, David Turner
//     https://github.com/hb2pencil/CoDNA
//     Released under GPLv2 License
!function(a,b,d){WIKIVIZ={width:910,height:500,numBars:60,maskWidth:50,timeMultiplier:1,weights:{add:60,remove:60,edit:20,reorganize:40,vand:10,unvand:10,cite:20,unclassified:60},view:{timeX:d3.time.scale(),mode:"art"}},WIKIVIZ.getGroupsByName=function(a){return WIKIVIZ.data.users.hasOwnProperty(a)?WIKIVIZ.data.users[a].history[WIKIVIZ.data.users[a].history.length-1]?WIKIVIZ.data.users[a].history[WIKIVIZ.data.users[a].history.length-1].userclass:["None"]:["None"]},WIKIVIZ.index=function(a){return a.id},WIKIVIZ.tIndex=function(a){return a.id},WIKIVIZ.getRevisionGroup=function(a,b){var c=a.users;if(!b.user in c)return"Anon";var d=c[b.user];if(!d)return"Anon";if(d.flagged)return d.history[d.history.length-1].userclass;if(d.history.length<1)return"Anon";for(var e=new Date(b.timestamp),f=1,g=d.history[0];f<d.history.length&&!(new Date(d.history[f].timestamp)>e);)g=d.history[f],++f;return g.userclass},WIKIVIZ.augment=function(a){function b(a,b){return-1!=b.indexOf(a)}$.each(a.talk,function(b,c){c.date=new Date(c.timestamp),c.loglev=Math.log(c.lev+1),c.user=c.contributor,c.type="talk",c.id=b,c.group=WIKIVIZ.getRevisionGroup(a,c)}),$.each(a.revisions,function(d,e){var f={add:0,remove:0,edit:0,reorganize:0,cite:0,vand:0,unvand:0,unsure:0,unclassified:0};b("a",e["class"])&&(f.edit+=WIKIVIZ.weights.edit),b("b",e["class"])&&(f.add+=WIKIVIZ.weights.add),b("c",e["class"])&&(f.remove+=WIKIVIZ.weights.remove),b("d",e["class"])&&(f.reorganize+=WIKIVIZ.weights.reorganize),b("e",e["class"])&&(f.cite+=WIKIVIZ.weights.cite),b("f",e["class"])&&(f.vand+=WIKIVIZ.weights.vand),b("g",e["class"])&&(f.unvand+=WIKIVIZ.weights.unvand),b("x",e["class"])&&(f.unclassified+=WIKIVIZ.weights.unclassified);var g=0;for(c in f)g+=f[c];if(0!=g)for(c in f)f[c]=f[c]*Math.log(+e.lev+1)/g;0===g&&(f.unsure=Math.log(e.lev+1)),e.wclass=f,e.loglev=Math.log(+e.lev+1),e.date=new Date(e.timestamp),e.group=WIKIVIZ.getRevisionGroup(a,e),e.type="art",e.id=d})},WIKIVIZ.load=function(a){$.getJSON("dbquery.php?",{lower:0,upper:1e4,article:a},function(a){WIKIVIZ.augment(a),WIKIVIZ.data=a;for(var b={},c=a.revisions,d=0,e=0;e<c.length;++e)b.hasOwnProperty(c[e].user)||(b[c[e].user]=0),b[c[e].user]+=parseInt(c[e].lev),d+=parseInt(c[e].lev);var f=Array();for(u in b)b.hasOwnProperty(u)&&f.push([u,b[u]/d]);f.sort(function(a,b){return b[1]-a[1]}),d3.select("#userselect").selectAll("option").data(f).enter().append("option").attr("value",function(a){return a[0]}).text(function(a){var b=100*a[1];return a[0]+" ("+b.toFixed(2).toString()+"%)"}),$("#userselect option").click(function(){$("input[name=userclassselect]").each(function(){$(this).attr("checked",!1)})});var g=d3.select("#diag_data").append("table").attr("class","sortable");g.append("thead").append("tr").selectAll("th").data([["Rev. Type","sorttable_alpha"],["ID","sorttable_numeric"],["User","sorttable_alpha"],["User Group","sorttable_alpha"],["Revision Date","sorttable_alpha"],["Revision Size","sorttable_numeric"],["Revision Categories","sorttable_alpha"]]).enter().append("th").text(function(a){return a[0]}).attr("class",function(a){return a[1]});var e=0,h=0,i=WIKIVIZ.data.revisions,j=WIKIVIZ.data.talk;j=j.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1}),i=i.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1});for(var k=[];e<i.length&&h<j.length;)i[e].date<j[h].date?(k.push(i[e]),++e):(k.push(j[h]),++h);e<i.length&&(k=k.concat(i.slice(e))),h<j.length&&(k=k.concat(j.slice(h)));var l=g.append("tbody").selectAll("tr.data").data(k).enter().append("tr");l.append("td").text(function(a){return"art"===a.type?"A":"TP"}),l.append("td").text(function(a){return 1+a.id}),l.append("td").text(function(a){return a.user}),l.append("td").text(function(a){return a.group}),l.append("td").text(function(a){return WIKIVIZ.formatDate(a.date)}).attr("sorttable_customkey",function(a){return WIKIVIZ.getDateSortKey(a.date)}),l.append("td").text(function(a){return a.lev}),l.append("td").text(function(a){return"art"===a.type?WIKIVIZ.toClassString(a.class):"talk"===a.type?WIKIVIZ.toTalkClassString(a):"Undefined"}),l.attr("class",function(a){return"talk"===a.type?"data talkrow":"data defaultrow"}),sorttable.makeSortable($("#diag_data table.sortable").get(0)),$(".talkrow").addClass("invisible"),WIKIVIZ.initViz();var m=WIKIVIZ.data.revisions[0].date;WIKIVIZ.view.timeX.domain([new Date(m.getFullYear(),m.getMonth()),WIKIVIZ.data.revisions[WIKIVIZ.data.revisions.length-1].date]),WIKIVIZ.view.timeX.range([0,5e3]),$("#view #view_loading").remove(),WIKIVIZ.navctl.init(920,30)})},String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})},WIKIVIZ.formatDate=function(a){return["January","February","March","April","May","June","July","August","September","October","November","December"][a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()+"   "+("0"+a.getHours()).substr(-2,2)+":"+("0"+a.getMinutes()).substr(-2,2)},WIKIVIZ.getDateSortKey=function(a){return String(a.getFullYear())+("0"+a.getMonth()).substr(-2,2)+("0"+a.getDate()).substr(-2,2)+("0"+a.getHours()).substr(-2,2)+("0"+a.getMinutes()).substr(-2,2)+("0"+a.getSeconds()).substr(-2,2)},WIKIVIZ.isSubset=function(a,b){for(var c={},d=0;d<b.length;++d)c[b[d]]=!0;for(var d=0;d<a.length;++d)if(!c.hasOwnProperty(a[d]))return!1;return!0},WIKIVIZ.toClassString=function(a){return a.split(";").map(function(a){return{a:"edit",b:"add",c:"remove",d:"reorganize",e:"cite",f:"vandalize",g:"unvandalize",x:"unclassified"}[a]}).join(", ")},WIKIVIZ.toTalkClassString=function(a){var b="";return a.att&&(b+="attitude, "),a.crit&&(b+="criticism, "),a.inf&&(b+="informative, "),a.perf&&(b+="performative, "),b.substring(0,b.length-2)},WIKIVIZ.absMax=function(a,b){if(!(a instanceof Array)||a.length<1)return d;for(var c=b(a[0]),e=1;e<a.length;++e)c=Math.max(c,Math.abs(b(a[e])));return c},WIKIVIZ.applyUserSelection=function(a){if(WIKIVIZ.clearAllSelections(),!(a.length>0))return WIKIVIZ.clearAllSelections(),void 0;$("#t_deselect").button("enable"),$("#diag_legend input").attr("disabled","disabled"),$("#d_select_groups_accordion input").attr("disabled","disabled");var b={};b["Number of Selected Users"]=a.length,b["User Groups"]=[];for(var c=0;c<a.length;++c)-1==jQuery.inArray(WIKIVIZ.getGroupsByName(a[c]),b["User Groups"])&&b["User Groups"].push(WIKIVIZ.getGroupsByName(a[c]));WIKIVIZ.updateInfo(b),$("#diag_data table tbody").children("tr").each(function(b,c){$(c).removeClass("rowselect"),-1!=jQuery.inArray($(c).children(":eq(2)").text(),a)&&$(c).addClass("rowselect")}),WIKIVIZ.view.data.selectAll(".datum").filter(function(b){return-1===jQuery.inArray(b.user,a)}).selectAll(".bars rect").transition().duration(500).attr("opacity",.2),WIKIVIZ.navctl.spikes.filter(function(b){return-1===jQuery.inArray(b.user,a)}).transition().duration(500).attr("opacity",.4)},WIKIVIZ.updateInfo=function(a){$("#d_info_noselection").addClass("invisible"),$("#d_info_selection").empty();var b=0;$("#d_info_selection").append($("<table>"));for(p in a)a.hasOwnProperty(p)&&(++b,$("#d_info_selection table").append($("<tr>").append($("<td>").text(p)).append($("<td>").text(a[p].toString()))));0==b&&($("#d_info_selection").empty(),$("#d_info_noselection").removeClass("invisible"))},WIKIVIZ.createToolbar=function(){$("#t_select").button({icons:{primary:"icon-users"},text:!1}),$("#t_data").button({icons:{primary:"icon-table"},text:!1}),$("#t_legend").button({icons:{primary:"icon-categories"},text:!1}),$("#t_deselect").button({icons:{primary:"icon-deselect"},text:!1,disabled:!0}),$("#t_deselect").click(function(){WIKIVIZ.clearAllSelections(!0)}),$("#t_talk").button({icons:{primary:"icon-talk"},text:!1,disabled:!0})},WIKIVIZ.createDialogs=function(){$("#diag_cursor").dialog({autoOpen:!1,title:"Cursor Type",width:"auto",resizable:!1}),$("#diag_options").dialog({autoOpen:!1,title:"Options",resizable:!1}),$("#diag_select").dialog({autoOpen:!1,title:"Contributors",width:400,resizable:!1}),$("#select_apply").button(),$("#d_select_tabs").tabs(),$("#diag_info").dialog({autoOpen:!1,title:"Selection Information",resizable:!1,width:400}),$("#diag_data").dialog({autoOpen:!1,title:"Article Revision Details",resizable:!0,width:800,height:600}),$("#diag_legend").dialog({autoOpen:!1,title:"Article Revision Categories",resizable:!1,height:"auto",width:400}),$("#d_legend_accordion").accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$(".d_checkable h3").each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})});var a={addrem:["add","remove"],edit:["edit"],reorganize:["reorganize"],cite:["cite"],unsure:["unsure"],vandunvand:["vand","unvand"]};$("#d_legend_accordion h3").each(function(b,c){$(c).find("input").change(function(){if($(this).attr("checked"))for(var b in a[$(this).val()])WIKIVIZ.view.data.selectAll("rect."+a[$(this).val()][b]).transition().duration(500).attr("opacity",1);else for(var b in a[$(this).val()])WIKIVIZ.view.data.selectAll("rect."+a[$(this).val()][b]).transition().duration(500).attr("opacity",.2);var c=new Array;$("#d_legend_accordion input:checked").each(function(b,d){$.merge(c,a[$(d).val()])}),WIKIVIZ.navctl.bg.selectAll("rect").transition().duration(500).attr("opacity",function(a){var b=.2;return $(c).each(function(c,d){return a.wclass[d]?(b=1,1):void 0}),b}),$("#t_deselect").button("enable")})}),$("#d_talk_accordion h3").each(function(a,b){$(b).find("input").change(function(){var a=$(this);$(this).attr("checked")?d3.selectAll(".tdatum ."+a.val()).transition().duration(500).attr("opacity",1):d3.selectAll(".tdatum ."+a.val()).transition().duration(500).attr("opacity",.2),$("#t_deselect").button("enable")})}),$("#d_select_groups_accordion").accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$("#d_select_groups_accordion h3").each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_select_groups_accordion h3").each(function(a,b){$(b).find("input").change(function(){var a=$(this);$(this).attr("checked")?WIKIVIZ.view.data.selectAll(".datum").filter(function(b){return b.group==a.val()}).transition().duration(500).attr("opacity",1):WIKIVIZ.view.data.selectAll(".datum").filter(function(b){return b.group==a.val()}).transition().duration(500).attr("opacity",.2),$("#t_deselect").button("enable")})}),$("#diag_talk").dialog({autoOpen:!1,title:"Talk Page Revision Categories",resizable:!1,height:"auto",width:400}),$("#d_talk_accordion").accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0})},WIKIVIZ.bindToolbar=function(){$("#t_cursor").click(function(){$("#diag_cursor").dialog("open")}),$("#t_options").click(function(){$("#diag_options").dialog("open")}),$("#t_select").click(function(){$("#diag_select").dialog("open")}),$("#t_info").click(function(){$("#diag_info").dialog("open")}),$("#t_data").click(function(){$("#diag_data").dialog("open")}),$("#t_legend").click(function(){$("#diag_legend").dialog("open")}),$("#t_talk").click(function(){$("#diag_talk").dialog("open")})},WIKIVIZ.bindDialogs=function(){$("input[name=userclassselect]").each(function(a,b){$(b).change(function(){var a=Array();$("input[name=userclassselect]:checked").each(function(b,c){a.push($(c).val())}),$("#userselect option").each(function(b,c){WIKIVIZ.isSubset([WIKIVIZ.getGroupsByName($(c).val())],a)?$(c).attr("selected",!0):$(c).attr("selected",!1),$(c).addClass("invisible"),$(c).removeClass("invisible")})})}),$("#select_apply").click(function(){var a=Array();$("#userselect option:selected").each(function(){a.push($(this).val())}),WIKIVIZ.applyUserSelection(a)})},WIKIVIZ.init=function(a){WIKIVIZ.createToolbar(),WIKIVIZ.createDialogs(),$("#viewtabs").tabs(),$(".spacing_wrapper").mouseenter(function(){$(this).css("opacity",1)}).mouseleave(function(){$(this).css("opacity",.8)}),WIKIVIZ.bindToolbar(),WIKIVIZ.bindDialogs(),WIKIVIZ.load(a),WIKIVIZ.isTimeSpaced=!1,$("#toAdj").button().attr("title","Adjacent Spacing"),$("#toTime").button().attr("title","Time Spacing"),$("#toAdj").click(function(){WIKIVIZ.navctl.toAdjacentSpaced(),$("#toAdj").button("disable"),$("#toTime").button("enable")}),$("#toTime").click(function(){WIKIVIZ.navctl.toTimeSpaced(),$("#toAdj").button("enable"),$("#toTime").button("disable")}),$("a[href=#artview]").click(function(){$("#view").appendTo("#artview"),WIKIVIZ.view.data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",0),d3.selectAll(".tcircle").attr("opacity",0),$("#t_legend").button("enable"),$("#t_talk").button("disable"),$("#toAdj").button("enable"),d3.selectAll(".month").attr("opacity",1),WIKIVIZ.view.mode="art",WIKIVIZ.isTimeSpaced===!1?($("#toAdj").button("disable"),$("#toTime").button("enable"),WIKIVIZ.navctl.toAdjacentSpaced()):($("#toAdj").button("enable"),$("#toTime").button("disable"),WIKIVIZ.navctl.toTimeSpaced()),WIKIVIZ.navctl.onScale(),$(".talkrow").addClass("invisible"),$(".defaultrow").removeClass("invisible"),d3.select(".fg").attr("transform","translate(0, -500)"),d3.selectAll("g.ylabel").attr("opacity",1)}),$("a[href=#talkview]").click(function(){$("#view").appendTo("#talkview"),WIKIVIZ.view.data.selectAll(".datum").attr("opacity",0),d3.selectAll(".sd").attr("opacity",0),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),$("#t_legend").button("disable"),$("#t_talk").button("enable"),WIKIVIZ.view.mode="talk",WIKIVIZ.isTimeSpaced===!1?(d3.selectAll(".month").attr("opacity",0),$("#toAdj").button("disable"),$("#toTime").button("enable"),WIKIVIZ.navctl.toAdjacentSpaced()):($("#toAdj").button("enable"),$("#toTime").button("disable"),WIKIVIZ.navctl.toTimeSpaced()),WIKIVIZ.navctl.onScale(),$(".talkrow").removeClass("invisible"),$(".defaultrow").addClass("invisible"),d3.select(".fg").attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",0)}),$("a[href=#hybridview]").click(function(){$("#view").appendTo("#hybridview"),WIKIVIZ.view.data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),$("#t_legend").button("enable"),$("#t_talk").button("enable"),$("#toAdj").button("disable"),$("#toTime").button("disable"),WIKIVIZ.view.mode="hybrid",WIKIVIZ.navctl.toTimeSpaced(),d3.selectAll(".month").attr("opacity",1),$(".talkrow").removeClass("invisible"),$(".defaultrow").removeClass("invisible"),d3.select(".fg").attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",1)}),$("#toAdj").button("disable")},WIKIVIZ.initViz=function(){var a=WIKIVIZ.maskWidth;WIKIVIZ.view.svg=d3.select("#view").append("svg").attr("width",WIKIVIZ.width).attr("height",WIKIVIZ.height),WIKIVIZ.view.sview=WIKIVIZ.view.svg.append("g").attr("width",WIKIVIZ.width).attr("transform","translate("+a+","+WIKIVIZ.height/2+")scale(1,-1)"),WIKIVIZ.view.x=d3.scale.linear(),WIKIVIZ.view.y=d3.scale.linear(),WIKIVIZ.view.tx=d3.scale.linear(),WIKIVIZ.view.ty=d3.scale.linear();var b=WIKIVIZ.calcBarWidth(),c=WIKIVIZ.view;c.x.range([0,b]),c.y.range([0,WIKIVIZ.height/2-50]),c.y.domain([0,WIKIVIZ.absMax(WIKIVIZ.data.revisions,function(a){return a.loglev})]),c.rules=c.sview.append("g").attr("class","rules");var d=c.rules.append("g").attr("class","posrules"),e=c.rules.append("g").attr("class","negrules");d.selectAll("g.rule").data(c.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+c.y(a)+")"}),e.selectAll("g.rule").data(c.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+-c.y(a)+")"}),c.rules.selectAll(".rule").append("line").attr("x2",WIKIVIZ.width),WIKIVIZ.view.body=c.sview.append("g").attr("class","body").attr("transform","translate(0,0)");var f=WIKIVIZ.view.body;c.sview.append("g").attr("class","xaxis").append("line").attr("x2",WIKIVIZ.width);var g=c.sview.append("g").attr("class","ylabel");g.append("rect").attr("class","ymask").attr("width",a).attr("height",WIKIVIZ.height).attr("y",-WIKIVIZ.height/2).attr("x",-a),g.append("text").attr("transform","translate("+-(a-10)+", 0)rotate(90, 0, 0)scale(1, -1)").text("Revision Size");var h=g.append("g");h.selectAll(".yl").data(c.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+c.y(a)+")scale(1,-1)"}).text(function(a){return(Math.exp(a)-1).toPrecision(3)});var i=g.append("g");i.selectAll(".yl").data(c.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+-c.y(a)+")scale(1,-1)"}).text(function(a){return(-Math.exp(a)+1).toPrecision(3)}),f.append("g").attr("class","bg"),f.append("g").attr("class","mid"),f.append("g").attr("class","fg"),WIKIVIZ.view.data=f.select("g.mid").append("g").attr("class","data");var j=WIKIVIZ.view.data,k=j.selectAll(".datum").data(WIKIVIZ.data.revisions).enter().append("g").attr("class","datum").attr("transform",function(a){return"translate("+c.x(WIKIVIZ.index(a))+", 0)"}).attr("opacity",1);k.append("title").text(function(a){return a.group+": "+a.user+"\n"+WIKIVIZ.formatDate(new Date(a.timestamp))+"\n"+"Revision Categories: "+WIKIVIZ.toClassString(a.class)+"\n"+"Revision Size: "+a.lev});var l=k.append("g").attr("class","bars");WIKIVIZ.buildBars(l,b),k.append("text").attr("class","xlabel").text(function(a){return 1+WIKIVIZ.index(a)}).attr("transform",function(){return"translate(0,"+String(-7)+")scale(1,-1)rotate(90,0,0)"}),WIKIVIZ.buildMonths(),WIKIVIZ.view.tdata=f.select("g.fg").append("g").attr("class","tdata");var m=WIKIVIZ.view.tdata.selectAll(".tdatum").data(WIKIVIZ.data.talk).enter().append("g").attr("class","tdatum").attr("transform",function(a){return"translate("+c.x(WIKIVIZ.index(a))+", 0)"}).attr("opacity",0);WIKIVIZ.appendCallout(m),WIKIVIZ.toAdjacentSpaced()},WIKIVIZ.clearAllSelections=function(){$("#t_deselect").button("disable"),WIKIVIZ.updateInfo({}),$("#diag_data table tbody tr").each(function(a,b){$(b).removeClass("rowselect")}),$("#d_legend_accordion input").attr("checked","checked"),$("#d_select_groups_accordion input").attr("checked","checked"),WIKIVIZ.view.data.selectAll(".bars rect").transition().duration(500).attr("opacity",1),WIKIVIZ.view.data.selectAll(".datum").transition().duration(500).attr("opacity",1),WIKIVIZ.navctl.spikes.transition().duration(500).attr("opacity",1),$("#diag_legend input").removeAttr("disabled"),$("#d_select_groups_accordion input").removeAttr("disabled")},WIKIVIZ.toTimeSpaced=function(){WIKIVIZ.isTimeSpaced=!0,d3.selectAll(".datum").attr("transform",function(a){return"translate("+WIKIVIZ.view.timeX(a.date)+",0)"}).selectAll(".bars rect").attr("width",WIKIVIZ.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",function(a){return"translate("+WIKIVIZ.view.timeX(a.date)+",0)"}),WIKIVIZ.buildMonths(),"talk"==WIKIVIZ.view.mode&&d3.selectAll(".month").attr("opacity",1)},WIKIVIZ.toAdjacentSpaced=function(){WIKIVIZ.isTimeSpaced=!1,"talk"==WIKIVIZ.view.mode&&(d3.selectAll(".month").attr("opacity",0),WIKIVIZ.view.tx.range([0,WIKIVIZ.getAdjacentTalkWidth()])),d3.selectAll(".datum").attr("transform",function(a){return"translate("+WIKIVIZ.view.x(WIKIVIZ.index(a))+",0)"}).selectAll(".bars rect").attr("width",WIKIVIZ.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",function(a,b){return"translate("+WIKIVIZ.view.tx(b)+",0)"}),WIKIVIZ.buildMonths()},WIKIVIZ.getCalloutHeight=function(a){var b=0,c=29;return 0!==a.att&&(b+=c),0!==a.crit&&(b+=c),0!==a.inf&&(b+=c),0!==a.perf&&(b+=c),b},WIKIVIZ.genCalloutImageSet=function(a){var b=[];return 0!==a.att&&b.push("att"),0!==a.crit&&b.push("crit"),0!==a.inf&&b.push("inf"),0!==a.perf&&b.push("perf"),b},WIKIVIZ.appendCallout=function(a){var b=24,c=10,d=10,e=10,f=10,g=5,h=10,i=1.2;a.filter(function(a){return Math.log(a.lev+1)*i<=h}).append("circle").attr("r",function(a){return Math.log(a.lev+1)*i}).attr("class","tcircle"),a.filter(function(a){return Math.log(a.lev+1)*i>h}).append("circle").attr("r",h).attr("class","tcircle_full"),a.append("title").text(function(a){return"User: "+a.contributor+"\n"+WIKIVIZ.formatDate(a.date)+"\n"+"Revision Categories: "+WIKIVIZ.toTalkClassString(a)+"\n"+"Revision Size: "+a.lev});var j=a.append("path");j.attr("d",function(a){return"M 0 0 l {0} {1} l 0 {2} a {3} {3} 0 0 0 {3} {3} l {4} 0 a {3} {3} 0 0 0 {3} -{3} l 0 -{5} a {3} {3} 0 0 0 -{3} -{3} l -{6} 0 z".format(e,f,WIKIVIZ.getCalloutHeight(a)+2*c-2*g,g,b+2*d-g,WIKIVIZ.getCalloutHeight(a)+2*c-g-10,b+2*d-2*g)}),j.attr("class","callout");var k=a.append("g").attr("class","igroup").attr("transform","translate("+(e+c)+","+(f+d)+")scale(1,-1)").datum(function(a){return WIKIVIZ.genCalloutImageSet(a)});k.each(function(a){d3.select(this).selectAll("image").data(a).enter().append("image").attr("xlink:href",function(a){return"img/"+a+".png"}).attr("y",function(a,b){return-29*b-24}).attr("width",24).attr("height",24).attr("x",3).attr("class",function(a){return a})}),a.append("text").attr("class","xlabel").text(function(a,b){return b+1}).attr("transform",function(){return"translate("+(e+c/2)+","+(f+d/2)+")scale(1,-1)"})},WIKIVIZ.calcBarWidth=function(){var a=(WIKIVIZ.width-WIKIVIZ.maskWidth)/WIKIVIZ.numBars;return WIKIVIZ.isTimeSpaced&&(a=Math.min(a,7)),a},WIKIVIZ.calcTalkWidth=function(){var a=(WIKIVIZ.width-WIKIVIZ.maskWidth)/WIKIVIZ.numDots;return a},WIKIVIZ.getAdjacentTalkWidth=function(){return 70*WIKIVIZ.data.talk.length},WIKIVIZ.buildBars=function(a,b){for(var c=["add","unsure","reorganize","edit","cite","vand","unclassified"],d=["unvand","remove"],e=WIKIVIZ.view.y,f=WIKIVIZ.index,g=[],h=0;h<WIKIVIZ.data.revisions.length;++h)g[h]=0;$.each(c,function(c,d){a.filter(function(a){return a.wclass[d]>1e-4}).append("rect").attr("y",function(a){return e(g[f(a)])}).attr("width",b).attr("height",function(a){return e(a.wclass[d])}).attr("class",d).attr("desc",f).attr("opacity",1);for(var h=0;h<WIKIVIZ.data.revisions.length;++h)g[h]+=WIKIVIZ.data.revisions[h].wclass[d]});for(var h=0;h<WIKIVIZ.data.revisions.length;++h)g[h]=0;$.each(d,function(c,d){a.filter(function(a){return a.wclass[d]>1e-4}).append("rect").attr("y",function(a){return-e(a.wclass[d]+g[f(a)])}).attr("width",b).attr("height",function(a){return e(a.wclass[d])}).attr("class",d).attr("desc",f).attr("opacity",1);for(var h=0;h<WIKIVIZ.data.revisions.length;++h)g[h]+=WIKIVIZ.data.revisions[h].wclass[d]})},WIKIVIZ.getOffset=function(a){return 0==WIKIVIZ.isTimeSpaced?a*WIKIVIZ.calcBarWidth():WIKIVIZ.data.revisions[a].dateOffset},WIKIVIZ.buildMonths=function(){WIKIVIZ.calcBarWidth();var a=WIKIVIZ.data.revisions,b=10,c=[],d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(WIKIVIZ.isTimeSpaced)for(var e,f=WIKIVIZ.data.revisions.length-1,g=!0,h=WIKIVIZ.view.timeX,i=WIKIVIZ.data.revisions[0].date.getMonth(),j=WIKIVIZ.data.revisions[0].date.getFullYear();i<=WIKIVIZ.data.revisions[f].date.getMonth()||j<=WIKIVIZ.data.revisions[f].date.getFullYear();++i){i>11&&(i=0,++j),g&&(e=0==i?new Date(j-1,0,1):new Date(j,i-1,1),g=!1);var k=new Date(j,i,1);c.push({l:h(e),r:h(k),m:e.getMonth(),y:e.getFullYear()}),e=k}else{var l,m=new Date(a[0].timestamp),n=0;WIKIVIZ.data.revisions[0];for(var o=1;o<a.length;++o)if(l=new Date(a[o].timestamp),l.getMonth()!==m.getMonth()||l.getYear()!==m.getYear()){var p=WIKIVIZ.getOffset(n),q=WIKIVIZ.getOffset(o);if(p===q)continue;c.push({l:p,r:q,m:m.getMonth(),y:m.getFullYear()}),m=l,n=o}var p=WIKIVIZ.getOffset(n),q=WIKIVIZ.getOffset(a.length);c.push({l:p,r:q,m:m.getMonth(),y:m.getFullYear()})}var r=WIKIVIZ.view.body.select(".bg").selectAll(".month").data(c,function(a,b){return b}).enter(),s=r.append("g").attr("class","month").attr("transform",function(a){return"translate("+a.l+",0)"});s.append("rect").attr("height",String(WIKIVIZ.height)).attr("width",function(a){return a.r-a.l}).attr("class",function(a,b){return 0===b%2?"m_odd":"m_even"}).attr("y",String(-WIKIVIZ.height/2)),s.append("text").attr("class","mtext").text(function(a){return d[a.m]}).attr("transform",function(){return"translate(5,"+(WIKIVIZ.height/2-15)+")scale(1,-1)"}).attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),s.append("text").attr("class","ytext").text(function(a){return String(a.y)}).attr("transform",function(){return"translate(5,"+(WIKIVIZ.height/2-30)+")scale(1,-1)"}).attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),mts=WIKIVIZ.view.body.selectAll(".month").data(c,function(a,b){return b});var t=mts;t.attr("transform",function(a){return"translate("+a.l+",0)"}),t.select("rect").attr("width",function(a){return a.r-a.l}),mts.select("text.mtext").text(function(a){return d[a.m]}),mts.select("text.ytext").text(function(a){return String(a.y)}),t.select("rect").attr("class",function(a,b){return 0===b%2?"m_odd":"m_even"}),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=b}).attr("opacity",1),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=b}).attr("opacity",1);var u=mts.exit();u.attr("opacity",0).remove()},WIKIVIZ.clearMonths=function(){WIKIVIZ.view.body.select(".bg").selectAll(".month").data([]).exit().remove()},WIKIVIZ.setNumBars=function(a){0>=a||(WIKIVIZ.numBars=a,WIKIVIZ.view.x.range([0,WIKIVIZ.calcBarWidth()]),WIKIVIZ.isTimeSpaced||WIKIVIZ.view.data.selectAll(".datum").attr("transform",function(a){return"translate("+WIKIVIZ.view.x(WIKIVIZ.index(a))+", 0)"}),WIKIVIZ.view.data.selectAll(".datum").selectAll(".bars rect").attr("width",WIKIVIZ.calcBarWidth()),WIKIVIZ.view.data.selectAll(".datum").select(".xlabel").filter(function(){return this.getBBox().width<=WIKIVIZ.calcBarWidth()}).attr("opacity",1),WIKIVIZ.view.data.selectAll(".datum").select(".xlabel").filter(function(){return this.getBBox().width>WIKIVIZ.calcBarWidth()}).attr("opacity",0),WIKIVIZ.buildMonths())},WIKIVIZ.setNumDots=function(a){0>=a||(WIKIVIZ.numDots=a,WIKIVIZ.view.tx.range([0,WIKIVIZ.calcTalkWidth()]),WIKIVIZ.isTimeSpaced||WIKIVIZ.view.tdata.selectAll(".tdatum").attr("transform",function(a,b){return"translate("+WIKIVIZ.view.tx(b)+", 0)"}),WIKIVIZ.buildMonths())},WIKIVIZ.navctl={init:function(a,c){this.dim={w:a,h:c},this.sdim={x0:0,w:100},this.svg=d3.select("#navctl").append("svg").attr("width",this.dim.w).attr("height",this.dim.h),this.bg=this.svg.append("g").attr("class","bg");var d=this.dim.h/2;this.bg.append("path").attr("d","M"+d+",0 A"+d+","+d+" 0 0,0 "+d+","+2*d).attr("class","pad").attr("width",d).attr("height",this.dim.h),this.bg.append("path").attr("d","M0,0 A"+d+","+d+" 0 0,1 0,"+2*d).attr("class","pad").attr("width",d).attr("height",this.dim.h).attr("transform","translate("+(this.dim.w-d)+",0)"),this.bg.append("g").attr("class","navbars").attr("x",d).attr("transform","translate("+d+","+this.dim.h/2+")scale(1,-1)"),this.bg.select("g.navbars").append("line").attr("x1",0).attr("y1",0).attr("x2",this.dim.w-2*d).attr("y2",0),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",d).attr("x2",this.dim.w-2*d).attr("y2",d),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",-d).attr("x2",this.dim.w-2*d).attr("y2",-d),this.slider=this.svg.append("g").attr("class","slider"),this.slider.append("rect").attr("class","chandle").attr("width",this.sdim.w-d).attr("height",this.dim.h).attr("x",this.sdim.x0+d),this.slider.append("g").attr("class","lhandlegrp").attr("transform","translate("+this.sdim.x0+",0)").append("path").attr("d","M"+d+",0 A"+d+","+d+" 0 0,0 "+d+","+2*d).attr("class","lhandle").attr("width",d).attr("height",this.dim.h),this.slider.append("g").attr("class","rhandlegrp").attr("transform","translate("+(this.sdim.x0+this.sdim.w)+",0)").append("path").attr("d","M0,0 A"+d+","+d+" 0 0,1 0,"+2*d).attr("class","rhandle").attr("width",d).attr("height",this.dim.h),this.xscale=d3.scale.linear(),this.xscale.domain([0,WIKIVIZ.data.revisions.length-1]),this.xscale.range([0,this.dim.w-2*d]),this.yscale=d3.scale.linear(),this.yscale.domain(WIKIVIZ.view.y.domain()),this.yscale.range([0,this.dim.h/2]);var e=this;this.spikewidth=(this.dim.w-2*d)/WIKIVIZ.data.revisions.length,this.spikes=this.bg.select("g.navbars").selectAll("rect.sd").data(WIKIVIZ.data.revisions),this.spikes.enter().append("rect").attr("x",function(a,b){return e.xscale(b)}).attr("y",function(a){return-e.yscale(a.wclass.remove+a.wclass.vand)}).attr("width",function(){return e.spikewidth}).attr("height",function(a){return e.yscale(a.loglev-(a.wclass.remove+a.wclass.vand))+e.yscale(a.wclass.remove+a.wclass.vand)}).attr("class","sd"),this.dots=this.bg.select("g.navbars").selectAll("circle.td").data(WIKIVIZ.data.talk).enter().append("circle").attr("class","td");var f=5,g=.6;this.dots.filter(function(a){return Math.log(a.lev+1)*g<=f}).attr("r",function(a){return Math.log(a.lev+1)*g}).attr("class","tcircle"),this.dots.filter(function(a){return Math.log(a.lev+1)*g>f}).attr("r",f).attr("class","tcircle_full"),this.mode="adj",this.sd={dx:0},$(".chandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),$(".lhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),$(".rhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX,a.preventDefault()}),$(b).mousemove(function(a){if($(".rhandle").hasClass("dragging")){var b=a.pageX-e.sd.dx;e.sd.dx=a.pageX;var c=+e.sdim.w+b;d>c&&(c=d),c+e.sdim.x0+d>e.dim.w&&(c=e.dim.w-e.sdim.x0-d),e.sdim.w=c,$(".chandle").attr("width",e.sdim.w-d),$(".rhandlegrp").attr("transform","translate("+ +e.sdim.w+",0)"),e.onScale(),e.onSlide()}if($(".lhandle").hasClass("dragging")){var f=a.pageX-e.sd.dx;0>f&&(f=0),f>e.sdim.x0+e.sdim.w-d&&(f=e.sdim.x0+e.sdim.w-d);var c=+e.sdim.w-(+f-+e.sdim.x0);d>c&&(c=d),e.sdim.x0=f,e.sdim.w=c,$(".slider").attr("transform","translate("+e.sdim.x0+",0)"),$(".chandle").attr("width",e.sdim.w-d),$(".rhandlegrp").attr("transform","translate("+ +e.sdim.w+",0)"),e.onScale(),e.onSlide()}$(".chandle").hasClass("dragging")&&(e.sdim.x0=a.pageX-e.sd.dx,e.sdim.x0<0&&(e.sdim.x0=0),e.sdim.x0>e.dim.w-(d+e.sdim.w)&&(e.sdim.x0=e.dim.w-(d+e.sdim.w)),$(".slider").attr("transform","translate("+e.sdim.x0+",0)"),e.onSlide())}),$(b).mouseup(function(){$(".chandle").removeClass("dragging"),$(".lhandle").removeClass("dragging"),$(".rhandle").removeClass("dragging")}),this.handleWidth=d,this.onSlide(),this.onScale()},toTimeSpaced:function(){var a=WIKIVIZ.data.revisions[0].date;this.xscale=d3.time.scale(),this.xscale.domain([new Date(a.getFullYear(),a.getMonth()),WIKIVIZ.data.revisions[WIKIVIZ.data.revisions.length-1].date]),this.xscale.range([0,this.dim.w-2*this.handleWidth]);var b=this;this.bg.select("g.navbars").selectAll("rect.sd").data(WIKIVIZ.data.revisions).attr("x",function(a){return b.xscale(a.date)}).attr("y",function(a){return-b.yscale(a.wclass.remove+a.wclass.vand)}).attr("width",function(){return b.spikewidth}).attr("height",function(a){return b.yscale(a.loglev-(a.wclass.remove+a.wclass.vand))+b.yscale(a.wclass.remove+a.wclass.vand)}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle.tcircle").data(WIKIVIZ.data.talk).attr("cx",function(a){return b.xscale(a.date)}),this.mode="time",WIKIVIZ.toTimeSpaced(),this.onSlide(),this.onScale()},toAdjacentSpaced:function(){this.xscale=d3.scale.linear(),"talk"==WIKIVIZ.view.mode?this.xscale.domain([0,WIKIVIZ.data.talk.length-1]):this.xscale.domain([0,WIKIVIZ.data.revisions.length-1]),this.xscale.range([0,this.dim.w-2*this.handleWidth]);var a=this;this.bg.select("g.navbars").selectAll("rect.sd").data(WIKIVIZ.data.revisions).attr("x",function(b,c){return a.xscale(c)}).attr("y",function(b){return-a.yscale(b.wclass.remove+b.wclass.vand)}).attr("width",function(){return a.spikewidth}).attr("height",function(b){return a.yscale(b.loglev-(b.wclass.remove+b.wclass.vand))+a.yscale(b.wclass.remove+b.wclass.vand)
}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle").data(WIKIVIZ.data.talk).attr("cx",function(b,c){return a.xscale(c)}),this.mode="adj",WIKIVIZ.toAdjacentSpaced(),this.onSlide(),this.onScale()},onSlide:function(){d3.select("g.body").attr("transform","translate("+-this.getPanOffset()+",0)")},onScale:function(){if("adj"==this.mode&&"art"==WIKIVIZ.view.mode)WIKIVIZ.setNumBars(this.getNumBars());else if("adj"==this.mode&&"talk"==WIKIVIZ.view.mode)WIKIVIZ.setNumDots(this.getNumBars());else if("time"==this.mode){var a=WIKIVIZ.data.revisions[WIKIVIZ.data.revisions.length-1].date,b=WIKIVIZ.data.revisions[0].date,c=this.xscale.invert(this.sdim.x0),d=this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth);WIKIVIZ.view.timeX.range([0,.9*WIKIVIZ.width*(a-b)/(d-c)]),WIKIVIZ.toTimeSpaced()}},getPanOffset:function(){return"adj"==this.mode&&"art"==WIKIVIZ.view.mode?this.sdim.x0/(this.dim.w-2*this.handleWidth)*WIKIVIZ.data.revisions.length*WIKIVIZ.calcBarWidth():"adj"==this.mode&&"talk"==WIKIVIZ.view.mode?this.sdim.x0/(this.dim.w-2*this.handleWidth)*WIKIVIZ.data.talk.length*WIKIVIZ.calcTalkWidth():"time"==this.mode?WIKIVIZ.view.timeX(this.xscale.invert(this.sdim.x0)):0},getNumBars:function(){return this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth)-this.xscale.invert(this.sdim.x0)},getTimeRange:function(){}},$(b).ready(function(){$("body").append($("<div>").attr("id","diag_article")),$("#diag_article").append($("<h3>").text("Select an article below:")),$("#diag_article").append($("<div>").attr("id","d_article_list")),$("#diag_article").append($("<div>").attr("id","d_article_list_loading")),$("#d_article_list_loading").append($("<span>").text("Loading . . .")),$("#diag_article").dialog({resizable:!1,width:"auto",height:300,autoOpen:!0,title:"Select Article"}),$.getJSON("dbquery.php?list",function(a){function b(a){return this.datum=a,function(){var b=a.title;$("#page_title").text(b),WIKIVIZ.init(b),$("#everything").fadeIn("slow"),$("#diag_article").dialog("close")}}for(var c=0;c<a.length;++c)$("#d_article_list").append($("<h3>").append($("<a>").append($("<span>").text(a[c].title)).append($("<span>").text("("+a[c].rev_count+" Revisions)").attr("style","float:right")).attr("href","#"))),$("#d_article_list").append($("<div>").append($("<button>").attr("id","d_article_enter_"+c).text("Go").click(b(a[c]))));$("#d_article_list").accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$("#d_article_list_loading").remove()})})}(window,document);