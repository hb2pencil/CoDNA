//     CoDNA 0.2.0
//     (c) 2015 Henry Brausen, David Turner
//     https://github.com/hb2pencil/CoDNA
//     Released under GPLv2 License
!function(a,b,d){Article=Backbone.Model.extend({initialize:function(){},urlRoot:"",defaults:{article_id:0,title:"",rev_count:0,set:1,display:!0}}),ArticleCollection=Backbone.Collection.extend({model:Article,url:function(){return"dbquery.php?list"}}),ArticleSet=Backbone.Model.extend({initialize:function(){},urlRoot:"",defaults:{id:null,name:"",url:"",count:0,disabled:!1}}),ArticleSetCollection=Backbone.Collection.extend({model:ArticleSet,url:"dbquery.php?listArticleSets"}),Classification=Backbone.Model.extend({initialize:function(){$("<style type='text/css'> ."+this.get("id")+" { background:"+this.get("style")+"; fill:"+this.get("style")+"; } </style>").appendTo("head")},defaults:{id:"",manual:"",codna:"",factor:"",weight:0,style:""}}),ClassificationCollection=Backbone.Collection.extend({url:"dbquery.php?classifications",model:Classification}),Backbone.Model=Backbone.Model.extend({constructor:function(a,b){var c=a||{};b||(b={}),this.cid=_.uniqueId("c"),this.attributes={},b.collection&&(this.collection=b.collection),b.parse&&(c=this.parse(c,b)||{}),this.defaults&&(c=_.defaults({},c,_.result(this,"defaults"))),this.set(c,b),this.changed={},this.initialize.apply(this,arguments)},set:function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a)return this;if("object"==typeof a?(e=a,c=b):(e={})[a]=b,c||(c={}),!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],i=this._changing,this._changing=!0,i||(this._previousAttributes=_.clone(this.attributes),this.changed={}),k=this.attributes,j=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]);for(d in e)b=e[d],h||(_.isEqual(k[d],b)||g.push(d),_.isEqual(j[d],b)?delete this.changed[d]:this.changed[d]=b),f?delete k[d]:k[d]=b;if(!h){g.length&&(this._pending=c);for(var l=0,m=g.length;m>l;l++)this.trigger("change:"+g[l],this,k[g[l]],c)}if(i)return this;if(!h)for(;this._pending;)c=this._pending,this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this}}),Backbone.NonUniqueCollection=Backbone.Collection.extend({set:function(a,b){var c={add:!0,remove:!0,merge:!0};b=_.defaults({},b,c),b.silent=!0,b.validate=!1,b.parse=!1;var d=!_.isArray(a);a=d?a?[a]:[]:_.clone(a);var e,f,g,h;for(e=0,f=a.length;f>e;e++)h=a[e]||{},g=a[e]=new this.model(h,b),this.models.push(g);return d?a[0]:a}});var e=200;Sentences=Backbone.Model.extend({initialize:function(){},urlRoot:function(){return"dbquery.php?sentences="+this.get("articleId")+"&set="+this.get("setId")+"&start="+this.get("start")+"&limit="+this.get("limit")},getSections:function(){var a=new Array;return _.each(this.get("revisions"),$.proxy(function(b){_.each(b,$.proxy(function(b,c){a[c]=!0},this))},this)),_.keys(a)},zoomIn:function(a){this.set("zoomLevel",Math.min(10,this.get("zoomLevel")*a))},zoomOut:function(a){this.set("zoomLevel",Math.max(1,this.get("zoomLevel")*a))},prev:function(){this.set("limit",e),this.set("start",Math.max(0,this.get("start")-this.get("limit"))),this.trigger("changePos"),this.fetch()},showAll:function(){this.set("start",0),this.set("limit",this.get("nRevisions")),this.trigger("changePos"),this.fetch()},next:function(){this.set("limit",e),this.set("start",Math.min(this.get("nRevisions")-this.get("limit"),this.get("start")+this.get("limit"))),this.trigger("changePos"),this.fetch()},defaults:{articleId:0,nRevisions:0,setId:0,start:0,limit:e,revisions:{},sentences:{},users:{},revUsers:{},dates:{},zoomLevel:1}}),TopTab=Backbone.Model.extend({initialize:function(){this.on("change:selected",function(){topTabs.getSelected()==this?$("#content").html(this.content):this.content=this.get("mainView").$el.detach(),$(".ui-dialog-content").dialog("close")},this),this.get("mainView").render()},defaults:{type:"tab",color:"#CFECAD",hoverColor:"#BDD99E",title:"",selected:!1,x:Number.MAX_VALUE/2,mainView:null}}),NewTopTab=TopTab.extend({initialize:function(){},defaults:{type:"new",color:"#EEEEEE",hoverColor:"#DDDDDD",title:"<b>&#10133;</b>",selected:!1,x:Number.MAX_VALUE,mainView:null}}),TopTabCollection=Backbone.Collection.extend({comparator:function(a){return"new"==a.get("type")?Number.MAX_VALUE:a.get("x")},getSelected:function(){return this.findWhere({selected:!0})},model:TopTab}),User=Backbone.Model.extend({initialize:function(){},urlRoot:function(){return"dbquery.php?users&id="+this.get("id")},isBot:function(){return-1!=this.get("roles").indexOf("Bot")}}),UserCollection=Backbone.NonUniqueCollection.extend({model:User,url:"dbquery.php?users"}),UserSet=Backbone.Model.extend({initialize:function(){},urlRoot:"",defaults:{id:null,name:"",url:"",count:0,disabled:!1}}),UserSetCollection=Backbone.Collection.extend({model:UserSet,url:"dbquery.php?listUserSets"}),WikiViz=Backbone.Model.extend({initialize:function(){var a=null;""!=this.get("user")?a=new WikiVizData({user:this.get("user"),set:this.get("set"),wikiviz:this}):""!=this.get("article_id")&&(a=new WikiVizData({article_id:this.get("article_id"),title:this.get("title"),set:this.get("set"),wikiviz:this})),this.set("view",{}),a.fetch(),this.set("data",a),this.on("change:numDots",function(){this.set("numDots",Math.max(1,this.get("numDots")))}),this.on("change:numBars",function(){this.set("numBars",Math.max(.1,this.get("numBars")))})},getGroupsByName:function(a){var b=this.get("data").get("users");return b.hasOwnProperty(a)&&b[a].history[b[a].history.length-1]?b[a].history[b[a].history.length-1].userclass:["None"]},index:function(a){return a.id},tIndex:function(a){return a.id},getRevisionGroup:function(a){var b=this.get("data").get("users");if(!a.user in b)return"Anon";var c=b[a.user];if(!c)return"Anon";if(c.flagged)return c.history[c.history.length-1].userclass;if(c.history.length<1)return"Anon";for(var d=new Date(a.timestamp),e=1,f=c.history[0];e<c.history.length&&!(new Date(c.history[e].timestamp)>d);)f=c.history[e],++e;return f.userclass},timeX:d3.time.scale(),defaults:{article_id:"",title:"",user:"",data:null,width:910,height:500,numBars:60,maskWidth:50,timeMultiplier:1,isTimeSpaced:!1,mode:"art",view:null}}),WikiVizData=Backbone.Model.extend({initialize:function(){this.on("sync",this.augment,this)},augment:function(){function a(a,b){return-1!=b.indexOf(a)}$.each(this.get("talk"),$.proxy(function(a,b){b.date=new Date(b.timestamp),b.loglev=Math.log(b.lev+1),b.user=b.contributor,b.type="talk",b.id=a,b.group=this.get("wikiviz").getRevisionGroup(b)},this)),$.each(this.get("revisions"),$.proxy(function(b,e){var f={};_.each(classifications.pluck("id"),function(a){f[a]=0}),""==e["class"]&&(e["class"]=classifications.findWhere({manual:"Miscellaneous"}).get("id"));var g={};classifications.each(function(b){a(b.get("id"),e["class"])&&g[b.get("codna")]==d&&(g[b.get("codna")]=b.get("id"),f[b.get("id")]+=Math.abs(b.get("weight")))});var h=0;for(c in f)h+=f[c];if(0!=h)for(c in f)f[c]=f[c]*Math.log(+e.lev+1)/h;e.revid=e.rev_id,e.wclass=f,e.loglev=Math.log(+e.lev+1),e.date=new Date(e.timestamp),e.group=this.get("wikiviz").getRevisionGroup(e),e.type="art",e.id=b},this))},urlRoot:function(){return""!=this.get("article_id")?"dbquery.php?article="+encodeURIComponent(this.get("article_id"))+"&set="+encodeURIComponent(this.get("set")):""!=this.get("user")?"dbquery.php?user="+encodeURIComponent(this.get("user"))+"&set="+encodeURIComponent(this.get("set")):void 0},defaults:{article_id:"",title:"",user:"",wikiviz:null,users:[],revisions:[],quality:[],events:[],google:[]}}),ArticleInfoView=Backbone.View.extend({initialize:function(a){this.article=a.article,this.listenTo(this.model,"sync",this.render),this.listenTo(this.model.get("data"),"sync",this.render),this.template=_.template($("#article_info_template").html())},render:function(){return this.$el.html(this.template(_.extend(this.article.toJSON(),this.model.toJSON()))),this.$el.attr("id","article_info"),this.$el}}),ArticleView=Backbone.View.extend({template:_.template($("#article_container_template").html()),wikiviz:null,navctl:null,initialize:function(){this.wikiviz=new WikiViz({article_id:this.model.get("article_id"),title:this.model.get("title"),set:this.model.get("set")});var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0],Backbone.Subviews.add(this)},subviewCreators:{article_info:function(){return new ArticleInfoView({model:this.wikiviz,article:this.model})},toolbar:function(){return new ToolbarView({model:{buttons:["select","sections","data","legend","deselect","talk"]},view:this})}},prev:function(){this.viz.sentences.model.prev()},showAll:function(){this.viz.sentences.model.showAll()},next:function(){this.viz.sentences.model.next()},zoomOut:function(){this.viz.sentences.model.zoomOut(.85)},zoomIn:function(){this.viz.sentences.model.zoomIn(1.15)},events:{"click #prev":"prev","click #showAll":"showAll","click #next":"next","click #zoomOut":"zoomOut","click #zoomIn":"zoomIn"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.viz=new WikiVizView({model:this.wikiviz,view:this,el:this.el}),this.viz.init(this.model.get("title")),this.$("#zoomIn").button(),this.$("#zoomOut").button(),this.$el}}),DialogView=Backbone.View.extend({dialog:null,options:null,onCreate:function(){},firstRender:!0,initialize:function(a){this.template=_.template($("#"+a.template).html()),this.options=a.options,_.isFunction(a.onCreate)&&(this.onCreate=a.onCreate)},open:function(){this.dialog.dialog("open")},close:function(){this.dialog.dialog("close")},render:function(){return this.firstRender&&(this.$el.html(this.template()),this.dialog=this.$el.children().dialog(this.options),this.onCreate(this.dialog)),this.firstRender=!1,this.$el}}),NavCtlView=Backbone.View.extend({article:null,initialize:function(b){this.viz=b.viz,this.dim={w:this.viz.$("#navctl").width(),h:30},this.initBg(),this.listenTo(this.viz.model,"change:mode",this.changeMode),$(a).resize($.proxy(function(){this.viz.$("#navctl").width()>0&&(this.initBg(),this.init(this.viz.$("#navctl").width(),this.dim.h))},this))},toTimeSpaced:function(a){a=a!=d?a:{silent:!0};var b=_.first(this.viz.model.get("data").get("revisions")).date,c=_.last(this.viz.model.get("data").get("revisions")).date;this.xscale=d3.time.scale(),this.xscale.domain([new Date(b.getFullYear(),b.getMonth()),c]),this.xscale.rangeRound([0,this.dim.w-2*this.handleWidth-50]);var e=this,f=new Backbone.Collection(classifications.filter(function(a){return a.get("weight")<0})).pluck("id");this.bg.select("g.navbars").selectAll("rect.sd").data(this.viz.model.get("data").get("revisions")).attr("x",function(a){return e.xscale(a.date)}).attr("y",function(a){return-e.yscale(_.reduce(f,function(b,c){return b+Math.abs(a.wclass[c])},0))}).attr("width",function(){return e.spikewidth}).attr("height",function(a){return e.yscale(a.loglev-_.reduce(f,function(b,c){return b+Math.abs(a.wclass[c])},0))+e.yscale(_.reduce(f,function(b,c){return b+Math.abs(a.wclass[c])},0))}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle.tcircle").data(this.viz.model.get("data").get("talk")).attr("cx",function(a){return e.xscale(a.date)}),this.onSlide(a),this.onScale(a)},toAdjacentSpaced:function(a){a=a!=d?a:{silent:!0},this.xscale=d3.scale.linear(),this.xscale.domain("talk"==this.viz.model.get("mode")?[0,this.viz.model.get("data").get("talk").length]:[0,this.viz.model.get("data").get("revisions").length]),this.xscale.rangeRound([0,this.dim.w-2*this.handleWidth]);var b=this,c=new Backbone.Collection(classifications.filter(function(a){return a.get("weight")<0})).pluck("id");this.bg.select("g.navbars").selectAll("rect.sd").data(this.viz.model.get("data").get("revisions")).attr("x",function(a,c){return b.xscale(c)}).attr("y",function(a){return-b.yscale(_.reduce(c,function(b,c){return b+Math.abs(a.wclass[c])},0))}).attr("width",function(){return b.spikewidth}).attr("height",function(a){return b.yscale(a.loglev-_.reduce(c,function(b,c){return b+Math.abs(a.wclass[c])},0))+b.yscale(_.reduce(c,function(b,c){return b+Math.abs(a.wclass[c])},0))}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle").data(this.viz.model.get("data").get("talk")).attr("cx",function(a,c){return b.xscale(c)}),this.onSlide(a),this.onScale(a)},changeMode:function(){"ownership"==this.viz.model.get("mode")?(this.bg.select("g.navbars").selectAll(".navctlline").attr("opacity",0),this.bg.select("g.navbars").selectAll(".sd").attr("opacity",0),this.bg.select("g.navbars").selectAll("circle.tcircle").attr("opacity",0),this.bg.select("g.navbars").selectAll(".osd").attr("opacity",1)):"art"==this.viz.model.get("mode")?(this.bg.select("g.navbars").selectAll(".navctlline").attr("opacity",1),this.bg.select("g.navbars").selectAll(".sd").attr("opacity",1),this.bg.select("g.navbars").selectAll("circle.tcircle").attr("opacity",0),this.bg.select("g.navbars").selectAll(".osd").attr("opacity",0)):"talk"==this.viz.model.get("mode")?(this.bg.select("g.navbars").selectAll(".navctlline").attr("opacity",1),this.bg.select("g.navbars").selectAll(".sd").attr("opacity",0),this.bg.select("g.navbars").selectAll(".tcircle").attr("opacity",1),this.bg.select("g.navbars").selectAll(".osd").attr("opacity",0)):"hybrid"==this.viz.model.get("mode")&&(this.bg.select("g.navbars").selectAll(".navctlline").attr("opacity",1),this.bg.select("g.navbars").selectAll(".sd").attr("opacity",1),this.bg.select("g.navbars").selectAll(".tcircle").attr("opacity",1),this.bg.select("g.navbars").selectAll(".osd").attr("opacity",0)),this.onScale()},onSlide:function(){"ownership"!=this.viz.model.get("mode")&&(d3.selectAll(this.viz.$("g.body")).attr("transform","translate("+-Math.round(this.getPanOffset())+",0)"),this.viz.repositionBar())},onScale:function(a){if(a=a!=d?a:{},!this.viz.model.get("isTimeSpaced")&&"art"==this.viz.model.get("mode")||"ownership"==this.viz.model.get("mode"))this.viz.model.set("numBars",this.getNumBars(),a);else if(!this.viz.model.get("isTimeSpaced")&&"talk"==this.viz.model.get("mode")||"ownership"==this.viz.model.get("mode"))this.viz.model.set("numDots",this.getNumBars(),a);else if(this.viz.model.get("isTimeSpaced")){var b=_.last(this.viz.model.get("data").get("revisions")).date,c=_.first(this.viz.model.get("data").get("revisions")).date,e=this.xscale.invert(this.sdim.x0),f=this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth);this.viz.model.timeX.rangeRound([0,this.viz.model.get("width")*(b-c)/(f-e)]),this.viz.toTimeSpaced(a)}},getPanOffset:function(){try{if("ownership"==this.viz.model.get("mode"))return this.sdim.x0/(this.dim.w-2*this.handleWidth)*(2*_.size(this.viz.sentences.model.get("revisions"))+1)*this.viz.calcBarWidth();if(!this.viz.model.get("isTimeSpaced")&&"art"==this.viz.model.get("mode"))return this.sdim.x0/(this.dim.w-2*this.handleWidth)*this.viz.model.get("data").get("revisions").length*this.viz.calcBarWidth();if(!this.viz.model.get("isTimeSpaced")&&"talk"==this.viz.model.get("mode"))return this.sdim.x0/(this.dim.w-2*this.handleWidth)*this.viz.model.get("data").get("talk").length*this.viz.calcTalkWidth();if(this.viz.model.get("isTimeSpaced"))return this.viz.model.timeX(this.xscale.invert(this.sdim.x0))}catch(a){}return 0},getNumBars:function(){return this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth)-this.xscale.invert(this.sdim.x0)},getTimeRange:function(){},initBg:function(){this.viz.$("#navctl").empty(),this.sdim={x0:0,w:100},this.svg=d3.select(this.viz.$("#navctl")[0]).append("svg").attr("width",this.dim.w).attr("height",this.dim.h),this.svg.attr("viewBox","0 0 "+this.dim.w+" "+this.dim.h),this.bg=this.svg.append("g").attr("class","bg");var a=this.dim.h/2;this.bg.append("path").attr("d","M"+a+",0 A"+a+","+a+" 0 0,0 "+a+","+2*a).attr("class","pad").attr("width",a).attr("height",this.dim.h),this.bg.append("path").attr("d","M0,0 A"+a+","+a+" 0 0,1 0,"+2*a).attr("class","pad").attr("width",a).attr("height",this.dim.h).attr("transform","translate("+(this.dim.w-a)+",0)"),this.bg.append("g").attr("class","navbars").attr("x",a).attr("transform","translate("+a+","+this.dim.h/2+")scale(1,-1)"),this.bg.select("g.navbars").append("line").attr("class","navctlline").attr("x1",0).attr("y1",0).attr("x2",this.dim.w-2*a).attr("y2",0),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",a).attr("x2",this.dim.w-2*a).attr("y2",a),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",-a).attr("x2",this.dim.w-2*a).attr("y2",-a),this.slider=this.svg.append("g").attr("class","slider"),this.slider.append("rect").attr("class","chandle").attr("width",this.sdim.w-a).attr("height",this.dim.h).attr("x",this.sdim.x0+a),this.slider.append("g").attr("class","lhandlegrp").attr("transform","translate("+this.sdim.x0+",0)").append("path").attr("d","M"+a+",0 A"+a+","+a+" 0 0,0 "+a+","+2*a).attr("class","lhandle").attr("width",a).attr("height",this.dim.h),this.slider.append("g").attr("class","rhandlegrp").attr("transform","translate("+(this.sdim.x0+this.sdim.w)+",0)").append("path").attr("d","M0,0 A"+a+","+a+" 0 0,1 0,"+2*a).attr("class","rhandle").attr("width",a).attr("height",this.dim.h)},initSentenceSpikes:function(){var a=this,b=this.dim.h/2,c=this.viz.sentences.getMaxSentences();this.oxscale=d3.scale.linear(),this.oxscale.domain([0,_.values(this.viz.sentences.model.get("revisions")).length]),this.oxscale.rangeRound([0,this.dim.w-2*b]),this.oyscale=d3.scale.linear(),this.oyscale.domain([0,c]),this.oyscale.rangeRound([1,this.dim.h-1]);var d=(this.dim.w-2*b)/_.values(this.viz.sentences.model.get("revisions")).length;this.bg.select("g.navbars").selectAll("rect.osd").remove(),this.ospikes=this.bg.select("g.navbars").selectAll("rect.osd").data(_.values(this.viz.sentences.model.get("revisions"))),this.ospikes.enter().append("rect").attr("x",function(b,c){return a.oxscale(c)}).attr("y",function(b){return a.oyscale(c/2)-a.oyscale(_.reduce(_.values(b),function(a,b){return a+=_.size(b)},0))}).attr("width",function(){return Math.max(1,d-1)}).attr("height",function(b){return a.oyscale(_.reduce(_.values(b),function(a,b){return a+=_.size(b)},0))}).attr("class","osd").attr("opacity",function(){return"ownership"==a.viz.model.get("mode")?1:0})},init:function(a,c){this.dim={w:a,h:c};var d=this.dim.h/2;this.xscale=d3.scale.linear(),this.xscale.domain([0,this.viz.model.get("data").get("revisions").length]),this.xscale.rangeRound([0,this.dim.w-2*d]),this.yscale=d3.scale.linear(),this.yscale.domain(this.viz.model.get("view").y.domain()),this.yscale.rangeRound([0,this.dim.h/2]);var e=this,f=new Backbone.Collection(classifications.filter(function(a){return a.get("weight")<0})).pluck("id");this.spikewidth=(this.dim.w-2*d)/this.viz.model.get("data").get("revisions").length,this.spikes=this.bg.select("g.navbars").selectAll("rect.sd").data(this.viz.model.get("data").get("revisions")),this.spikes.enter().append("rect").attr("x",function(a,b){return e.xscale(b)}).attr("y",function(a){return-e.yscale(_.reduce(f,function(b,c){return b+Math.abs(a.wclass[c])},0))}).attr("width",function(){return e.spikewidth}).attr("height",function(a){return e.yscale(a.loglev-_.reduce(f,function(b,c){return b+Math.abs(a.wclass[c])},0))+e.yscale(_.reduce(f,function(b,c){return b+Math.abs(a.wclass[c])},0))}).attr("class","sd"),this.dots=this.bg.select("g.navbars").selectAll("circle.td").data(this.viz.model.get("data").get("talk")).enter().append("circle").attr("class","td");var g=5,h=.6;this.dots.filter(function(a){return Math.log(a.lev+1)*h<=g}).attr("r",function(a){return Math.log(a.lev+1)*h}).attr("class","tcircle"),this.sd={dx:0},this.viz.$(".chandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),this.viz.$(".lhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),this.viz.$(".rhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX,a.preventDefault()}),$(b).mousemove($.proxy(function(a){if(this.viz.$(".rhandle").hasClass("dragging")){var b=a.pageX-this.sd.dx;this.sd.dx=a.pageX;var c=+this.sdim.w+b;d>c&&(c=d),c+this.sdim.x0+d>this.dim.w&&(c=this.dim.w-this.sdim.x0-d),this.sdim.w=c,this.viz.$(".chandle").attr("width",this.sdim.w-d),this.viz.$(".rhandlegrp").attr("transform","translate("+ +this.sdim.w+",0)"),this.onScale(),this.onSlide()}if(this.viz.$(".lhandle").hasClass("dragging")){var e=a.pageX-this.sd.dx;0>e&&(e=0),e>this.sdim.x0+this.sdim.w-d&&(e=this.sdim.x0+this.sdim.w-d);var c=+this.sdim.w-(+e-+this.sdim.x0);d>c&&(c=d),this.sdim.x0=e,this.sdim.w=c,this.viz.$(".slider").attr("transform","translate("+this.sdim.x0+",0)"),this.viz.$(".chandle").attr("width",this.sdim.w-d),this.viz.$(".rhandlegrp").attr("transform","translate("+ +this.sdim.w+",0)"),this.onScale(),this.onSlide()}this.viz.$(".chandle").hasClass("dragging")&&(this.sdim.x0=a.pageX-this.sd.dx,this.sdim.x0<0&&(this.sdim.x0=0),this.sdim.x0>this.dim.w-(d+this.sdim.w)&&(this.sdim.x0=this.dim.w-(d+this.sdim.w)),this.viz.$(".slider").attr("transform","translate("+this.sdim.x0+",0)"),"ownership"==this.viz.model.get("mode")?this.viz.sentences.updateSentences():this.onSlide())},this)),$(b).mouseup($.proxy(function(){this.viz.$(".chandle").removeClass("dragging"),this.viz.$(".lhandle").removeClass("dragging"),this.viz.$(".rhandle").removeClass("dragging")},this)),this.handleWidth=d,this.changeMode()}}),NewArticleView=Backbone.View.extend({template:_.template($("#new_article_template").html()),views:new Array,set:new Array,type:"",initialize:function(){this.articleSets=new ArticleSetCollection,this.userSets=new UserSetCollection,this.users=new UserCollection,this.articles=new ArticleCollection,$.when(this.users.fetch(),this.articles.fetch(),this.articleSets.fetch(),this.userSets.fetch()).then($.proxy(function(){this.render()},this));var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0]},events:{"click #initiative .option:not(.disabled)":"clickInitiative","click #set .option:not(.disabled)":"clickDataSet","click #project .option:not(.disabled)":"clickProject","click #analyze button":"clickAnalyze","click #clearFilter":"clearFilter","change #filter":"filter","keyup #filter":"filter","click .class_filter":"classFilter"},getSelected:function(){var a=null;return _.each(this.views,function(b){b.$el.hasClass("selected")&&(a=b.model)}),a},clearFilter:function(){this.$("#filter").attr("value",""),this.filter()},clickInitiative:function(a){this.$("#initiative .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),"none"==this.$("#set").css("display")&&this.$("#initiative .option.selected").length>0?(this.renderDataSets(),this.$("#set").show("slide",400)):"none"!=this.$("#set").css("display")&&0==this.$("#initiative .option.selected").length&&(this.$("#set").hide("slide",400),"none"!=this.$("#project").css("display")&&(this.$("#project").hide("slide",400),"none"!=this.$("#analyze").css("display")&&this.$("#analyze").hide("slide",400)))},clickDataSet:function(a){if(this.$("#set .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),this.$("#set .option.selected").length>0){var b=this.$("#set .option.selected span");b.parent().hasClass("article")?this.renderProjects(this.articles.where({set:parseInt(b.attr("name"))}),"article"):b.parent().hasClass("contributor")&&this.renderProjects(this.users.where({set:parseInt(b.attr("name"))}),"user"),"none"==this.$("#project").css("display")&&this.$("#project").show("slide",400)}else"none"!=this.$("#project").css("display")&&0==this.$("#set .option.selected").length&&(this.$("#project").hide("slide",400),"none"!=this.$("#analyze").css("display")&&this.$("#analyze").hide("slide",400))},clickProject:function(a){this.$("#project .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),"none"==this.$("#analyze").css("display")&&this.$("#project .option.selected").length>0?this.$("#analyze").show("slide",400):"none"!=this.$("#analyze").css("display")&&0==this.$("#project .option.selected").length&&this.$("#analyze").hide("slide",400)},clickAnalyze:function(){var a=this.getSelected(),b=null,c="",d="",e="";if(a instanceof Article)b=new ArticleView({model:a}),c=a.get("title"),d="#ABD1EB",e="#9EC0D9";else{if(!(a instanceof User))return;b=new UserView({model:a}),c=a.get("id"),d="#EEADAD",e="#EE9898"}topTabs.getSelected().set({title:c,mainView:b,color:d,hoverColor:e}),b.render(),topTabsView.render(),this.remove()},renderInitiatives:function(){0==_.size(this.articles.toJSON())&&this.$("#initiative .select").html($("#big_throbber_template").html()),this.$("#initiative").tabs()},renderDataSets:function(){for(var a=b.createDocumentFragment(),c=b.createDocumentFragment(),d=this.views.length;d>=0;d--){var e=this.views[d];e instanceof DataSetView&&(e.remove(),this.views.splice(d,1))}_.each(this.articleSets.models,function(b){var c=new DataSetView({model:b});this.views.push(c),a.appendChild(c.render()[0])},this),_.each(this.userSets.models,function(a){var b=new DataSetView({model:a});this.views.push(b),c.appendChild(b.render()[0])},this),this.$("#set #tabs-project .select").html(a),this.$("#set #tabs-contributor .select").html(c),this.$("#set").tabs()},renderProjects:function(a,c){for(var d=b.createDocumentFragment(),e=this.$("#project #tabs-item .select").detach(),f=this.views.length;f>=0;f--){var g=this.views[f];g instanceof ProjectView&&(g.remove(),this.views.splice(f,1))}this.$("#project #tabs-item .header").after(e),this.set=a,this.type=c,_.each(a,function(a){var b=new ProjectView({model:a});this.views.push(b),d.appendChild(b.el)},this),"user"==c?(this.filterUsers(),$(".footer").show()):$(".footer").hide(),this.filter(),this.$("#project #tabs-item .select").html(d),this.$("#project").tabs()},filter:function(){var a=this.$("#filter").val().toLowerCase();"article"==this.type&&_.each(this.set,function(b){-1!=b.get("title").toLowerCase().indexOf(a)?b.set("display",!0):b.set("display",!1)}),"user"==this.type&&_.each(this.set,function(b){-1!=b.get("id").toLowerCase().indexOf(a)?b.set("display",!0):b.set("display",!1)})},filterUsers:function(){_.each(this.set,function(a){a.isBot()?a.set("filter",!0):a.set("filter",!1)})},filterBots:function(){_.each(this.set,function(a){a.isBot()?a.set("filter",!1):a.set("filter",!0)})},filterAll:function(){_.each(this.set,function(a){a.set("filter",!1)})},classFilter:function(a){var b=a.currentTarget;switch($(".class_filter").not(b).removeClass("selected"),$(b).addClass("selected"),$(b).attr("name")){case"users":this.filterUsers();break;case"bots":this.filterBots();break;case"all":this.filterAll()}},render:function(){return this.$el.html(this.template({count:_.size(this.articles.toJSON())})),this.renderInitiatives(),this.$el}}),DataSetView=Backbone.View.extend({template:_.template($("#dataset_option_template").html()),initialize:function(){this.listenTo(this.model,"change",this.render),this.$el.addClass("option"),this.model instanceof UserSet?this.$el.addClass("contributor"):this.model instanceof ArticleSet&&this.$el.addClass("article"),1==this.model.get("disabled")&&this.$el.addClass("disabled")},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el}}),ProjectView=Backbone.View.extend({article_template:_.template($("#article_option_template").html()),user_template:_.template($("#user_option_template").html()),initialize:function(){this.model instanceof Article?this.el.innerHTML=this.article_template(this.model.toJSON()):this.model instanceof User&&(this.el.innerHTML=this.user_template(this.model.toJSON())),this.listenTo(this.model,"change",this.render),this.$el.addClass("option"),-1==this.model.get("edits")&&this.$el.addClass("disabled")},render:function(){return this.model.get("display")&&!this.model.get("filter")?this.$el.css("display","block"):this.$el.css("display","none"),this.$el}}),SentencesView=Backbone.View.extend({initialize:function(a){this.viz=a.viz,this.listenTo(this.model,"changePos",this.showLoading),this.listenTo(this.model,"sync",this.render),this.model.fetch()},getMaxSentences:function(){return Helper.absMax(_.values(this.model.get("revisions")),function(a){return _.reduce(_.values(a),function(a,b){return a+=b.length},0)})},getMaxSections:function(){return Helper.absMax(_.values(this.model.get("revisions")),function(a){return _.values(a).length})},calcBarWidth:function(){return this.viz.calcBarWidth()},calcBarHeight:function(){return(this.viz.model.get("height")-14)/(this.getMaxSentences()+this.getMaxSections()/2)},calcYPos:function(a,b){var c=0,d=$("#sent_"+a).parents(".revision").attr("data-revid"),e=_.values(this.model.get("revisions")[d]),f=0;return _.each(e,function(d){var e=_.values(d);f+=b/2,_.each(e,function(d){d.i==a&&(c=f),f+=b})}),c},calcSecYPos:function(a,b,c){var d=0,e=this.model.get("revisions")[b],f=0;return _.each(e,function(b,e){e==a&&(d=f);var g=_.values(b);f+=c/2+g.length*c}),d},updateSentences:function(){if("ownership"!=this.viz.model.get("mode"))return!1;var a=this,b=this.viz.model.get("height")-2,c=this.calcBarWidth(),d=this.viz.$("#ownershipvis").scrollTop(),e=this.svg.attr("height");this.svg.attr("height",b*this.model.get("zoomLevel")),this.viz.$("#ownershipvis").scrollTop(d*(this.svg.attr("height")/e)),this.svg.selectAll(".body").attr("transform","translate("+-this.viz.navctl.getPanOffset()+",12) scale("+c+", "+this.model.get("zoomLevel")+")"),this.svg.selectAll(".header").attr("transform","translate("+-this.viz.navctl.getPanOffset()+",0)"),this.svg.selectAll(".header .revision").attr("transform",function(){return"translate("+a.x(2*$(this).attr("data-index")*c)+",11) scale("+c/13+",1)"}),this.updateZoom()},clearAllSelections:function(){this.svg.selectAll(".sentence, .lastSentence, .section, .lastSection").transition().duration(500).attr("opacity",1),$("#section_filter input",this.viz.view.subviews.toolbar.subviews.diag_sections.dialog).prop("checked",!0),$("#userselect2 input",this.viz.view.subviews.toolbar.subviews.diag_select.dialog).prop("checked",!0)},applyUserSelection:function(a){this.svg.selectAll(".sentence, .lastSentence").filter(function(b){return-1!==$.inArray(b.o,a)}).transition().duration(500).attr("opacity",1),this.svg.selectAll(".sentence, .lastSentence").filter(function(b){return-1===$.inArray(b.o,a)}).transition().duration(500).attr("opacity",.2)},buildSentences:function(){var a=this,b=(this.calcBarWidth(),this.calcBarHeight()),c=(this.svg.append("g").attr("class","header"),this.svg.append("g").attr("class","body"),this.svg.selectAll(".body").selectAll(".transitions").data(_.rest(_.values(this.model.get("revisions")))).enter()),e=_.keys(this.model.get("revisions")),f=this.model.get("dates"),g=this.model.get("revUsers"),h=this.svg.selectAll(".body").selectAll(".revision").data(_.values(this.model.get("revisions"))).enter(),i=this.svg.selectAll(".header").selectAll(".revision").data(_.values(this.model.get("revisions"))).enter();c.append("a").attr("class","transition").attr("xlink:href",function(b,c){return"http://en.wikipedia.org/wiki/"+a.viz.model.get("title")+"?diff=next&oldid="+e[c]}).attr("target","_blank").attr("transform",function(b,c){return"translate("+a.x(1+2*c)+", 0)"}),h.append("a").attr("class","revision").attr("data-revid",function(a,b){return e[b]}).attr("xlink:href",function(b,c){return"http://en.wikipedia.org/wiki/"+a.viz.model.get("title")+"?oldid="+e[c]}).attr("target","_blank").attr("transform",function(b,c){return"translate("+a.x(2*c)+", 0)"}),i.append("text").attr("class",$.proxy(function(a,b){return _.contains(this.model.get("vandalism"),parseInt(e[b]))||_.contains(this.model.get("unvandalism"),parseInt(e[b]))?"revision":void 0},this)).attr("transform",function(b,c){return"translate("+a.x(2*c)+", 9)"}).style("font-size","14px").style("cursor","default").attr("data-index",function(a,b){return b}).text($.proxy(function(a,b){return _.contains(this.model.get("vandalism"),parseInt(e[b]))?"☒":_.contains(this.model.get("unvandalism"),parseInt(e[b]))?"☑":void 0},this)).append("title").text($.proxy(function(a,b){return _.contains(this.model.get("vandalism"),parseInt(e[b]))?"Vandalism by "+g[e[b]]:_.contains(this.model.get("unvandalism"),parseInt(e[b]))?"Remove Vandalism by "+g[e[b]]:void 0
},this)),this.svg.selectAll(".header > :not(.revision)").remove();var j=0,k=this.svg.selectAll(".body").selectAll(".revision").selectAll(".section").data(function(a){return d3.entries(a)}).enter(),l=new Array;_.each(_.values(this.model.get("revisions")),function(a){_.each(_.values(a),function(a){_.each(_.values(a),function(a){l[a.i]=a.s})})});var m=this.svg.selectAll(".body").selectAll(".transition").selectAll(".lastSentence").data($.proxy(function(a,b){var c=_.values(this.model.get("revisions")),e=new Array;return c[b]!=d&&(e=_.pluck(_.flatten(_.values(c[b])),"i")),_.filter(_.flatten(_.values(a),!0),function(a){return 0!=a.l&&l[a.l]!=d&&_.contains(e,a.l)})},this)).enter(),n=this.svg.selectAll(".body").selectAll(".transition").selectAll(".lastSection").data(function(b,c){var f=new Array,g=e[c+1],h=e[c],i=a.model.get("revisions")[h],j=_.keys(b);return j=_.filter(j,function(a){return i[a]!=d}),_.each(j,function(a){f.push({s:a,i:g,l:h})}),f}).enter();k.append("g").attr("class","section").attr("opacity",1).attr("transform",function(b,c){0==c&&(j=0);var d="translate(0,"+a.y(j)+")";return j+=_.size(b.value)+.5,d}).append("rect").attr("height",b/2).attr("width",1).attr("fill","black").on("mouseover",function(){d3.select(this).attr("fill","#555555")}).on("mouseout",function(){d3.select(this).attr("fill","#000000")}).append("title").text(function(a){return a.key});var o=this.svg.selectAll(".body").selectAll(".revision").selectAll(".section").selectAll(".sentence").data(function(a){return _.values(a.value)}).enter();o.append("rect").attr("class","sentence").attr("id",function(a){return"sent_"+a.i}).attr("height",Math.max(.5,b-.5)).attr("width",1).attr("opacity",1).attr("transform",function(b,c){return"translate(0,"+a.y(.5+c)+")"}).attr("fill",function(b){return a.model.get("users")[b.o]}).on("mouseover",function(){d3.select(this).attr("fill",function(b){return d3.rgb(a.model.get("users")[b.o]).brighter(.7)})}).on("mouseout",function(){d3.select(this).attr("fill",function(b){return a.model.get("users")[b.o]})}).append("title").text(function(b){return"Owner: "+b.o+"\nDate: "+f[b.r]+"\n"+a.model.get("sentences")[b.s]}),m.append("polygon").attr("class","lastSentence").attr("opacity",1).attr("points",function(c){var d=a.calcYPos(c.l,b),e=d+b,f=a.calcYPos(c.i,b),g=f+b;return"0.00,"+(d+b/5)+" 1.00,"+(f+b/5)+" 1.00,"+(g-b/5)+" 0.00,"+(e-b/5)+" 0.00,"+(d+b/5)+" "}).attr("fill",function(a){return l[a.i]==l[a.l]?"#888888":"#BBBBBB"}).on("mouseover",function(){d3.select(this).attr("fill",function(a){return l[a.i]==l[a.l]?d3.rgb("#888888").brighter(.3):d3.rgb("#BBBBBB").brighter(.3)})}).on("mouseout",function(){d3.select(this).attr("fill",function(a){return l[a.i]==l[a.l]?"#888888":"#BBBBBB"})}),n.append("polygon").attr("class","lastSection").attr("opacity",1).attr("points",function(c){var d=a.calcSecYPos(c.s,c.l,b),e=d+b/2,f=a.calcSecYPos(c.s,c.i,b),g=f+b/2;return"0.00,"+d+" 1.00,"+f+" 1.00,"+g+" 0.00,"+e+" 0.00,"+d+" "}).attr("fill","black").on("mouseover",function(){d3.select(this).attr("fill","#555555")}).on("mouseout",function(){d3.select(this).attr("fill","#000000")}),this.updateSentences(),this.viz.navctl.initSentenceSpikes()},updatePrevNext:function(){"ownership"==this.viz.model.get("mode")&&(this.viz.view.$("#showAll").prop("disabled",!1),0!=this.model.get("start")||this.model.get("nRevisions")>e&&this.model.get("limit")==this.model.get("nRevisions")?this.viz.view.$("#prev").prop("disabled",!1):this.viz.view.$("#prev").prop("disabled",!0),this.model.get("start")+this.model.get("limit")>=this.model.get("nRevisions")?this.viz.view.$("#next").prop("disabled",!0):this.viz.view.$("#next").prop("disabled",!1),this.model.get("limit")>=this.model.get("nRevisions")?this.viz.view.$("#showAll").prop("disabled",!0):this.viz.view.$("#showAll").prop("disabled",!1))},updateZoom:function(){"ownership"==this.viz.model.get("mode")&&(this.viz.view.$("#zoomOut").button(this.model.get("zoomLevel")>1?"enable":"disable"),this.viz.view.$("#zoomIn").button(this.model.get("zoomLevel")<10?"enable":"disable"))},showLoading:function(){this.viz.$("#ownershipvis").append("<div style='position:absolute;top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,0.75);color:#FFFFFF;font-size:12px;padding:5px;'>Loading...</div>")},render:function(){this.updatePrevNext(),this.updateZoom(),this.viz.$("#ownershipvis").unbind("mousewheel DOMMouseScroll"),this.viz.$("#ownershipvis").empty(),this.viz.$("#ownershipvis").css("overflow-y","auto"),this.viz.$("#ownershipvis").css("overflow-x","hidden"),this.svg=d3.select(this.viz.$("#ownershipvis")[0]).append("svg").attr("width",this.viz.model.get("width")).attr("height",this.viz.model.get("height")-2),this.x=d3.scale.linear(),this.y=d3.scale.linear();this.calcBarWidth(),this.calcBarHeight();if(this.x.range([0,1]),this.y.range([0,this.viz.model.get("height")-14]),this.y.domain([0,this.getMaxSentences()+this.getMaxSections()/2]),_.size(this.model.get("users"))>0){dialog=this.viz.view.subviews.toolbar.subviews.diag_select.dialog;var a=this.model.get("users");d3.select($("#userselect2",dialog)[0]).selectAll("div").data(d3.entries(a)).enter().append("div").style("padding","2px 3px 2px 16px").html(function(a){var b='<input style="float:left;margin-right:16px;" type="checkbox" name="userselect2[]" value="'+a.key+'" checked />';return b+='<div class="l_colour" style="background: '+a.value+';height:16px;width:16px;margin-right:16px;"></div>',b+="<span>"+a.key+"</span>"})}var b=this.model.getSections();_.size(b)>0&&(dialog=this.viz.view.subviews.toolbar.subviews.diag_sections.dialog,d3.select($("#section_filter",dialog)[0]).selectAll("div").data(b).enter().append("div").style("padding","2px 3px 2px 16px").html(function(a){var b='<input style="float:left;margin-right:16px;" type="checkbox" name="section_filter[]" value="'+a+'" checked />';return b+="<span>"+a+"</span>"})),this.buildSentences(),this.stopListening(this.viz.model,"change:numBars"),this.stopListening(this.model,"change:zoomLevel"),this.listenTo(this.viz.model,"change:numBars",this.updateSentences),this.listenTo(this.model,"change:zoomLevel",function(){_.defer($.proxy(this.updateSentences,this))}),this.viz.$("#ownershipvis").bind("mousewheel DOMMouseScroll",$.proxy(function(a){var b=a.originalEvent.wheelDelta!=d?a.originalEvent.wheelDelta:-a.originalEvent.detail;b>0?this.model.zoomIn(1.05):this.model.zoomOut(.95),a.preventDefault()},this))}}),ToolbarView=Backbone.View.extend({initialize:function(a){this.template=_.template($("#toolbar_template").html()),Backbone.Subviews.add(this),this.view=a.view},subviewCreators:{diag_cursor:function(){return new DialogView({template:"diag_cursor_template",options:{autoOpen:!1,width:"auto",resizable:!1}})},diag_options:function(){return new DialogView({template:"diag_options_template",options:{autoOpen:!1,resizable:!1}})},diag_select:function(){var a=this.view.wikiviz,b=this.view;return new DialogView({template:"diag_select_template",options:{autoOpen:!1,width:400,resizable:!1},onCreate:function(c){$("#select_apply",c).button(),$("#select_all",c).button(),$("#unselect_all",c).button(),$("#d_select_tabs",c).tabs(),$("#d_select_groups_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$("#d_select_groups_accordion h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_select_groups_accordion h3",c).each(function(d,e){$(e).find("input").change(function(){var d=$(this);$(this).is(":checked")?(a.get("view").data.selectAll(".datum").filter(function(a){return a.group==d.val()}).transition().duration(500).attr("opacity",1),"ownership"!=a.get("mode")&&b.viz.navctl.bg.selectAll("rect").filter(function(a){return a.group==d.val()}).transition().duration(500).attr("opacity",1),b.viz.sentences.svg.selectAll(".sentence, .lastSentence").filter(function(b){return a.getGroupsByName(b.o)==d.val()||_.contains(a.getGroupsByName(b.o),d.val())}).transition().duration(500).attr("opacity",1)):(a.get("view").data.selectAll(".datum").filter(function(a){return a.group==d.val()}).transition().duration(500).attr("opacity",.2),"ownership"!=a.get("mode")&&b.viz.navctl.bg.selectAll("rect").filter(function(a){return a.group==d.val()}).transition().duration(500).attr("opacity",.2),b.viz.sentences.svg.selectAll(".sentence, .lastSentence").filter(function(b){return a.getGroupsByName(b.o)==d.val()||_.contains(a.getGroupsByName(b.o),d.val())}).transition().duration(500).attr("opacity",.2)),$("#t_deselect",c).button("enable")})}),$("input[name=userclassselect]",c).each(function(b,d){$(d).change(function(){var b=Array();$("input[name=userclassselect]:checked",c).each(function(a,c){b.push($(c).val())}),$("#userselect option, #userselect2 input",c).each(function(c,d){Helper.isSubset([a.getGroupsByName($(d).val())],b)?($(d).attr("selected",!0),$(d).prop("checked",!0)):($(d).attr("selected",!1),$(d).prop("checked",!1)),$(d).addClass("invisible"),$(d).removeClass("invisible")})})}),$("#select_apply",c).click(function(){var a=Array();$("#userselect:visible option:selected, #userselect2:visible input:checked",c).each(function(){a.push($(this).val())}),b.viz.applyUserSelection(a)}),$("#userselect2",c).click(function(){var a=Array();$("#userselect:visible option:selected, #userselect2:visible input:checked",c).each(function(){a.push($(this).val())}),b.viz.applyUserSelection(a)}),$("#select_all",c).click(function(){$("#userselect2 input",c).each(function(a,b){$(b).prop("checked",!0)}),$("#userselect2",c).trigger("click")}),$("#unselect_all",c).click(function(){$("#userselect2 input",c).each(function(a,b){$(b).prop("checked",!1)}),$("#userselect2",c).trigger("click")})}})},diag_articles:function(){var a=this.view.wikiviz,b=this.view;return new DialogView({template:"diag_articles_template",options:{autoOpen:!1,width:400,resizable:!1},onCreate:function(c){$("#select_apply",c).button(),$("#d_select_tabs",c).tabs(),$("#d_select_groups_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$("#d_select_groups_accordion h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_select_groups_accordion h3",c).each(function(b,d){$(d).find("input").change(function(){var b=$(this);$(this).is(":checked")?a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",1):a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",.2),$("#t_deselect",c).button("enable")})}),$("input[name=userclassselect]",c).each(function(b,d){$(d).change(function(){var b=Array();$("input[name=userclassselect]:checked",c).each(function(a,c){b.push($(c).val())}),$("#userselect option, #userselect2 input",c).each(function(c,d){Helper.isSubset([a.getGroupsByName($(d).val())],b)?($(d).attr("selected",!0),$(d).prop("checked",!0)):($(d).attr("selected",!1),$(d).prop("checked",!1)),$(d).addClass("invisible"),$(d).removeClass("invisible")})})}),$("#select_apply",c).click(function(){var a=Array();$("#userselect:visible option:selected, #userselect2:visible input:checked",c).each(function(){a.push($(this).val())}),b.viz.applyUserSelection(a)})}})},diag_sections:function(){var a=(this.view.wikiviz,this.view);return new DialogView({template:"diag_sections_template",options:{autoOpen:!1,width:400,resizable:!1},onCreate:function(b){$("#select_all",b).button(),$("#unselect_all",b).button(),$("#section_filter",b).click(function(){$("input",$(this)).each(function(){var b=$(this);$(this).is(":checked")?a.viz.sentences.svg.selectAll(".section, .lastSection").filter(function(a){return a.key==b.val()||a.s==b.val()}).transition().duration(500).attr("opacity",1):a.viz.sentences.svg.selectAll(".section, .lastSection").filter(function(a){return a.key==b.val()||a.s==b.val()}).transition().duration(500).attr("opacity",.2),$("#t_deselect",a.viz.$el).button("enable")})}),$("#select_all",b).click(function(){$("#section_filter input",b).each(function(a,b){$(b).prop("checked",!0)}),$("#section_filter",b).trigger("click")}),$("#unselect_all",b).click(function(){$("#section_filter input",b).each(function(a,b){$(b).prop("checked",!1)}),$("#section_filter",b).trigger("click")})}})},diag_info:function(){return new DialogView({template:"diag_info_template",options:{autoOpen:!1,resizable:!1,width:400}})},diag_data:function(){return new DialogView({template:"diag_data_template",options:{autoOpen:!1,resizable:!0,width:800,height:600}})},diag_legend:function(){var a=this.view.wikiviz,b=this.view;return new DialogView({template:"diag_legend_template",options:{autoOpen:!1,resizable:!1,height:"auto",width:400},onCreate:function(c){$("#d_legend_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$(".d_checkable h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})});var e={};classifications.each(function(a){e[a.get("codna")]==d&&(e[a.get("codna")]=new Array),e[a.get("codna")].push(a.get("id"))}),e.addrem=["b","e"],e.vandunvand=["i","j"],$("#d_legend_accordion h3",c).each(function(f,g){$(g).find("input").change(function(){if($(this).is(":checked"))for(var f in e[$(this).val()])a.get("view").data.selectAll("rect."+e[$(this).val()][f]).transition().duration(500).attr("opacity",1);else for(var f in e[$(this).val()])a.get("view").data.selectAll("rect."+e[$(this).val()][f]).transition().duration(500).attr("opacity",.2);var g=new Array;$("#d_legend_accordion input:checked",c).each(function(a,b){e[$(b).val()]!=d&&$.merge(g,e[$(b).val()])}),b.viz.navctl.bg.selectAll("rect").transition().duration(500).attr("opacity",function(a){var b=.2;return $(g).each(function(c,d){return a.wclass[d]?(b=1,1):void 0}),b}),$("#t_deselect",c).button("enable")})})}})},diag_talk:function(){return new DialogView({template:"diag_talk_template",options:{autoOpen:!1,resizable:!1,height:"auto",width:400},onCreate:function(a){$("#d_talk_accordion",a).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$(".d_checkable h3",a).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_talk_accordion h3",a).each(function(b,c){$(c).find("input").change(function(){var b=$(this);$(this).is(":checked")?d3.selectAll(".tdatum ."+b.val()).transition().duration(500).attr("opacity",1):d3.selectAll(".tdatum ."+b.val()).transition().duration(500).attr("opacity",.2),$("#t_deselect",a).button("enable")})})}})}},createToolbar:function(){$("#t_cursor").button({icons:{primary:"ui-icon-arrow-1-ne"},text:!1}),$("#t_options").button({icons:{primary:"ui-icon-gear"},text:!1}),this.$("#t_select").button({icons:{primary:"icon-users"},text:!1}),this.$("#t_articles").button({icons:{primary:"icon-articles"},text:!1}),this.$("#t_sections").button({icons:{primary:"icon-sections"},text:!1}),$("#t_info").button({icons:{primary:"ui-icon-info"},text:!1}),this.$("#t_data").button({icons:{primary:"icon-table"},text:!1}),this.$("#t_legend").button({icons:{primary:"icon-categories"},text:!1}),this.$("#t_deselect").button({icons:{primary:"icon-deselect"},text:!1,disabled:!0}),this.$("#t_talk").button({icons:{primary:"icon-talk"},text:!1,disabled:!0})},events:{"click #t_cursor":function(){this.subviews.diag_cursor.open()},"click #t_options":function(){this.subviews.diag_options.open()},"click #t_select":function(){this.subviews.diag_select.open()},"click #t_articles":function(){this.subviews.diag_articles.open()},"click #t_sections":function(){this.subviews.diag_sections.open()},"click #t_info":function(){this.subviews.diag_info.open()},"click #t_data":function(){this.subviews.diag_data.open()},"click #t_legend":function(){this.subviews.diag_legend.open()},"click #t_deselect":function(){$("#userselect2 input").prop("checked",!1),this.view.viz.clearAllSelections(!0)},"click #t_talk":function(){this.subviews.diag_talk.open()}},render:function(){return this.$el.html(this.template(this.model)),this.createToolbar(),this.$el}}),TopTabsView=Backbone.View.extend({views:new Array,initialize:function(){this.listenTo(this.model,"add",this.render),this.listenTo(this.model,"remove",this.render),$(a).resize($.proxy(this.render,this))},order:function(){this.model.sort();var a=TopTabsView.leftMargin,b=($("#content").outerWidth(!0)-30-30-30-TopTabsView.spacing)/(this.model.length-1)-25-10-TopTabsView.spacing,c=0,d=0;this.model.each(function(e,f){var g=e.get("x");e.set("x",a,{silent:!0});if("new"!=e.get("type")){c+=b+25+10+5,d+=Math.max(5,Math.min(150,Math.round(b)))+25+10+5;var h=c-d;d+=h,this.$("#tab_"+e.cid).css("max-width",Math.max(5,Math.min(150,Math.round(b)+h)))}a+=Math.round(this.$("#tab_"+e.cid).outerWidth(!0))+TopTabsView.spacing,g!=e.get("x")&&this.views[f].updatePosition()},this)},render:function(){return _.each(this.views,function(a){a.remove()}),this.views=new Array,this.$el.empty(),this.model.each(function(a){var b=new TopTabView({model:a});this.$el.append(b.render()),"tab"==a.get("type")&&b.$el.draggable({axis:"x",start:$.proxy(function(){b.$el.css("z-index",1e3)},this),drag:$.proxy(function(){a.set("x",parseInt(b.$el.css("left")),{silent:!0}),this.order()},this),stop:$.proxy(function(){b.$el.css("z-index",0),this.order(),this.render()},this)}),this.views.push(b)},this),this.order(),this.$el}}),TopTabsView.leftMargin=15,TopTabsView.spacing=5,TopTabView=Backbone.View.extend({template:_.template($("#top_tab_template").html()),initialize:function(){this.listenTo(this.model,"change",this.render)},events:{mouseover:"hover",mouseout:"unhover","click .x":"close",click:"click"},hover:function(){this.model.get("selected")&&this.$el.css("border-bottom","1px solid #FFFFFF"),this.$el.css("background-color",this.model.get("hoverColor"))},unhover:function(){this.model.get("selected")?this.$el.css("border-bottom","1px solid #FFFFFF"):this.$el.css("border-bottom","1px solid #AAAAAA"),this.$el.css("background-color",this.model.get("color"))},click:function(a){if("new"==this.model.get("type")){var b=new TopTab({title:"New Tab",mainView:new NewArticleView({model:articles})}),c=_.last(topTabsView.views).model.get("x");topTabs.add(b),topTabsView.order();var d=topTabs.getSelected();null!=d&&d!=this.model&&d.set("selected",!1),b.set("selected",!0),$("#tab_"+b.cid).css("display","none"),$("#tab_"+b.cid).show("slide",200),_.last(topTabsView.views).$el.css("left",c),_.last(topTabsView.views).$el.animate({left:b.get("x")+$("#tab_"+b.cid).outerWidth(!0)+TopTabsView.spacing},200)}else if(!$(a.target).hasClass("x")){var d=topTabs.getSelected();null!=d&&d!=this.model&&d.set("selected",!1),this.model.get("selected")||this.model.set("selected",!0)}},close:function(){var a=!1;_.each(topTabsView.views,function(b){a&&b.$el.animate({left:b.model.get("x")-this.$el.outerWidth(!0)-TopTabsView.spacing},200),b==this&&(a=!0)},this),this.model.set("selected",!1),this.model.get("mainView").remove(),this.$el.hide("slide",200,$.proxy(function(){topTabs.remove(this.model),topTabs.at(topTabs.length-2)&&topTabs.at(topTabs.length-2).set("selected",!0)},this))},updatePosition:function(){this.$el.css("left",this.model.get("x"))},render:function(){return this.$el.html(this.template(this.model.toJSON())),"new"==this.model.get("type")&&this.$el.addClass("tab_new"),this.$el.addClass("tab"),this.$el.stop(),this.updatePosition(),this.$el.attr("id","tab_"+this.model.cid),this.model.get("selected")?(this.$el.addClass("selected"),this.$el.css("border-bottom","1px solid #FFFFFF")):(this.$el.removeClass("selected"),this.$el.css("border-bottom","1px solid #AAAAAA")),this.$el.css("background-color",this.model.get("color")),this.$el}}),UserInfoView=Backbone.View.extend({initialize:function(a){this.user=a.user,this.listenTo(this.model,"sync",this.render),this.listenTo(this.model.get("data"),"sync",this.render),this.template=_.template($("#user_info_template").html())},render:function(){return this.$el.html(this.template(_.extend(this.user.toJSON(),this.model.toJSON()))),this.$el.attr("id","article_info"),this.$el}}),UserView=Backbone.View.extend({template:_.template($("#user_container_template").html()),wikiviz:null,navctl:null,initialize:function(){this.wikiviz=new WikiViz({user:this.model.get("id"),set:this.model.get("set")});var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0],Backbone.Subviews.add(this)},subviewCreators:{user_info:function(){return new UserInfoView({model:this.wikiviz,user:this.model})},toolbar:function(){return new ToolbarView({model:{buttons:["articles","data","legend","deselect","talk"]},view:this})}},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.viz=new WikiVizView({model:this.wikiviz,view:this,el:this.el}),this.viz.init(this.model.get("title")),this.$el}}),WikiVizView=Backbone.View.extend({mouseX:0,mouseY:0,initialize:function(b){this.listenTo(this.model.get("data"),"sync",this.initViz),this.navctl=new NavCtlView({viz:this}),this.sentences=new SentencesView({model:new Sentences({articleId:this.model.get("article_id"),setId:this.model.get("set")}),viz:this}),this.view=b.view,this.listenTo(this.model,"change:width",$.proxy(function(){this.initViz(),this.buildMonths(),this.sentences.render()},this)),this.listenTo(this.model,"change:height",$.proxy(function(){this.initViz(),this.buildMonths(),this.sentences.render()},this)),this.listenTo(this.model,"change:numDots",this.updateDots),this.listenTo(this.model,"change:numBars",this.updateBars),this.listenTo(this.model,"change:mode",this.updateMode),this.listenTo(this.model,"change:isTimeSpaced",this.updateSpacing),this.$el.click($.proxy(function(a){$(a.target).hasClass("quality")||$(a.target).hasClass("event")||this.$(".tooltip").hide()},this)),this.$("#view").mousemove($.proxy(function(a){this.mouseX=a.offsetX==d?a.originalEvent.layerX:a.offsetX,this.mouseY=a.offsetY==d?a.originalEvent.layerY:a.offsetY},this)),$(a).resize($.proxy(function(){if(this.$("#view").width()>0||this.$("#ownershipvis").width()>0){var a=Math.max(this.$("#view").width(),this.$("#ownershipvis").width()),b=Math.max(this.$("#view").height(),this.$("#ownershipvis").height());this.model.set("width",a),this.model.set("height",b)}},this))},calcBarWidth:function(){var a;if("ownership"==this.model.get("mode")){var b=this.model.get("width");this.sentences.model.get("zoomLevel")>1&&(b-=$.scrollbarWidth()+1),a=b/(this.model.get("numBars")*(_.size(this.sentences.model.get("revisions"))/this.sentences.model.get("nRevisions"))*2-1)}else a=(this.model.get("width")-this.model.get("maskWidth"))/this.model.get("numBars");return this.model.get("isTimeSpaced")&&(a=Math.min(a,7)),a},calcTalkWidth:function(){var a=(this.model.get("width")-this.model.get("maskWidth"))/this.model.get("numDots");return a},getAdjacentTalkWidth:function(){return 70*this.model.get("data").get("talk").length},getOffset:function(a){return this.model.get("isTimeSpaced")?this.model.get("data").get("revisions")[a].dateOffset:a*this.calcBarWidth()},getCalloutHeight:function(a){var b=0,c=29;return 0!==a.att&&null!==a.att&&(b+=c),0!==a.crit&&null!==a.crit&&(b+=c),0!==a.inf&&null!==a.inf&&(b+=c),0!==a.perf&&null!==a.perf&&(b+=c),b},genCalloutImageSet:function(a){var b=[];return 0!==a.att&&null!==a.att&&b.push("att"),0!==a.crit&&null!==a.crit&&b.push("crit"),0!==a.inf&&null!==a.inf&&b.push("inf"),0!==a.perf&&null!==a.perf&&b.push("perf"),b},updateInfo:function(a){this.$("#d_info_noselection").addClass("invisible"),this.$("#d_info_selection").empty();var b=0;this.$("#d_info_selection").append($("<table>"));for(p in a)a.hasOwnProperty(p)&&(++b,this.$("#d_info_selection table").append($("<tr>").append($("<td>").text(p)).append($("<td>").text(a[p].toString()))));0==b&&(this.$("#d_info_selection").empty(),this.$("#d_info_noselection").removeClass("invisible"))},clearMonths:function(){this.model.get("view").body.select(".bg").selectAll(".month").data([]).exit().remove()},update:function(){"art"==this.model.get("mode")?this.updateBars():"talk"==this.model.get("mode")?this.updateDots():"hybrid"==this.model.get("mode")&&(this.updateBars(),this.updateDots())},updateDots:function(){this.model.get("view").tx.range([0,this.calcTalkWidth()]),this.model.get("isTimeSpaced")||this.model.get("view").tdata.selectAll(".tdatum").attr("transform",$.proxy(function(a,b){return"translate("+this.model.get("view").tx(b)+", 0)"},this)),this.buildMonths()},updateBars:function(){if("ownership"==this.model.get("mode"))return!1;var a=this.calcBarWidth();this.model.get("view").x.range([0,a]),this.model.get("isTimeSpaced")||this.model.get("view").data.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.model.get("view").x(this.model.index(a))+", 0)"},this)),this.model.get("view").data.selectAll(".datum").selectAll(".bars rect").attr("width",a);try{}catch(b){}this.buildMonths()},applyUserSelection:function(a){"ownership"!=this.model.get("mode")&&this.clearAllSelections(),this.$("#t_deselect").button("enable"),$("#diag_legend input").attr("disabled","disabled"),$("#d_select_groups_accordion input").attr("disabled","disabled");var b={};b["Number of Selected Users"]=a.length,b["User Groups"]=[];for(var c=0;c<a.length;++c)-1==jQuery.inArray(this.model.getGroupsByName(a[c]),b["User Groups"])&&b["User Groups"].push(this.model.getGroupsByName(a[c]));this.updateInfo(b),$("#diag_data table tbody").children("tr").each(function(b,c){$(c).removeClass("rowselect"),-1!=jQuery.inArray($(c).children(":eq(2)").text(),a)&&$(c).addClass("rowselect")}),("art"==this.model.get("mode")||"hybrid"==this.model.get("mode"))&&(this.model.get("view").data.selectAll(".datum").filter(function(b){return-1===jQuery.inArray(b.user,a)}).selectAll(".bars rect").transition().duration(500).attr("opacity",.2),this.navctl.spikes.filter(function(b){return-1===jQuery.inArray(b.user,a)}).transition().duration(500).attr("opacity",.4)),this.sentences.applyUserSelection(a)},clearAllSelections:function(){this.$("#t_deselect").button("disable"),this.updateInfo({}),this.$("#diag_data table tbody tr").each(function(a,b){$(b).removeClass("rowselect")}),this.$("#d_legend_accordion input").attr("checked","checked"),$("#d_select_groups_accordion input").attr("checked","checked"),("art"==this.model.get("mode")||"hybrid"==this.model.get("mode"))&&(this.model.get("view").data.selectAll(".bars rect").transition().duration(500).attr("opacity",1),this.model.get("view").data.selectAll(".datum").transition().duration(500).attr("opacity",1),this.navctl.spikes.transition().duration(500).attr("opacity",1)),this.sentences.clearAllSelections(),$("#diag_legend input").prop("disabled",!1),$("#d_select_groups_accordion input").prop("disabled",!1)},toTimeSpaced:function(a){a=a!=d?a:{},d3.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.model.timeX(a.date)+",0)"},this)).selectAll(".bars rect").attr("width",this.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",$.proxy(function(a){return"translate("+this.model.timeX(a.date)+",0)"},this)),a.silent||this.buildMonths(),"talk"==this.model.get("mode")&&d3.selectAll(".month").attr("opacity",1)},toAdjacentSpaced:function(a){a=a!=d?a:{},"talk"==this.model.get("mode")&&d3.selectAll(".month").attr("opacity",0),d3.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.model.get("view").x(this.model.index(a))+",0)"},this)).selectAll(".bars rect").attr("width",this.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",$.proxy(function(a,b){return"translate("+this.model.get("view").tx(b)+",0)"},this)),a.silent||this.buildMonths()},buildBars:function(a,b){for(var c=new Backbone.Collection(classifications.filter(function(a){return a.get("weight")>=0})).pluck("id"),d=new Backbone.Collection(classifications.filter(function(a){return a.get("weight")<0})).pluck("id"),e=this.model.get("view").y,f=this.model.index,g=[],h=0;h<this.model.get("data").get("revisions").length;++h)g[h]=0;_.each(c,function(c){a.filter(function(a){return a.wclass[c]>1e-4}).append("rect").attr("y",function(a){return.8*e(g[f(a)])}).attr("width",b).attr("height",function(a){return.8*e(a.wclass[c])}).attr("class",c).attr("desc",f).attr("opacity",1);for(var d=0;d<this.model.get("data").get("revisions").length;++d)g[d]+=this.model.get("data").get("revisions")[d].wclass[c]},this);for(var h=0;h<this.model.get("data").get("revisions").length;++h)g[h]=0;_.each(d,function(c){a.filter(function(a){return a.wclass[c]>1e-4}).append("rect").attr("y",function(a){return.8*-e(a.wclass[c]+g[f(a)])}).attr("width",b).attr("height",function(a){return.8*e(a.wclass[c])}).attr("class",c).attr("desc",f).attr("opacity",1);for(var d=0;d<this.model.get("data").get("revisions").length;++d)g[d]+=this.model.get("data").get("revisions")[d].wclass[c]},this)},buildMonths:function(){var a=this,b=(this.calcBarWidth(),this.model.get("data").get("revisions")),c=Array(),d=Array(),e=Array(),f=10,g=[],h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(this.model.get("isTimeSpaced")){for(var i,j=!0,k=this.model.timeX,l=_.first(this.model.get("data").get("revisions")).date.getMonth(),m=_.first(this.model.get("data").get("revisions")).date.getFullYear();l<=_.last(this.model.get("data").get("revisions")).date.getMonth()||m<=_.last(this.model.get("data").get("revisions")).date.getFullYear();++l){l>11&&(l=0,++m),j&&(i=0==l?new Date(m-1,0,1):new Date(m,l-1,1),j=!1);var n=new Date(m,l,1);g.push({l:k(i),r:k(n),m:i.getMonth(),y:i.getFullYear()}),i=n}_.each(this.model.get("data").get("quality"),function(a){var b=new Date(a.cutoff);b=new Date(b.getTime()+864e5),c.push({l:k(b),q:a})}),_.each(this.model.get("data").get("events"),function(a){var b=new Date(a.timestamp);d.push({l:k(b),e:a})}),_.each(this.model.get("data").get("google"),function(a){var b=new Date(a.timestamp);e.push({l:k(b),g:a})})}else{for(var o,p=new Date(_.last(b).timestamp),q=new Date(_.first(b).timestamp),r=0,s=(_.first(this.model.get("data").get("revisions")),this.model.get("data").get("quality")),t=this.model.get("data").get("events"),u=this.model.get("data").get("google"),v=0,w=0,x=0,y=1;y<b.length;++y){if(o=new Date(b[y].timestamp),o.getMonth()!==q.getMonth()||o.getYear()!==q.getYear()){var z=this.getOffset(r),A=this.getOffset(y);if(z===A)continue;g.push({l:z,r:A,m:q.getMonth(),y:q.getFullYear()}),q=o,r=y}for(var B=v;B<s.length;B++){var C=s[B],D=new Date(C.cutoff);if(D=new Date(D.getTime()+864e5),!(o>=D||p.valueOf()==o.valueOf()))break;v=B+1,c[B]={l:this.getOffset(y+.5),q:C}}for(var E=w;E<t.length;E++){var F=t[E],G=new Date(F.timestamp);if(!(o>=G))break;w=E+1,d[E]={l:this.getOffset(y+.5),e:F}}for(var H=x;H<u.length;H++){var I=u[H],G=new Date(I.timestamp);if(!(o>=G||p.valueOf()==o.valueOf()))break;x=H+1,e[H]={l:this.getOffset(y+.5),g:I}}}var z=this.getOffset(r),A=this.getOffset(b.length);g.push({l:z,r:A,m:q.getMonth(),y:q.getFullYear()})}var J=this.model.get("view").body.select(".bg"),K=J.selectAll(".months").selectAll(".month").data(g).enter(),L=K.append("g").attr("class","month").attr("transform",function(a){return"translate("+a.l+",0)"});L.append("rect").attr("height",String(this.model.get("height"))).attr("width",function(a){return a.r-a.l}).attr("class",function(a,b){return b%2===0?"m_odd":"m_even"}).attr("y",String(-this.model.get("height")/2)),L.append("text").attr("class","mtext").text(function(a){return h[a.m]}).attr("transform","translate(5,"+(this.model.get("height")/2-15)+")scale(1,-1)").attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<f}).attr("opacity",0),L.append("text").attr("class","ytext").text(function(a){return String(a.y)}).attr("transform","translate(5,"+(this.model.get("height")/2-30)+")scale(1,-1)").attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<f}).attr("opacity",0),mts=this.model.get("view").body.selectAll(".month").data(g);var M=mts;M.attr("transform",function(a){return"translate("+a.l+",0)"}),M.select("rect").attr("width",function(a){return a.r-a.l}),mts.select("text.mtext").text(function(a){return h[a.m]}),mts.select("text.ytext").text(function(a){return String(a.y)
}),M.select("rect").attr("class",function(a,b){return b%2===0?"m_odd":"m_even"}),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<f}).attr("opacity",0),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=f}).attr("opacity",1),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<f}).attr("opacity",0),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=f}).attr("opacity",1),this.repositionBar();var N=0,O=-(this.model.get("height")/2),P=J.selectAll(".bar").selectAll(".google").data(e).enter(),Q=this.model.get("height")/2;P.append("line").attr("class","google"),J.selectAll(".google").attr("x1",function(a){var b=N;return N=a.l,b}).attr("y1",function(a){var b=O;return O=-Q+35*(a.g.value/100),b}).attr("x2",function(a){return a.l}).attr("y2",function(a){return-Q+35*(a.g.value/100)});var R=8,P=J.selectAll(".bar").selectAll(".quality").data(c).enter();P.append("circle").attr("class","quality"),J.selectAll(".quality").attr("r",R).attr("transform",function(a){return"translate("+(a.l-R)+",-"+(Q-2*R)+")"}).attr("fill","#2C5C7D").on("click",function(b){var c="quality-"+b.q.cuttoff,d=a.$("#"+c);if(a.$(".tooltip").not(d).hide(),0==d.length){var e="<table>";_.each(b.q.description,function(a,b){e+="<tr><td align='right'>"+b+":&nbsp;</td><td>"+a+"</td></tr>"}),e+="<tr><td colspan='2'>"+Helper.formatDate(new Date(b.q.cutoff),!1)+"</td></tr>","CoDNA"==b.q.metric&&(e+="<tr><td colspan='2'><a style='float:right;' href='http://dl.acm.org/citation.cfm?id=2069609' target='_blank'>Source</a></td></tr>"),e+="</table>";var d=$(_.template($("#tooltip_template").html())({title:"CoDNA Ranking",text:e,uid:c}));a.$("#view").append(d),d=a.$("#"+c)}d.toggle();var f=d.outerHeight(!0),g=d.outerWidth(!0);d.css("left",10*Math.floor((a.mouseX-g/2)/10)).css("top",10*Math.floor((a.mouseY-2*R-f)/10))});var R=8,P=J.selectAll(".bar").selectAll(".event").data(d).enter();P.append("circle").attr("class","event"),J.selectAll(".event").attr("r",R).attr("transform",function(a){return"translate("+a.l+",-"+(Q-2*R)+")"}).attr("fill","#8B2C0D").on("click",function(b){var c="event-"+b.e.cuttoff,d=a.$("#"+c);if(a.$(".tooltip").not(d).hide(),0==d.length){var d=$(_.template($("#tooltip_template").html(),{title:b.e.title,text:b.e.description+"<br />Date:&nbsp;"+Helper.formatDate(new Date(b.e.timestamp),!1),uid:c}));a.$("#view").append(d),d=a.$("#"+c)}d.toggle();var e=d.outerHeight(!0),f=d.outerWidth(!0);d.css("left",10*Math.floor((a.mouseX-f/2)/10)).css("top",10*Math.floor((a.mouseY-2*R-e)/10))});var S=mts.exit();S.attr("opacity",0).remove()},repositionBar:function(){if("ownership"==this.model.get("mode"))return!1;this.$(".tooltip").hide();var a=this.model.get("view").body.select(".bg"),b=a.selectAll(".bar_bg");b.attr("transform","translate("+(-50+this.navctl.getPanOffset())+",-"+this.model.get("height")/2+")")},appendCallout:function(a){var b=24,c=10,d=10,e=10,f=10,g=5,h=10,i=1.2;a.filter(function(a){return Math.log(a.lev+1)*i<=h}).append("circle").attr("r",function(a){return Math.log(a.lev+1)*i}).attr("class","tcircle"),a.filter(function(a){return Math.log(a.lev+1)*i>h}).append("circle").attr("r",h).attr("class","tcircle_full");var j=this,k=a.filter(function(a){return 0!=j.genCalloutImageSet(a).length});k.append("title").text(function(a){return"User: "+a.contributor+"\n"+Helper.formatDate(a.date)+"\nRevision Categories: "+Helper.toTalkClassString(a)+"\nRevision Size: "+a.lev});var l=k.append("path");l.attr("d",$.proxy(function(a){return"M 0 0 l {0} {1} l 0 {2} a {3} {3} 0 0 0 {3} {3} l {4} 0 a {3} {3} 0 0 0 {3} -{3} l 0 -{5} a {3} {3} 0 0 0 -{3} -{3} l -{6} 0 z".format(e,f,this.getCalloutHeight(a)+2*c-2*g,g,b+2*d-g,this.getCalloutHeight(a)+2*c-g-10,b+2*d-2*g)},this)),l.attr("class","callout");var m=k.append("g").attr("class","igroup").attr("transform","translate("+(e+c)+","+(f+d)+")scale(1,-1)").datum($.proxy(function(a){return this.genCalloutImageSet(a)},this));m.each(function(a){d3.select(this).selectAll("image").data(a).enter().append("image").attr("xlink:href",function(a){return"img/"+a+".png"}).attr("y",function(a,b){return-29*b-24}).attr("width",24).attr("height",24).attr("x",3).attr("class",function(a){return a})}),k.append("text").attr("class","xlabel").text($.proxy(function(a,b){return 0==this.genCalloutImageSet(a).length?"":b+1},this)).attr("transform",function(){return"translate("+(e+c/2)+","+(f+d/2)+")scale(1,-1)"})},updateSpacing:function(a){a=a!=d?a:{},this.model.get("isTimeSpaced")?(this.navctl.toTimeSpaced(),this.toTimeSpaced(a)):(this.navctl.toAdjacentSpaced(),this.toAdjacentSpaced(a)),a.silent||this.update()},updateMode:function(a){if(a=a!=d?a:{},"art"==this.model.get("mode")){this.$("#view").appendTo(this.$("#artview")),this.model.get("view").data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",0),d3.selectAll(".tcircle").attr("opacity",0),this.$("#t_sections").button("disable"),this.$("#t_legend").button("enable"),this.$("#t_talk").button("disable"),this.view.$("#prev").prop("disabled",!0),this.view.$("#showAll").prop("disabled",!0),this.view.$("#next").prop("disabled",!0),this.view.$("#zoomOut").prop("disabled",!0),this.view.$("#zoomIn").prop("disabled",!0),this.$("#toAdj").button("enable"),d3.selectAll(".month").attr("opacity",1),this.model.get("isTimeSpaced")===!1?(this.$("#toAdj").button("disable"),this.$("#toTime").button("enable"),a.silent||this.navctl.toAdjacentSpaced()):(this.$("#toAdj").button("enable"),this.$("#toTime").button("disable"),a.silent||this.navctl.toTimeSpaced()),a.silent||this.navctl.onScale();var b=this.view.subviews.toolbar.subviews.diag_data.dialog;$("#userselect",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),$("#userselect2",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$(".select_apply_div",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),$(".select_all_div",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$(".talkrow",b).addClass("invisible"),$(".defaultrow",b).removeClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, -500)"),d3.selectAll("g.ylabel").attr("opacity",1)}else if("talk"==this.model.get("mode")){this.$("#view").appendTo(this.$("#talkview")),this.model.get("view").data.selectAll(".datum").attr("opacity",0),d3.selectAll(".sd").attr("opacity",0),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),this.$("#t_sections").button("disable"),this.$("#t_legend").button("disable"),this.$("#t_talk").button("enable"),this.view.$("#prev").prop("disabled",!0),this.view.$("#showAll").prop("disabled",!0),this.view.$("#next").prop("disabled",!0),this.view.$("#zoomOut").prop("disabled",!0),this.view.$("#zoomIn").prop("disabled",!0),this.model.get("isTimeSpaced")===!1?(d3.selectAll(".month").attr("opacity",0),this.$("#toAdj").button("disable"),this.$("#toTime").button("enable"),a.silent||this.navctl.toAdjacentSpaced()):(this.$("#toAdj").button("enable"),this.$("#toTime").button("disable"),a.silent||this.navctl.toTimeSpaced()),a.silent||this.navctl.onScale();var b=this.view.subviews.toolbar.subviews.diag_data.dialog;$("#userselect",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),$("#userselect2",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$(".select_apply_div",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),$(".select_all_div",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$(".talkrow",b).removeClass("invisible"),$(".defaultrow",b).addClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",0)}else if("hybrid"==this.model.get("mode")){this.$("#view").appendTo(this.$("#hybridview")),this.model.get("view").data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),this.$("#t_legend").button("enable"),this.$("#t_talk").button("enable"),this.$("#t_sections").button("disable"),this.$("#toAdj").button("disable"),this.$("#toTime").button("disable"),this.view.$("#prev").prop("disabled",!0),this.view.$("#showAll").prop("disabled",!0),this.view.$("#next").prop("disabled",!0),this.view.$("#zoomOut").prop("disabled",!0),this.view.$("#zoomIn").prop("disabled",!0),this.model.set("isTimeSpaced",!0),d3.selectAll(".month").attr("opacity",1);var b=this.view.subviews.toolbar.subviews.diag_data.dialog;$("#userselect",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),$("#userselect2",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$(".select_apply_div",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),$(".select_all_div",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$(".talkrow",b).removeClass("invisible"),$(".defaultrow",b).removeClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",1)}else"ownership"==this.model.get("mode")&&(this.$("#t_legend").button("disable"),this.$("#t_talk").button("disable"),this.$("#t_sections").button("enable"),this.sentences.updatePrevNext(),this.model.set("isTimeSpaced",!1),$("#userselect",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$("#userselect2",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),$(".select_apply_div",this.view.subviews.toolbar.subviews.diag_select.dialog).hide(),$(".select_all_div",this.view.subviews.toolbar.subviews.diag_select.dialog).show(),this.sentences.updateSentences());a.silent||this.update()},init:function(){this.$("#viewtabs").tabs(),this.model.set("width",this.$("#view").width(),{silent:!0}),this.model.set("height",this.$("#view").height(),{silent:!0}),this.$(".spacing_wrapper").mouseenter(function(){$(this).css("opacity",1)}).mouseleave(function(){$(this).css("opacity",.8)}),this.model.set("isTimeSpaced",!1),this.$("#toAdj").button().attr("title","Adjacent Spacing"),this.$("#toTime").button().attr("title","Time Spacing"),this.$("#toAdj").click($.proxy(function(){this.model.set("isTimeSpaced",!1),this.$("#toAdj").button("disable"),this.$("#toTime").button("enable")},this)),this.$("#toTime").click($.proxy(function(){this.model.set("isTimeSpaced",!0),this.$("#toAdj").button("enable"),this.$("#toTime").button("disable")},this)),this.$("a[href=#artview]").click($.proxy(function(){this.model.set("mode","art")},this)),this.$("a[href=#talkview]").click($.proxy(function(){this.model.set("mode","talk")},this)),this.$("a[href=#hybridview]").click($.proxy(function(){this.model.set("mode","hybrid")},this)),this.$("a[href=#ownershipview]").click($.proxy(function(){this.model.set("mode","ownership")},this)),this.$("#toAdj").button("disable")},initViz:function(){if(this.$("#view svg").remove(),""!=this.model.get("title")||""!=this.model.get("user")){var a=this.model.get("maskWidth"),b=this.model.get("view");b.svg=d3.select(this.$("#view")[0]).append("svg").attr("width",this.model.get("width")).attr("height",this.model.get("height")),b.sview=b.svg.append("g").attr("width",this.model.get("width")).attr("transform","translate("+a+","+Math.floor(this.model.get("height")/2)+")scale(1,-1)"),b.x=d3.scale.linear(),b.y=d3.scale.linear(),b.tx=d3.scale.linear(),b.ty=d3.scale.linear();var c=this.calcBarWidth();b.x.range([0,c]),b.y.range([0,this.model.get("height")/2-50]),b.y.domain([0,Helper.absMax(this.model.get("data").get("revisions"),function(a){return a.loglev})]),b.rules=b.sview.append("g").attr("class","rules");var e=b.rules.append("g").attr("class","posrules"),f=b.rules.append("g").attr("class","negrules");e.selectAll("g.rule").data(b.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+b.y(a)+")"}),f.selectAll("g.rule").data(b.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+-b.y(a)+")"}),b.rules.selectAll(".rule").append("line").attr("x2",Helper.width),b.body=b.sview.append("g").attr("class","body").attr("transform","translate(0,0)");var g=b.body;b.sview.append("g").attr("class","xaxis").append("line").attr("x2",this.model.get("width")+50).attr("x1",-50);var h=b.sview.append("g").attr("class","ylabel");h.append("rect").attr("class","ymask").attr("width",a).attr("height",this.model.get("height")).attr("y",-Math.floor(this.model.get("height")/2)).attr("x",-a),h.append("text").attr("transform","translate("+-(a-10)+", 0)rotate(90, 0, 0)scale(1, -1)").text("Revision Size");var i=h.append("g");i.selectAll(".yl").data(b.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+b.y(a)+")scale(1,-1)"}).text(function(a){return(Math.exp(a)-1).toPrecision(3)});var j=h.append("g");j.selectAll(".yl").data(b.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+-b.y(a)+")scale(1,-1)"}).text(function(a){return(-Math.exp(a)+1).toPrecision(3)}),g.append("g").attr("class","bg"),g.append("g").attr("class","mid"),g.append("g").attr("class","fg"),g.selectAll(".bg").append("g").attr("class","months");var k=g.selectAll(".bg").append("g").attr("class","bar");k.append("rect").attr("class","bar_bg").attr("width","100%").attr("height",35).attr("fill","#F2E4CB"),b.data=g.select("g.mid").append("g").attr("class","data");var l=b.data,m=l.selectAll(".datum").data(this.model.get("data").get("revisions")).enter().append("g").attr("class","datum").attr("transform",$.proxy(function(a){return"translate("+b.x(this.model.index(a))+", 0)"},this)).attr("opacity",1);m.append("title").text(function(a){return a.group+": "+a.user+"\n"+Helper.formatDate(new Date(a.timestamp))+"\nRevision Categories: "+Helper.toClassString(a.class)+"\nRevision Size: "+a.lev});var n=m.append("g").attr("class","bars");this.buildBars(n,c),b.tdata=g.select("g.fg").append("g").attr("class","tdata");var o=b.tdata.selectAll(".tdatum").data(this.model.get("data").get("talk")).enter().append("g").attr("class","tdatum").attr("transform",$.proxy(function(a){return"translate("+b.x(this.model.index(a))+", 0)"},this)).attr("opacity",0);this.appendCallout(o);var p=_.first(this.model.get("data").get("revisions")).date;this.model.timeX.domain([new Date(p.getFullYear(),p.getMonth()),_.last(this.model.get("data").get("revisions")).date]),this.model.timeX.range([0,5e3]),this.$("#view #view_loading").remove(),this.navctl.init(this.$("#navctl").width(),30);var q=null;if(this.view.subviews.toolbar.subviews.diag_select!=d){q=this.view.subviews.toolbar.subviews.diag_select.dialog;for(var r={},s=this.model.get("data").get("revisions"),t=0,v=0;v<s.length;++v)r.hasOwnProperty(s[v].user)||(r[s[v].user]=0),r[s[v].user]+=parseInt(s[v].lev),t+=parseInt(s[v].lev);var w=Array();for(u in r)r.hasOwnProperty(u)&&w.push([u,r[u]/t]);w.sort(function(a,b){return b[1]-a[1]}),d3.select($("#userselect",q)[0]).selectAll("option").data(w).enter().append("option").attr("value",function(a){return a[0]}).text(function(a){var b=100*a[1];return a[0]+" ("+b.toFixed(2).toString()+"%)"})}else if(this.view.subviews.toolbar.subviews.diag_articles!=d){q=this.view.subviews.toolbar.subviews.diag_articles.dialog;var x=this.model.get("data").get("articles");d3.select($("#userselect",q)[0]).selectAll("option").data(x).enter().append("option").attr("value",function(a){return a}).text(function(a){return a})}$("#userselect option",q).click(function(){$("input[name=userclassselect]",q).each(function(){$(this).attr("checked",!1)})}),q=this.view.subviews.toolbar.subviews.diag_data.dialog,$(q).empty();var y=d3.select(q[0]).append("table").attr("class","sortable"),z=Array();""!=this.model.get("data").get("user")&&z.push(["Article Title","sorttable_alpha"]),z.push(["Rev. Type","sorttable_alpha"]),z.push(["Revision Id","sorttable_numeric"]),""!=this.model.get("data").get("title")&&z.push(["User","sorttable_alpha"]),z.push(["User Group","sorttable_alpha"]),z.push(["Revision Date","sorttable_alpha"]),z.push(["Revision Size","sorttable_numeric"]),z.push(["Revision Categories","sorttable_alpha"]),z.push(["Sections","sorttable_alpha"]),y.append("thead").append("tr").selectAll("th").data(z).enter().append("th").text(function(a){return a[0]}).attr("class",function(a){return a[1]});var v=0,A=0,B=this.model.get("data").get("revisions"),C=this.model.get("data").get("talk");C=C.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1}),B=B.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1});for(var D=[];v<B.length&&A<C.length;)B[v].date<C[A].date?(D.push(B[v]),++v):(D.push(C[A]),++A);v<B.length&&(D=D.concat(B.slice(v))),A<C.length&&(D=D.concat(C.slice(A)));var E=y.append("tbody").selectAll("tr.data").data(D).enter().append("tr");""!=this.model.get("data").get("user")&&E.append("td").text(function(a){return a.page_title}),E.append("td").text(function(a){return"art"===a.type?"A":"TP"}),E.append("td").text(function(a){return a.revid}),""!=this.model.get("data").get("title")&&E.append("td").text(function(a){return a.user}),E.append("td").text(function(a){return a.group}),E.append("td").text(function(a){return Helper.formatDate(a.date)}).attr("sorttable_customkey",function(a){return Helper.getDateSortKey(a.date)}),E.append("td").text(function(a){return a.lev}),E.append("td").text(function(a){return"art"===a.type?Helper.toClassString(a.class):"talk"===a.type?Helper.toTalkClassString(a):"Undefined"}),E.append("td").text(function(a){return a.sections==d?"":a.sections.join("; ")}),E.attr("class",function(a){return"talk"===a.type?"data talkrow":"data defaultrow"}),sorttable.makeSortable($("table.sortable",q).get(0)),$(".talkrow",q).addClass("invisible"),this.updateMode({silent:!0}),this.updateSpacing({silent:!0})}},render:function(){return this.$el}}),subview=function(a){return"<div data-subview='"+a+"'></div>"},String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})},Helper=function(){},Helper.numberFormat=function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},Helper.formatDate=function(a,b){b==d&&(b=!0);var c=["January","February","March","April","May","June","July","August","September","October","November","December"][a.getMonth()]+" "+a.getDate()+", "+a.getFullYear();return b&&(c+="   "+("0"+a.getHours()).substr(-2,2)+":"+("0"+a.getMinutes()).substr(-2,2)),c},Helper.getDateSortKey=function(a){return String(a.getFullYear())+("0"+a.getMonth()).substr(-2,2)+("0"+a.getDate()).substr(-2,2)+("0"+a.getHours()).substr(-2,2)+("0"+a.getMinutes()).substr(-2,2)+("0"+a.getSeconds()).substr(-2,2)},Helper.isSubset=function(a,b){for(var c={},d=0;d<b.length;++d)c[b[d]]=!0;for(var d=0;d<a.length;++d)if(!c.hasOwnProperty(a[d]))return!1;return!0},Helper.toClassString=function(a){return _.uniq(a.split(";").map(function(a){return classifications.findWhere({id:a.trim()}).get("codna")})).join(", ")},Helper.toTalkClassString=function(a){var b="";return a.att&&(b+="attitude, "),a.crit&&(b+="criticism, "),a.inf&&(b+="informative, "),a.perf&&(b+="performative, "),b.substring(0,b.length-2)},Helper.absMax=function(a,b){if(!(a instanceof Array)||a.length<1)return d;for(var c=b(a[0]),e=1;e<a.length;++e)c=Math.max(c,Math.abs(b(a[e])));return c},$.ajaxSetup({cache:!1}),articles=new ArticleCollection,classifications=new ClassificationCollection,classifications.fetch(),topTabs=new TopTabCollection,topTabsView=new TopTabsView({model:topTabs,el:"#topTabs"}),PageRouter=Backbone.Router.extend({routes:{test:"testRoute","*actions":"defaultRoute"},defaultRoute:function(){var a=new NewArticleView({model:articles});topTabsView.render(),topTabs.add(new TopTab({title:"New Tab",mainView:a,selected:!0})),topTabs.add(new NewTopTab)}}),pageRouter=new PageRouter,Backbone.history.start()}(window,document);