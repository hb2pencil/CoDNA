//     CoDNA 0.1.0
//     (c) 2013 Henry Brausen, David Turner
//     https://github.com/hb2pencil/CoDNA
//     Released under GPLv2 License
!function(a,b,d){Article=Backbone.Model.extend({initialize:function(){},urlRoot:"",defaults:{title:"",rev_count:0}}),ArticleCollection=Backbone.Collection.extend({model:Article,url:"dbquery.php?list"}),TopTab=Backbone.Model.extend({initialize:function(){this.on("change:selected",function(){this.get("mainView").render()},this)},defaults:{type:"tab",color:"#CFECAD",hoverColor:"#BDD99E",title:"",selected:!1,x:Number.MAX_VALUE/2,mainView:null}}),NewTopTab=TopTab.extend({initialize:function(){},defaults:{type:"new",color:"#EEEEEE",hoverColor:"#DDDDDD",title:"<b>&#10133;</b>",selected:!1,x:Number.MAX_VALUE,mainView:null}}),TopTabCollection=Backbone.Collection.extend({comparator:function(a){return"new"==a.get("type")?Number.MAX_VALUE:a.get("x")},getSelected:function(){return this.findWhere({selected:!0})},model:TopTab}),WikiViz=Backbone.Model.extend({initialize:function(){var a=new WikiVizData({title:this.get("title"),wikiviz:this});this.set("view",{timeX:d3.time.scale(),mode:"art"}),this.set("weights",{add:60,remove:60,edit:20,reorganize:40,vand:10,unvand:10,cite:20,unclassified:60}),a.fetch(),this.set("data",a)},getGroupsByName:function(a){var b=this.get("data").get("users");return b.hasOwnProperty(a)?b[a].history[b[a].history.length-1]?b[a].history[b[a].history.length-1].userclass:["None"]:["None"]},index:function(a){return a.id},tIndex:function(a){return a.id},getRevisionGroup:function(a){var b=this.get("data").get("users");if(!a.user in b)return"Anon";var c=b[a.user];if(!c)return"Anon";if(c.flagged)return c.history[c.history.length-1].userclass;if(c.history.length<1)return"Anon";for(var d=new Date(a.timestamp),e=1,f=c.history[0];e<c.history.length&&!(new Date(c.history[e].timestamp)>d);)f=c.history[e],++e;return f.userclass},defaults:{title:"",data:null,width:910,height:500,numBars:60,maskWidth:50,timeMultiplier:1,isTimeSpaced:!1,weights:null,view:null}}),WikiVizData=Backbone.Model.extend({initialize:function(){this.on("sync",this.augment,this)},augment:function(){function a(a,b){return-1!=b.indexOf(a)}$.each(this.get("talk"),$.proxy(function(a,b){b.date=new Date(b.timestamp),b.loglev=Math.log(b.lev+1),b.user=b.contributor,b.type="talk",b.id=a,b.group=this.get("wikiviz").getRevisionGroup(b)},this)),$.each(this.get("revisions"),$.proxy(function(b,d){var e={add:0,remove:0,edit:0,reorganize:0,cite:0,vand:0,unvand:0,unsure:0,unclassified:0};a("a",d["class"])&&(e.edit+=this.get("wikiviz").get("weights").edit),a("b",d["class"])&&(e.add+=this.get("wikiviz").get("weights").add),a("c",d["class"])&&(e.remove+=this.get("wikiviz").get("weights").remove),a("d",d["class"])&&(e.reorganize+=this.get("wikiviz").get("weights").reorganize),a("e",d["class"])&&(e.cite+=this.get("wikiviz").get("weights").cite),a("f",d["class"])&&(e.vand+=this.get("wikiviz").get("weights").vand),a("g",d["class"])&&(e.unvand+=this.get("wikiviz").get("weights").unvand),a("x",d["class"])&&(e.unclassified+=this.get("wikiviz").get("weights").unclassified);var f=0;for(c in e)f+=e[c];if(0!=f)for(c in e)e[c]=e[c]*Math.log(+d.lev+1)/f;0===f&&(e.unsure=Math.log(d.lev+1)),d.wclass=e,d.loglev=Math.log(+d.lev+1),d.date=new Date(d.timestamp),d.group=this.get("wikiviz").getRevisionGroup(d),d.type="art",d.id=b},this))},urlRoot:function(){return"dbquery.php?lower=0&upper=10000&article="+this.get("title")},defaults:{title:"",wikiviz:null}}),ArticleView=Backbone.View.extend({template:_.template($("#main_container_template").html()),firstRender:!0,wikiviz:null,navctl:null,initialize:function(){this.wikiviz=new WikiViz({title:this.model.get("title")});var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0],this.listenTo(this.wikiviz.get("data"),"sync",this.initViz),this.navctl=new NavCtlView({article:this}),Backbone.Subviews.add(this)},subviewCreators:{diag_cursor:function(){return new DialogView({template:"diag_cursor_template",options:{autoOpen:!1,width:"auto",resizable:!1}})},diag_options:function(){return new DialogView({template:"diag_options_template",options:{autoOpen:!1,resizable:!1}})},diag_select:function(){var a=this.wikiviz,b=this;return new DialogView({template:"diag_select_template",options:{autoOpen:!1,width:400,resizable:!1},onCreate:function(c){$("#select_apply",c).button(),$("#d_select_tabs",c).tabs(),$("#d_select_groups_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$("#d_select_groups_accordion h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_select_groups_accordion h3",c).each(function(b,d){$(d).find("input").change(function(){var b=$(this);$(this).attr("checked")?a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",1):a.get("view").data.selectAll(".datum").filter(function(a){return a.group==b.val()}).transition().duration(500).attr("opacity",.2),$("#t_deselect",c).button("enable")})}),$("input[name=userclassselect]",c).each(function(b,d){$(d).change(function(){var b=Array();$("input[name=userclassselect]:checked",c).each(function(a,c){b.push($(c).val())}),$("#userselect option",c).each(function(c,d){Helper.isSubset([a.getGroupsByName($(d).val())],b)?$(d).attr("selected",!0):$(d).attr("selected",!1),$(d).addClass("invisible"),$(d).removeClass("invisible")})})}),$("#select_apply",c).click(function(){var a=Array();$("#userselect option:selected",c).each(function(){a.push($(this).val())}),b.applyUserSelection(a)})}})},diag_info:function(){return new DialogView({template:"diag_info_template",options:{autoOpen:!1,resizable:!1,width:400}})},diag_data:function(){return new DialogView({template:"diag_data_template",options:{autoOpen:!1,resizable:!0,width:800,height:600}})},diag_legend:function(){var a=this.wikiviz,b=this;return new DialogView({template:"diag_legend_template",options:{autoOpen:!1,resizable:!1,height:"auto",width:400},onCreate:function(c){$("#d_legend_accordion",c).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$(".d_checkable h3",c).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})});var d={addrem:["add","remove"],edit:["edit"],reorganize:["reorganize"],cite:["cite"],unsure:["unsure"],vandunvand:["vand","unvand"]};$("#d_legend_accordion h3",c).each(function(e,f){$(f).find("input").change(function(){if($(this).attr("checked"))for(var e in d[$(this).val()])a.get("view").data.selectAll("rect."+d[$(this).val()][e]).transition().duration(500).attr("opacity",1);else for(var e in d[$(this).val()])a.get("view").data.selectAll("rect."+d[$(this).val()][e]).transition().duration(500).attr("opacity",.2);var f=new Array;$("#d_legend_accordion input:checked",c).each(function(a,b){$.merge(f,d[$(b).val()])}),b.navctl.bg.selectAll("rect").transition().duration(500).attr("opacity",function(a){var b=.2;return $(f).each(function(c,d){return a.wclass[d]?(b=1,1):void 0}),b}),$("#t_deselect",c).button("enable")})})}})},diag_talk:function(){return new DialogView({template:"diag_talk_template",options:{autoOpen:!1,resizable:!1,height:"auto",width:400},onCreate:function(a){$("#d_talk_accordion",a).accordion({collapsible:!0,active:!1,autoHeight:!1,clearStyle:!0}),$(".d_checkable h3",a).each(function(a,b){$(b).find("input").click(function(a){a.stopPropagation()})}),$("#d_talk_accordion h3",a).each(function(b,c){$(c).find("input").change(function(){var b=$(this);$(this).attr("checked")?d3.selectAll(".tdatum ."+b.val()).transition().duration(500).attr("opacity",1):d3.selectAll(".tdatum ."+b.val()).transition().duration(500).attr("opacity",.2),$("#t_deselect",a).button("enable")})})}})}},calcBarWidth:function(){var a=(this.wikiviz.get("width")-this.wikiviz.get("maskWidth"))/this.wikiviz.get("numBars");return this.wikiviz.get("isTimeSpaced")&&(a=Math.min(a,7)),a},calcTalkWidth:function(){var a=(this.wikiviz.get("width")-this.wikiviz.get("maskWidth"))/this.wikiviz.get("numDots");return a},getAdjacentTalkWidth:function(){return 70*this.wikiviz.get("data").get("talk").length},getOffset:function(a){return this.wikiviz.get("isTimeSpaced")?this.wikiviz.get("data").get("revisions")[a].dateOffset:a*this.calcBarWidth()},getCalloutHeight:function(a){var b=0,c=29;return 0!==a.att&&(b+=c),0!==a.crit&&(b+=c),0!==a.inf&&(b+=c),0!==a.perf&&(b+=c),b},genCalloutImageSet:function(a){var b=[];return 0!==a.att&&b.push("att"),0!==a.crit&&b.push("crit"),0!==a.inf&&b.push("inf"),0!==a.perf&&b.push("perf"),b},updateInfo:function(a){this.$("#d_info_noselection").addClass("invisible"),this.$("#d_info_selection").empty();var b=0;this.$("#d_info_selection").append($("<table>"));for(p in a)a.hasOwnProperty(p)&&(++b,this.$("#d_info_selection table").append($("<tr>").append($("<td>").text(p)).append($("<td>").text(a[p].toString()))));0==b&&(this.$("#d_info_selection").empty(),this.$("#d_info_noselection").removeClass("invisible"))},clearMonths:function(){this.wikiviz.get("view").body.select(".bg").selectAll(".month").data([]).exit().remove()},setNumBars:function(a){if(!(0>=a)){this.wikiviz.set("numBars",a),this.wikiviz.get("view").x.range([0,this.calcBarWidth()]),this.wikiviz.get("isTimeSpaced")||this.wikiviz.get("view").data.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.wikiviz.get("view").x(this.wikiviz.index(a))+", 0)"},this));var b=this;this.wikiviz.get("view").data.selectAll(".datum").selectAll(".bars rect").attr("width",this.calcBarWidth()),this.wikiviz.get("view").data.selectAll(".datum").select(".xlabel").filter(function(){return this.getBBox().width<=b.calcBarWidth()}).attr("opacity",1),this.wikiviz.get("view").data.selectAll(".datum").select(".xlabel").filter(function(){return this.getBBox().width>b.calcBarWidth()}).attr("opacity",0),this.buildMonths()}},setNumDots:function(a){0>=a||(this.wikiviz.set("numDots",a),this.wikiviz.get("view").tx.range([0,this.calcTalkWidth()]),this.wikiviz.get("isTimeSpaced")||this.wikiviz.get("view").tdata.selectAll(".tdatum").attr("transform",$.proxy(function(a,b){return"translate("+this.wikiviz.get("view").tx(b)+", 0)"},this)),this.buildMonths())},applyUserSelection:function(a){if(this.clearAllSelections(),!(a.length>0))return this.clearAllSelections(),void 0;this.$("#t_deselect").button("enable"),$("#diag_legend input").attr("disabled","disabled"),$("#d_select_groups_accordion input").attr("disabled","disabled");var b={};b["Number of Selected Users"]=a.length,b["User Groups"]=[];for(var c=0;c<a.length;++c)-1==jQuery.inArray(this.wikiviz.getGroupsByName(a[c]),b["User Groups"])&&b["User Groups"].push(this.wikiviz.getGroupsByName(a[c]));this.updateInfo(b),$("#diag_data table tbody").children("tr").each(function(b,c){$(c).removeClass("rowselect"),-1!=jQuery.inArray($(c).children(":eq(2)").text(),a)&&$(c).addClass("rowselect")}),this.wikiviz.get("view").data.selectAll(".datum").filter(function(b){return-1===jQuery.inArray(b.user,a)}).selectAll(".bars rect").transition().duration(500).attr("opacity",.2),this.navctl.spikes.filter(function(b){return-1===jQuery.inArray(b.user,a)}).transition().duration(500).attr("opacity",.4)},clearAllSelections:function(){this.$("#t_deselect").button("disable"),this.updateInfo({}),this.$("#diag_data table tbody tr").each(function(a,b){$(b).removeClass("rowselect")}),this.$("#d_legend_accordion input").attr("checked","checked"),$("#d_select_groups_accordion input").attr("checked","checked"),this.wikiviz.get("view").data.selectAll(".bars rect").transition().duration(500).attr("opacity",1),this.wikiviz.get("view").data.selectAll(".datum").transition().duration(500).attr("opacity",1),this.navctl.spikes.transition().duration(500).attr("opacity",1),this.$("#diag_legend input").removeAttr("disabled"),this.$("#d_select_groups_accordion input").removeAttr("disabled")},toTimeSpaced:function(){this.wikiviz.set("isTimeSpaced",!0),d3.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.wikiviz.get("view").timeX(a.date)+",0)"},this)).selectAll(".bars rect").attr("width",this.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",$.proxy(function(a){return"translate("+this.wikiviz.get("view").timeX(a.date)+",0)"},this)),this.buildMonths(),"talk"==this.wikiviz.get("view").mode&&d3.selectAll(".month").attr("opacity",1)},toAdjacentSpaced:function(){this.wikiviz.set("isTimeSpaced",!1),"talk"==this.wikiviz.get("view").mode&&(d3.selectAll(".month").attr("opacity",0),this.wikiviz.get("view").tx.range([0,this.getAdjacentTalkWidth()])),d3.selectAll(".datum").attr("transform",$.proxy(function(a){return"translate("+this.wikiviz.get("view").x(this.wikiviz.index(a))+",0)"},this)).selectAll(".bars rect").attr("width",this.calcBarWidth()),d3.selectAll(".tdatum").attr("transform",$.proxy(function(a,b){return"translate("+this.wikiviz.get("view").tx(b)+",0)"},this)),this.buildMonths()},buildBars:function(a,b){for(var c=["add","unsure","reorganize","edit","cite","vand","unclassified"],d=["unvand","remove"],e=this.wikiviz.get("view").y,f=this.wikiviz.index,g=[],h=0;h<this.wikiviz.get("data").get("revisions").length;++h)g[h]=0;_.each(c,function(c){a.filter(function(a){return a.wclass[c]>1e-4}).append("rect").attr("y",function(a){return e(g[f(a)])}).attr("width",b).attr("height",function(a){return e(a.wclass[c])}).attr("class",c).attr("desc",f).attr("opacity",1);for(var d=0;d<this.wikiviz.get("data").get("revisions").length;++d)g[d]+=this.wikiviz.get("data").get("revisions")[d].wclass[c]},this);for(var h=0;h<this.wikiviz.get("data").get("revisions").length;++h)g[h]=0;_.each(d,function(c){a.filter(function(a){return a.wclass[c]>1e-4}).append("rect").attr("y",function(a){return-e(a.wclass[c]+g[f(a)])}).attr("width",b).attr("height",function(a){return e(a.wclass[c])}).attr("class",c).attr("desc",f).attr("opacity",1);for(var d=0;d<this.wikiviz.get("data").get("revisions").length;++d)g[d]+=this.wikiviz.get("data").get("revisions")[d].wclass[c]},this)},buildMonths:function(){this.calcBarWidth();var a=this.wikiviz.get("data").get("revisions"),b=10,c=[],d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(this.wikiviz.get("isTimeSpaced"))for(var e,f=!0,g=this.wikiviz.get("view").timeX,h=_.first(this.wikiviz.get("data").get("revisions")).date.getMonth(),i=_.first(this.wikiviz.get("data").get("revisions")).date.getFullYear();h<=_.last(this.wikiviz.get("data").get("revisions")).date.getMonth()||i<=_.last(this.wikiviz.get("data").get("revisions")).date.getFullYear();++h){h>11&&(h=0,++i),f&&(e=0==h?new Date(i-1,0,1):new Date(i,h-1,1),f=!1);var j=new Date(i,h,1);c.push({l:g(e),r:g(j),m:e.getMonth(),y:e.getFullYear()}),e=j}else{var k,l=new Date(_.first(a).timestamp),m=0;_.first(this.wikiviz.get("data").get("revisions"));for(var n=1;n<a.length;++n)if(k=new Date(a[n].timestamp),k.getMonth()!==l.getMonth()||k.getYear()!==l.getYear()){var o=this.getOffset(m),p=this.getOffset(n);if(o===p)continue;c.push({l:o,r:p,m:l.getMonth(),y:l.getFullYear()}),l=k,m=n}var o=this.getOffset(m),p=this.getOffset(a.length);c.push({l:o,r:p,m:l.getMonth(),y:l.getFullYear()})}var q=this.wikiviz.get("view").body.select(".bg").selectAll(".month").data(c,function(a,b){return b}).enter(),r=q.append("g").attr("class","month").attr("transform",function(a){return"translate("+a.l+",0)"});r.append("rect").attr("height",String(this.wikiviz.get("height"))).attr("width",function(a){return a.r-a.l}).attr("class",function(a,b){return 0===b%2?"m_odd":"m_even"}).attr("y",String(-this.wikiviz.get("height")/2)),r.append("text").attr("class","mtext").text(function(a){return d[a.m]}).attr("transform",$.proxy(function(){return"translate(5,"+(this.wikiviz.get("height")/2-15)+")scale(1,-1)"},this)).attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),r.append("text").attr("class","ytext").text(function(a){return String(a.y)}).attr("transform",$.proxy(function(){return"translate(5,"+(this.wikiviz.get("height")/2-30)+")scale(1,-1)"},this)).attr("opacity",1).filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),mts=this.wikiviz.get("view").body.selectAll(".month").data(c,function(a,b){return b});var s=mts;s.attr("transform",function(a){return"translate("+a.l+",0)"}),s.select("rect").attr("width",function(a){return a.r-a.l}),mts.select("text.mtext").text(function(a){return d[a.m]}),mts.select("text.ytext").text(function(a){return String(a.y)}),s.select("rect").attr("class",function(a,b){return 0===b%2?"m_odd":"m_even"}),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),mts.select("text.mtext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=b}).attr("opacity",1),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()<b}).attr("opacity",0),mts.select("text.ytext").filter(function(a){return a.r-a.l-this.getComputedTextLength()>=b}).attr("opacity",1);var t=mts.exit();t.attr("opacity",0).remove()},appendCallout:function(a){var b=24,c=10,d=10,e=10,f=10,g=5,h=10,i=1.2;a.filter(function(a){return Math.log(a.lev+1)*i<=h}).append("circle").attr("r",function(a){return Math.log(a.lev+1)*i}).attr("class","tcircle"),a.filter(function(a){return Math.log(a.lev+1)*i>h}).append("circle").attr("r",h).attr("class","tcircle_full"),a.append("title").text(function(a){return"User: "+a.contributor+"\n"+Helper.formatDate(a.date)+"\n"+"Revision Categories: "+Helper.toTalkClassString(a)+"\n"+"Revision Size: "+a.lev});var j=a.append("path");j.attr("d",$.proxy(function(a){return"M 0 0 l {0} {1} l 0 {2} a {3} {3} 0 0 0 {3} {3} l {4} 0 a {3} {3} 0 0 0 {3} -{3} l 0 -{5} a {3} {3} 0 0 0 -{3} -{3} l -{6} 0 z".format(e,f,this.getCalloutHeight(a)+2*c-2*g,g,b+2*d-g,this.getCalloutHeight(a)+2*c-g-10,b+2*d-2*g)},this)),j.attr("class","callout");var k=a.append("g").attr("class","igroup").attr("transform","translate("+(e+c)+","+(f+d)+")scale(1,-1)").datum($.proxy(function(a){return this.genCalloutImageSet(a)},this));k.each(function(a){d3.select(this).selectAll("image").data(a).enter().append("image").attr("xlink:href",function(a){return"img/"+a+".png"}).attr("y",function(a,b){return-29*b-24}).attr("width",24).attr("height",24).attr("x",3).attr("class",function(a){return a})}),a.append("text").attr("class","xlabel").text(function(a,b){return b+1}).attr("transform",function(){return"translate("+(e+c/2)+","+(f+d/2)+")scale(1,-1)"})},createToolbar:function(){this.$("#t_select").button({icons:{primary:"icon-users"},text:!1}),this.$("#t_data").button({icons:{primary:"icon-table"},text:!1}),this.$("#t_legend").button({icons:{primary:"icon-categories"},text:!1}),this.$("#t_deselect").button({icons:{primary:"icon-deselect"},text:!1,disabled:!0}),this.$("#t_deselect").click($.proxy(function(){this.clearAllSelections(!0)},this)),this.$("#t_talk").button({icons:{primary:"icon-talk"},text:!1,disabled:!0})},bindToolbar:function(){this.$("#t_cursor").click($.proxy(function(){this.subviews.diag_cursor.open()},this)),this.$("#t_options").click($.proxy(function(){this.subviews.diag_options.open()},this)),this.$("#t_select").click($.proxy(function(){this.subviews.diag_select.open()},this)),this.$("#t_info").click($.proxy(function(){this.subviews.diag_info.open()},this)),this.$("#t_data").click($.proxy(function(){this.subviews.diag_data.open()},this)),this.$("#t_legend").click($.proxy(function(){this.subviews.diag_legend.open()},this)),this.$("#t_talk").click($.proxy(function(){this.subviews.diag_talk.open()},this))},init:function(){this.createToolbar(),this.$("#viewtabs").tabs(),this.$(".spacing_wrapper").mouseenter(function(){$(this).css("opacity",1)}).mouseleave(function(){$(this).css("opacity",.8)}),this.bindToolbar(),this.wikiviz.set("isTimeSpaced",!1),this.$("#toAdj").button().attr("title","Adjacent Spacing"),this.$("#toTime").button().attr("title","Time Spacing"),this.$("#toAdj").click($.proxy(function(){this.navctl.toAdjacentSpaced(),this.$("#toAdj").button("disable"),this.$("#toTime").button("enable")},this)),this.$("#toTime").click($.proxy(function(){this.navctl.toTimeSpaced(),this.$("#toAdj").button("enable"),this.$("#toTime").button("disable")},this)),this.$("a[href=#artview]").click($.proxy(function(){this.$("#view").appendTo(this.$("#artview")),this.wikiviz.get("view").data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",0),d3.selectAll(".tcircle").attr("opacity",0),this.$("#t_legend").button("enable"),this.$("#t_talk").button("disable"),this.$("#toAdj").button("enable"),d3.selectAll(".month").attr("opacity",1),this.wikiviz.get("view").mode="art",this.wikiviz.get("isTimeSpaced")===!1?(this.$("#toAdj").button("disable"),this.$("#toTime").button("enable"),this.navctl.toAdjacentSpaced()):(this.$("#toAdj").button("enable"),this.$("#toTime").button("disable"),this.navctl.toTimeSpaced()),this.navctl.onScale(),this.$(".talkrow").addClass("invisible"),this.$(".defaultrow").removeClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, -500)"),d3.selectAll("g.ylabel").attr("opacity",1)},this)),this.$("a[href=#talkview]").click($.proxy(function(){this.$("#view").appendTo(this.$("#talkview")),this.wikiviz.get("view").data.selectAll(".datum").attr("opacity",0),d3.selectAll(".sd").attr("opacity",0),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),$("#t_legend").button("disable"),$("#t_talk").button("enable"),this.wikiviz.get("view").mode="talk",this.wikiviz.get("isTimeSpaced")===!1?(d3.selectAll(".month").attr("opacity",0),this.$("#toAdj").button("disable"),this.$("#toTime").button("enable"),this.navctl.toAdjacentSpaced()):(this.$("#toAdj").button("enable"),this.$("#toTime").button("disable"),this.navctl.toTimeSpaced()),this.navctl.onScale(),this.$(".talkrow").removeClass("invisible"),this.$(".defaultrow").addClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",0)},this)),this.$("a[href=#hybridview]").click($.proxy(function(){this.$("#view").appendTo(this.$("#hybridview")),this.wikiviz.get("view").data.selectAll(".datum").attr("opacity",1),d3.selectAll(".sd").attr("opacity",1),d3.selectAll(".tdatum").attr("opacity",1),d3.selectAll(".tcircle").attr("opacity",1),this.$("#t_legend").button("enable"),this.$("#t_talk").button("enable"),this.$("#toAdj").button("disable"),this.$("#toTime").button("disable"),this.wikiviz.get("view").mode="hybrid",this.navctl.toTimeSpaced(),d3.selectAll(".month").attr("opacity",1),this.$(".talkrow").removeClass("invisible"),this.$(".defaultrow").removeClass("invisible"),d3.select(this.$(".fg")[0]).attr("transform","translate(0, 0)"),d3.selectAll("g.ylabel").attr("opacity",1)},this)),this.$("#toAdj").button("disable")},initViz:function(){var a=this.wikiviz.get("maskWidth"),b=this.wikiviz.get("view");b.svg=d3.select(this.$("#view")[0]).append("svg").attr("width",this.wikiviz.get("width")).attr("height",this.wikiviz.get("height")),b.sview=b.svg.append("g").attr("width",this.wikiviz.get("width")).attr("transform","translate("+a+","+this.wikiviz.get("height")/2+")scale(1,-1)"),b.x=d3.scale.linear(),b.y=d3.scale.linear(),b.tx=d3.scale.linear(),b.ty=d3.scale.linear();var c=this.calcBarWidth();b.x.range([0,c]),b.y.range([0,this.wikiviz.get("height")/2-50]),b.y.domain([0,Helper.absMax(this.wikiviz.get("data").get("revisions"),function(a){return a.loglev})]),b.rules=b.sview.append("g").attr("class","rules");var d=b.rules.append("g").attr("class","posrules"),e=b.rules.append("g").attr("class","negrules");d.selectAll("g.rule").data(b.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+b.y(a)+")"}),e.selectAll("g.rule").data(b.y.ticks(5)).enter().append("g").attr("class","rule").attr("transform",function(a){return"translate(0,"+-b.y(a)+")"}),b.rules.selectAll(".rule").append("line").attr("x2",Helper.width),b.body=b.sview.append("g").attr("class","body").attr("transform","translate(0,0)");var f=b.body;b.sview.append("g").attr("class","xaxis").append("line").attr("x2",this.wikiviz.get("width"));var g=b.sview.append("g").attr("class","ylabel");g.append("rect").attr("class","ymask").attr("width",a).attr("height",this.wikiviz.get("height")).attr("y",-this.wikiviz.get("height")/2).attr("x",-a),g.append("text").attr("transform","translate("+-(a-10)+", 0)rotate(90, 0, 0)scale(1, -1)").text("Revision Size");var h=g.append("g");h.selectAll(".yl").data(b.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+b.y(a)+")scale(1,-1)"}).text(function(a){return(Math.exp(a)-1).toPrecision(3)});var i=g.append("g");i.selectAll(".yl").data(b.y.ticks(5)).enter().append("text").attr("class","yl").attr("transform",function(a){return"translate(-8,"+-b.y(a)+")scale(1,-1)"}).text(function(a){return(-Math.exp(a)+1).toPrecision(3)}),f.append("g").attr("class","bg"),f.append("g").attr("class","mid"),f.append("g").attr("class","fg"),b.data=f.select("g.mid").append("g").attr("class","data");var j=b.data,k=j.selectAll(".datum").data(this.wikiviz.get("data").get("revisions")).enter().append("g").attr("class","datum").attr("transform",$.proxy(function(a){return"translate("+b.x(this.wikiviz.index(a))+", 0)"},this)).attr("opacity",1);k.append("title").text(function(a){return a.group+": "+a.user+"\n"+Helper.formatDate(new Date(a.timestamp))+"\n"+"Revision Categories: "+Helper.toClassString(a.class)+"\n"+"Revision Size: "+a.lev});var l=k.append("g").attr("class","bars");this.buildBars(l,c),k.append("text").attr("class","xlabel").text($.proxy(function(a){return 1+this.wikiviz.index(a)},this)).attr("transform",function(){return"translate(0,"+String(-7)+")scale(1,-1)rotate(90,0,0)"}),this.buildMonths(),b.tdata=f.select("g.fg").append("g").attr("class","tdata");var m=b.tdata.selectAll(".tdatum").data(this.wikiviz.get("data").get("talk")).enter().append("g").attr("class","tdatum").attr("transform",$.proxy(function(a){return"translate("+b.x(this.wikiviz.index(a))+", 0)"},this)).attr("opacity",0);this.appendCallout(m),this.toAdjacentSpaced();var n=_.first(this.wikiviz.get("data").get("revisions")).date;this.wikiviz.get("view").timeX.domain([new Date(n.getFullYear(),n.getMonth()),_.last(this.wikiviz.get("data").get("revisions")).date]),this.wikiviz.get("view").timeX.range([0,5e3]),this.$("#view #view_loading").remove(),this.navctl.init(920,30);for(var o=this.subviews.diag_select.dialog,p={},q=this.wikiviz.get("data").get("revisions"),r=0,s=0;s<q.length;++s)p.hasOwnProperty(q[s].user)||(p[q[s].user]=0),p[q[s].user]+=parseInt(q[s].lev),r+=parseInt(q[s].lev);var t=Array();for(u in p)p.hasOwnProperty(u)&&t.push([u,p[u]/r]);t.sort(function(a,b){return b[1]-a[1]}),d3.select($("#userselect",o)[0]).selectAll("option").data(t).enter().append("option").attr("value",function(a){return a[0]}).text(function(a){var b=100*a[1];return a[0]+" ("+b.toFixed(2).toString()+"%)"}),$("#userselect option",o).click(function(){$("input[name=userclassselect]",o).each(function(){$(this).attr("checked",!1)})}),o=this.subviews.diag_data.dialog;var v=d3.select(o[0]).append("table").attr("class","sortable");v.append("thead").append("tr").selectAll("th").data([["Rev. Type","sorttable_alpha"],["ID","sorttable_numeric"],["User","sorttable_alpha"],["User Group","sorttable_alpha"],["Revision Date","sorttable_alpha"],["Revision Size","sorttable_numeric"],["Revision Categories","sorttable_alpha"]]).enter().append("th").text(function(a){return a[0]}).attr("class",function(a){return a[1]});var s=0,w=0,x=this.wikiviz.get("data").get("revisions"),y=this.wikiviz.get("data").get("talk");y=y.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1}),x=x.sort(function(a,b){return a.date==b.date?0:a.date>b.date?1:-1});for(var z=[];s<x.length&&w<y.length;)x[s].date<y[w].date?(z.push(x[s]),++s):(z.push(y[w]),++w);s<x.length&&(z=z.concat(x.slice(s))),w<y.length&&(z=z.concat(y.slice(w)));var A=v.append("tbody").selectAll("tr.data").data(z).enter().append("tr");A.append("td").text(function(a){return"art"===a.type?"A":"TP"}),A.append("td").text(function(a){return 1+a.id}),A.append("td").text(function(a){return a.user}),A.append("td").text(function(a){return a.group}),A.append("td").text(function(a){return Helper.formatDate(a.date)}).attr("sorttable_customkey",function(a){return Helper.getDateSortKey(a.date)}),A.append("td").text(function(a){return a.lev}),A.append("td").text(function(a){return"art"===a.type?Helper.toClassString(a.class):"talk"===a.type?Helper.toTalkClassString(a):"Undefined"}),A.attr("class",function(a){return"talk"===a.type?"data talkrow":"data defaultrow"}),sorttable.makeSortable($("table.sortable",o).get(0)),$(".talkrow",o).addClass("invisible")},render:function(){return null!=topTabs.getSelected()&&topTabs.getSelected().get("mainView")==this?this.$el.css("display","block"):this.$el.css("display","none"),this.firstRender&&(this.$el.html(this.template()),this.init(this.model.get("title"))),this.firstRender=!1,this.$el}}),DialogView=Backbone.View.extend({dialog:null,options:null,onCreate:function(){},initialize:function(a){this.template=_.template($("#"+a.template).html()),this.options=a.options,_.isFunction(a.onCreate)&&(this.onCreate=a.onCreate)},open:function(){this.dialog.dialog("open")},close:function(){this.dialog.dialog("close")},render:function(){return this.$el.html(this.template()),this.dialog=this.$el.children().dialog(this.options),this.onCreate(this.dialog),this.$el}}),NavCtlView=Backbone.View.extend({article:null,initialize:function(a){this.article=a.article},toTimeSpaced:function(){var a=_.first(this.article.wikiviz.get("data").get("revisions")).date;this.xscale=d3.time.scale(),this.xscale.domain([new Date(a.getFullYear(),a.getMonth()),_.last(this.article.wikiviz.get("data").get("revisions")).date]),this.xscale.range([0,this.dim.w-2*this.handleWidth]);var b=this;this.bg.select("g.navbars").selectAll("rect.sd").data(this.article.wikiviz.get("data").get("revisions")).attr("x",function(a){return b.xscale(a.date)}).attr("y",function(a){return-b.yscale(a.wclass.remove+a.wclass.vand)}).attr("width",function(){return b.spikewidth}).attr("height",function(a){return b.yscale(a.loglev-(a.wclass.remove+a.wclass.vand))+b.yscale(a.wclass.remove+a.wclass.vand)}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle.tcircle").data(this.article.wikiviz.get("data").get("talk")).attr("cx",function(a){return b.xscale(a.date)}),this.mode="time",this.article.toTimeSpaced(),this.onSlide(),this.onScale()},toAdjacentSpaced:function(){this.xscale=d3.scale.linear(),"talk"==this.article.wikiviz.get("view").mode?this.xscale.domain([0,this.article.wikiviz.get("data").get("talk").length-1]):this.xscale.domain([0,this.article.wikiviz.get("data").get("revisions").length-1]),this.xscale.range([0,this.dim.w-2*this.handleWidth]);var a=this;this.bg.select("g.navbars").selectAll("rect.sd").data(this.article.wikiviz.get("data").get("revisions")).attr("x",function(b,c){return a.xscale(c)}).attr("y",function(b){return-a.yscale(b.wclass.remove+b.wclass.vand)}).attr("width",function(){return a.spikewidth}).attr("height",function(b){return a.yscale(b.loglev-(b.wclass.remove+b.wclass.vand))+a.yscale(b.wclass.remove+b.wclass.vand)}).attr("class","sd"),this.bg.select("g.navbars").selectAll("circle").data(this.article.wikiviz.get("data").get("talk")).attr("cx",function(b,c){return a.xscale(c)}),this.mode="adj",this.article.toAdjacentSpaced(),this.onSlide(),this.onScale()},onSlide:function(){d3.select(this.article.$("g.body")[0]).attr("transform","translate("+-this.getPanOffset()+",0)")},onScale:function(){if("adj"==this.mode&&"art"==this.article.wikiviz.get("view").mode)this.article.setNumBars(this.getNumBars());else if("adj"==this.mode&&"talk"==this.article.wikiviz.get("view").mode)this.article.setNumDots(this.getNumBars());else if("time"==this.mode){var a=_.last(this.article.wikiviz.get("data").get("revisions")).date,b=_.first(this.article.wikiviz.get("data").get("revisions")).date,c=this.xscale.invert(this.sdim.x0),d=this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth);
this.article.wikiviz.get("view").timeX.range([0,.9*this.article.wikiviz.get("width")*(a-b)/(d-c)]),this.article.toTimeSpaced()}},getPanOffset:function(){return"adj"==this.mode&&"art"==this.article.wikiviz.get("view").mode?this.sdim.x0/(this.dim.w-2*this.handleWidth)*this.article.wikiviz.get("data").get("revisions").length*this.article.calcBarWidth():"adj"==this.mode&&"talk"==this.article.wikiviz.get("view").mode?this.sdim.x0/(this.dim.w-2*this.handleWidth)*this.article.wikiviz.get("data").get("talk").length*this.article.calcTalkWidth():"time"==this.mode?this.article.wikiviz.get("view").timeX(this.xscale.invert(this.sdim.x0)):0},getNumBars:function(){return this.xscale.invert(this.sdim.x0+this.sdim.w-this.handleWidth)-this.xscale.invert(this.sdim.x0)},getTimeRange:function(){},init:function(a,c){this.dim={w:a,h:c},this.sdim={x0:0,w:100},this.svg=d3.select(this.article.$("#navctl")[0]).append("svg").attr("width",this.dim.w).attr("height",this.dim.h),this.bg=this.svg.append("g").attr("class","bg");var d=this.dim.h/2;this.bg.append("path").attr("d","M"+d+",0 A"+d+","+d+" 0 0,0 "+d+","+2*d).attr("class","pad").attr("width",d).attr("height",this.dim.h),this.bg.append("path").attr("d","M0,0 A"+d+","+d+" 0 0,1 0,"+2*d).attr("class","pad").attr("width",d).attr("height",this.dim.h).attr("transform","translate("+(this.dim.w-d)+",0)"),this.bg.append("g").attr("class","navbars").attr("x",d).attr("transform","translate("+d+","+this.dim.h/2+")scale(1,-1)"),this.bg.select("g.navbars").append("line").attr("x1",0).attr("y1",0).attr("x2",this.dim.w-2*d).attr("y2",0),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",d).attr("x2",this.dim.w-2*d).attr("y2",d),this.bg.select("g.navbars").append("line").attr("class","navctlborder").attr("x1",0).attr("y1",-d).attr("x2",this.dim.w-2*d).attr("y2",-d),this.slider=this.svg.append("g").attr("class","slider"),this.slider.append("rect").attr("class","chandle").attr("width",this.sdim.w-d).attr("height",this.dim.h).attr("x",this.sdim.x0+d),this.slider.append("g").attr("class","lhandlegrp").attr("transform","translate("+this.sdim.x0+",0)").append("path").attr("d","M"+d+",0 A"+d+","+d+" 0 0,0 "+d+","+2*d).attr("class","lhandle").attr("width",d).attr("height",this.dim.h),this.slider.append("g").attr("class","rhandlegrp").attr("transform","translate("+(this.sdim.x0+this.sdim.w)+",0)").append("path").attr("d","M0,0 A"+d+","+d+" 0 0,1 0,"+2*d).attr("class","rhandle").attr("width",d).attr("height",this.dim.h),this.xscale=d3.scale.linear(),this.xscale.domain([0,this.article.wikiviz.get("data").get("revisions").length-1]),this.xscale.range([0,this.dim.w-2*d]),this.yscale=d3.scale.linear(),this.yscale.domain(this.article.wikiviz.get("view").y.domain()),this.yscale.range([0,this.dim.h/2]);var e=this;this.spikewidth=(this.dim.w-2*d)/this.article.wikiviz.get("data").get("revisions").length,this.spikes=this.bg.select("g.navbars").selectAll("rect.sd").data(this.article.wikiviz.get("data").get("revisions")),this.spikes.enter().append("rect").attr("x",function(a,b){return e.xscale(b)}).attr("y",function(a){return-e.yscale(a.wclass.remove+a.wclass.vand)}).attr("width",function(){return e.spikewidth}).attr("height",function(a){return e.yscale(a.loglev-(a.wclass.remove+a.wclass.vand))+e.yscale(a.wclass.remove+a.wclass.vand)}).attr("class","sd"),this.dots=this.bg.select("g.navbars").selectAll("circle.td").data(this.article.wikiviz.get("data").get("talk")).enter().append("circle").attr("class","td");var f=5,g=.6;this.dots.filter(function(a){return Math.log(a.lev+1)*g<=f}).attr("r",function(a){return Math.log(a.lev+1)*g}).attr("class","tcircle"),this.dots.filter(function(a){return Math.log(a.lev+1)*g>f}).attr("r",f).attr("class","tcircle_full"),this.mode="adj",this.sd={dx:0},this.article.$(".chandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),this.article.$(".lhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX-e.sdim.x0,a.preventDefault()}),this.article.$(".rhandle").mousedown(function(a){$(this).addClass("dragging"),e.sd.dx=a.pageX,a.preventDefault()}),$(b).mousemove($.proxy(function(a){if(this.article.$(".rhandle").hasClass("dragging")){var b=a.pageX-this.sd.dx;this.sd.dx=a.pageX;var c=+this.sdim.w+b;d>c&&(c=d),c+this.sdim.x0+d>this.dim.w&&(c=this.dim.w-this.sdim.x0-d),this.sdim.w=c,this.article.$(".chandle").attr("width",this.sdim.w-d),this.article.$(".rhandlegrp").attr("transform","translate("+ +this.sdim.w+",0)"),this.onScale(),this.onSlide()}if(this.article.$(".lhandle").hasClass("dragging")){var e=a.pageX-this.sd.dx;0>e&&(e=0),e>this.sdim.x0+this.sdim.w-d&&(e=this.sdim.x0+this.sdim.w-d);var c=+this.sdim.w-(+e-+this.sdim.x0);d>c&&(c=d),this.sdim.x0=e,this.sdim.w=c,this.article.$(".slider").attr("transform","translate("+this.sdim.x0+",0)"),this.article.$(".chandle").attr("width",this.sdim.w-d),this.article.$(".rhandlegrp").attr("transform","translate("+ +this.sdim.w+",0)"),this.onScale(),this.onSlide()}this.article.$(".chandle").hasClass("dragging")&&(this.sdim.x0=a.pageX-this.sd.dx,this.sdim.x0<0&&(this.sdim.x0=0),this.sdim.x0>this.dim.w-(d+this.sdim.w)&&(this.sdim.x0=this.dim.w-(d+this.sdim.w)),this.article.$(".slider").attr("transform","translate("+this.sdim.x0+",0)"),this.onSlide())},this)),$(b).mouseup($.proxy(function(){this.article.$(".chandle").removeClass("dragging"),this.article.$(".lhandle").removeClass("dragging"),this.article.$(".rhandle").removeClass("dragging")},this)),this.handleWidth=d,this.onSlide(),this.onScale()}}),NewArticleView=Backbone.View.extend({template:_.template($("#new_article_template").html()),firstRender:!0,initialize:function(){var a=_.uniqueId();$("#content").append("<div id='"+a+"'>"),this.$el=$("#"+a),this.el=$("#"+a)[0],this.listenTo(this.model,"sync",this.render)},events:{"click #initiative .option":"clickInitiative","click #project .option":"clickProject","click #analyse button":"clickAnalyse"},clickInitiative:function(a){this.$("#initiative .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),this.renderProjects(),"none"==this.$("#project").css("display")&&this.$("#initiative .option.selected").length>0?this.$("#project").show("slide",400):"none"!=this.$("#project").css("display")&&0==this.$("#initiative .option.selected").length&&(this.$("#project").hide("slide",400),"none"!=this.$("#analyse").css("display")&&this.$("#analyse").hide("slide",400))},clickProject:function(a){this.$("#project .option").not(a.currentTarget).removeClass("selected"),$(a.currentTarget).toggleClass("selected"),"none"==this.$("#analyse").css("display")&&this.$("#project .option.selected").length>0?this.$("#analyse").show("slide",400):"none"!=this.$("#analyse").css("display")&&0==this.$("#project .option.selected").length&&this.$("#analyse").hide("slide",400)},clickAnalyse:function(){var a=this.$("#project .option.selected .label").text(),b=new ArticleView({model:this.model.findWhere({title:a})});topTabs.getSelected().set({title:a,mainView:b,color:"#ABD1EB",hoverColor:"#9EC0D9"}),b.render(),topTabsView.render(),this.remove()},renderInitiatives:function(){this.$("#initiative").tabs()},renderProjects:function(){this.$("#project #tabs-project .select").empty(),this.model.each(function(a){this.$("#project #tabs-project .select").append("<div class='option'><span class='label'>"+a.get("title")+"</span><span class='count'>("+a.get("rev_count")+" edits)</span></div>")}),this.$("#project").tabs()},render:function(){return null!=topTabs.getSelected()&&topTabs.getSelected().get("mainView")==this?this.$el.css("display","block"):this.$el.css("display","none"),this.firstRender&&(this.$el.html(this.template(this.model.toJSON())),this.renderInitiatives(),this.renderProjects()),this.firstRender=!1,this.$el}}),TopTabsView=Backbone.View.extend({views:new Array,initialize:function(){this.listenTo(this.model,"add",this.render),this.listenTo(this.model,"remove",this.render)},order:function(){this.model.sort();var a=TopTabsView.leftMargin;this.model.each(function(b,c){b.set("x",a,{silent:!0}),a+=this.$("#tab_"+b.cid).outerWidth()+TopTabsView.spacing,this.views[c].render()},this)},render:function(){return _.each(this.views,function(a){a.remove()}),this.views=new Array,this.$el.empty(),this.model.each(function(a){var b=new TopTabView({model:a});this.$el.append(b.render()),"tab"==a.get("type")&&b.$el.draggable({axis:"x",start:$.proxy(function(){b.$el.css("z-index",1e3)},this),drag:$.proxy(function(){a.set("x",parseInt(b.$el.css("left"))),this.order()},this),stop:$.proxy(function(){b.$el.css("z-index",0),this.order(),this.render()},this)}),this.views.push(b)},this),this.order(),this.$el}}),TopTabsView.leftMargin=15,TopTabsView.spacing=5,TopTabView=Backbone.View.extend({template:_.template($("#top_tab_template").html()),initialize:function(){this.listenTo(this.model,"change",this.render)},events:{mouseover:"hover",mouseout:"unhover","click .x":"close",click:"click"},hover:function(){this.model.get("selected")&&this.$el.css("border-bottom","1px solid #FFFFFF"),this.$el.css("background-color",this.model.get("hoverColor"))},unhover:function(){this.model.get("selected")?this.$el.css("border-bottom","1px solid #FFFFFF"):this.$el.css("border-bottom","1px solid #AAAAAA"),this.$el.css("background-color",this.model.get("color"))},click:function(a){if("new"==this.model.get("type")){var b=new TopTab({title:"New Tab",mainView:new NewArticleView({model:articles})}),c=_.last(topTabsView.views).model.get("x");topTabs.add(b),topTabsView.order();var d=topTabs.getSelected();null!=d&&d!=this.model&&d.set("selected",!1),b.set("selected",!0),$("#tab_"+b.cid).css("display","none"),$("#tab_"+b.cid).show("slide",200),_.last(topTabsView.views).$el.css("left",c),_.last(topTabsView.views).$el.animate({left:b.get("x")+$("#tab_"+b.cid).outerWidth()+TopTabsView.spacing},200)}else if(!$(a.target).hasClass("x")){var d=topTabs.getSelected();null!=d&&d!=this.model&&d.set("selected",!1),this.model.get("selected")||this.model.set("selected",!0)}},close:function(){var a=!1;_.each(topTabsView.views,function(b){a&&b.$el.animate({left:b.model.get("x")-this.$el.outerWidth()-TopTabsView.spacing},200),b==this&&(a=!0)},this),this.model.set("selected",!1),this.model.get("mainView").remove(),this.$el.hide("slide",200,$.proxy(function(){topTabs.remove(this.model),topTabs.at(topTabs.length-2)&&topTabs.at(topTabs.length-2).set("selected",!0)},this))},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.addClass("tab"),this.$el.stop(),this.$el.css("left",this.model.get("x")),this.$el.attr("id","tab_"+this.model.cid),this.model.get("selected")?(this.$el.addClass("selected"),this.$el.css("border-bottom","1px solid #FFFFFF")):(this.$el.removeClass("selected"),this.$el.css("border-bottom","1px solid #AAAAAA")),this.$el.css("background-color",this.model.get("color")),this.$el}}),subview=function(a){return"<div data-subview='"+a+"'></div>"},String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})},Helper=function(){},Helper.formatDate=function(a){return["January","February","March","April","May","June","July","August","September","October","November","December"][a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()+"   "+("0"+a.getHours()).substr(-2,2)+":"+("0"+a.getMinutes()).substr(-2,2)},Helper.getDateSortKey=function(a){return String(a.getFullYear())+("0"+a.getMonth()).substr(-2,2)+("0"+a.getDate()).substr(-2,2)+("0"+a.getHours()).substr(-2,2)+("0"+a.getMinutes()).substr(-2,2)+("0"+a.getSeconds()).substr(-2,2)},Helper.isSubset=function(a,b){for(var c={},d=0;d<b.length;++d)c[b[d]]=!0;for(var d=0;d<a.length;++d)if(!c.hasOwnProperty(a[d]))return!1;return!0},Helper.toClassString=function(a){return a.split(";").map(function(a){return{a:"edit",b:"add",c:"remove",d:"reorganize",e:"cite",f:"vandalize",g:"unvandalize",x:"unclassified"}[a]}).join(", ")},Helper.toTalkClassString=function(a){var b="";return a.att&&(b+="attitude, "),a.crit&&(b+="criticism, "),a.inf&&(b+="informative, "),a.perf&&(b+="performative, "),b.substring(0,b.length-2)},Helper.absMax=function(a,b){if(!(a instanceof Array)||a.length<1)return d;for(var c=b(a[0]),e=1;e<a.length;++e)c=Math.max(c,Math.abs(b(a[e])));return c},$.ajaxSetup({cache:!1}),articles=new ArticleCollection,articles.fetch(),topTabs=new TopTabCollection,topTabsView=new TopTabsView({model:topTabs,el:"#topTabs"}),PageRouter=Backbone.Router.extend({routes:{test:"testRoute","*actions":"defaultRoute"},defaultRoute:function(){var a=new NewArticleView({model:articles});topTabsView.render(),topTabs.add(new TopTab({title:"New Tab",mainView:a,selected:!0})),topTabs.add(new NewTopTab)}}),pageRouter=new PageRouter,Backbone.history.start()}(window,document);